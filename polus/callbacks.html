<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 10.0.3"/>
    <title>polus.callbacks API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc section{margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:2.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../polus.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;polus</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="function" href="#runs_if_root">runs_if_root</a>
            </li>
            <li>
                    <a class="class" href="#IOutput">IOutput</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#IOutput.__init__">IOutput</a>
                        </li>
                        <li>
                                <a class="function" href="#IOutput.write">write</a>
                        </li>
                        <li>
                                <a class="function" href="#IOutput.flush">flush</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ICallback">ICallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ICallback.__init__">ICallback</a>
                        </li>
                        <li>
                                <a class="function" href="#ICallback.on_train_begin">on_train_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#ICallback.on_epoch_begin">on_epoch_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#ICallback.on_train_batch_begin">on_train_batch_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#ICallback.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#ICallback.on_epoch_end">on_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#ICallback.on_train_end">on_train_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CallbackCoordinator">CallbackCoordinator</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CallbackCoordinator.__init__">CallbackCoordinator</a>
                        </li>
                        <li>
                                <a class="function" href="#CallbackCoordinator.has_callback">has_callback</a>
                        </li>
                        <li>
                                <a class="function" href="#CallbackCoordinator.on_train_begin">on_train_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#CallbackCoordinator.on_epoch_begin">on_epoch_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#CallbackCoordinator.on_train_batch_begin">on_train_batch_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#CallbackCoordinator.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CallbackCoordinator.on_epoch_end">on_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#CallbackCoordinator.on_train_end">on_train_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Callback">Callback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Callback.__init__">Callback</a>
                        </li>
                        <li>
                                <a class="function" href="#Callback.add_coordinator">add_coordinator</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TimerCallback">TimerCallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TimerCallback.__init__">TimerCallback</a>
                        </li>
                        <li>
                                <a class="function" href="#TimerCallback.on_train_batch_begin">on_train_batch_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#TimerCallback.on_train_batch_end">on_train_batch_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LossSmoothCallback">LossSmoothCallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LossSmoothCallback.__init__">LossSmoothCallback</a>
                        </li>
                        <li>
                                <a class="function" href="#LossSmoothCallback.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#LossSmoothCallback.on_epoch_end">on_epoch_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ValidationDataCallback">ValidationDataCallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ValidationDataCallback.__init__">ValidationDataCallback</a>
                        </li>
                        <li>
                                <a class="function" href="#ValidationDataCallback.on_train_begin">on_train_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#ValidationDataCallback.get_metrics">get_metrics</a>
                        </li>
                        <li>
                                <a class="function" href="#ValidationDataCallback.on_epoch_end">on_epoch_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SaveModelCallback">SaveModelCallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SaveModelCallback.__init__">SaveModelCallback</a>
                        </li>
                        <li>
                                <a class="function" href="#SaveModelCallback.on_epoch_end">on_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#SaveModelCallback.on_train_end">on_train_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#EarlyStop">EarlyStop</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EarlyStop.__init__">EarlyStop</a>
                        </li>
                        <li>
                                <a class="function" href="#EarlyStop.on_train_begin">on_train_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#EarlyStop.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#EarlyStop.on_epoch_end">on_epoch_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#HPOPruneCallback">HPOPruneCallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#HPOPruneCallback.__init__">HPOPruneCallback</a>
                        </li>
                        <li>
                                <a class="function" href="#HPOPruneCallback.on_epoch_end">on_epoch_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#WandBLogCallback">WandBLogCallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#WandBLogCallback.__init__">WandBLogCallback</a>
                        </li>
                        <li>
                                <a class="function" href="#WandBLogCallback.on_train_begin">on_train_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#WandBLogCallback.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#WandBLogCallback.on_epoch_end">on_epoch_end</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ConsoleLogCallback">ConsoleLogCallback</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ConsoleLogCallback.__init__">ConsoleLogCallback</a>
                        </li>
                        <li>
                                <a class="function" href="#ConsoleLogCallback.on_train_begin">on_train_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#ConsoleLogCallback.on_epoch_begin">on_epoch_begin</a>
                        </li>
                        <li>
                                <a class="function" href="#ConsoleLogCallback.on_train_batch_end">on_train_batch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#ConsoleLogCallback.on_epoch_end">on_epoch_end</a>
                        </li>
                        <li>
                                <a class="function" href="#ConsoleLogCallback.on_train_end">on_train_end</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../polus.html">polus</a><wbr>.callbacks    </h1>

                
                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">polus.core</span> <span class="kn">import</span> <span class="n">BaseLogger</span><span class="p">,</span> <span class="n">get_jit_compile</span>
<span class="kn">from</span> <span class="nn">polus.models</span> <span class="kn">import</span> <span class="n">PolusClassifier</span>
<span class="kn">from</span> <span class="nn">polus.hpo</span> <span class="kn">import</span> <span class="n">HPOContext</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">horovod.tensorflow</span> <span class="k">as</span> <span class="nn">hvd</span>
<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">polus.mock.horovod</span> <span class="k">as</span> <span class="nn">hvd</span>

<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">wandb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">runs_if_root</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">method_args</span><span class="p">,</span> <span class="o">**</span><span class="n">method_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">method_args</span><span class="p">,</span> <span class="o">**</span><span class="n">method_kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_impl</span>

<span class="k">class</span> <span class="nc">IOutput</span><span class="p">(</span><span class="n">BaseLogger</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;IOutputStream&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_tmp</span>

<span class="k">class</span> <span class="nc">ICallback</span><span class="p">(</span><span class="n">BaseLogger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interface</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;ICallback&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    
    
<span class="k">class</span> <span class="nc">CallbackCoordinator</span><span class="p">(</span><span class="n">ICallback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">callbacks</span><span class="p">,</span> 
                 <span class="n">trainer</span><span class="p">,</span> 
                 <span class="n">epochs</span><span class="p">,</span>
                 <span class="n">steps</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">trainer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span>
        
        <span class="c1"># This dict is shared across all the callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_dict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">)</span><span class="si">}</span><span class="s2"> callbacks were registered to be used&quot;</span><span class="p">)</span>
        
        <span class="c1"># store the callbacks that are outputStream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_streamers</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="c1"># add cordinator to the callbacks</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IOutput</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_streamers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        
    
    <span class="k">def</span> <span class="nf">has_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_class</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">callback_class</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_begin</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_epoch_begin</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_batch_begin</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_batch_end</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_end</span><span class="p">()</span>
        
<span class="k">class</span> <span class="nc">Callback</span><span class="p">(</span><span class="n">ICallback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># it is undifined when instantiated</span>
        
    <span class="k">def</span> <span class="nf">add_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="n">coordinator</span>

<span class="k">class</span> <span class="nc">TimerCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This callback only measures the time elapsed between the begin and end of a batch.</span>
<span class="sd">    Then the resulting measure is writed in all the OutputStreamers presented in the coordinator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">output_streamers</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">timer</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LossSmoothCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a smooth factor to the loss</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.97</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">__maybe_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">output_streamers</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;smooth loss&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;smooth_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__maybe_output</span><span class="p">()</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__maybe_output</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ValidationDataCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">tf_validation</span><span class="p">,</span> 
                 <span class="n">custom_inference_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">validation_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_validation</span> <span class="o">=</span> <span class="n">tf_validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_inference_f</span> <span class="o">=</span> <span class="n">custom_inference_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span> <span class="o">=</span> <span class="n">validation_interval</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;validation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">metrics</span> <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">epoch</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span><span class="p">:</span>
            <span class="c1"># only do validation at X interval</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running validation for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> set&quot;</span><span class="p">)</span>
            <span class="c1"># make inference</span>
            <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_validation</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_inference_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_inference_f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">PolusClassifier</span><span class="p">):</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We default to just run the model over the validation data, since the models does not extend PolusClassifier neither a custom_inference_f was provided. This may result in erros down the line.&quot;</span><span class="p">)</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample format outputed by the validator dataset is not supported, change to a dict or a two length tuple&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">sample</span>
                
                <span class="c1">## down below only the root should the reminder of the code</span>
                <span class="c1">## THIS METHOD IS NOT EFFICIENT A MUCH MORE EFFECIENT GATHER_TO_ROOT method would be better</span>
                <span class="n">all_predictions</span> <span class="o">=</span> <span class="n">hvd</span><span class="o">.</span><span class="n">allgather_object</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">all_predictions</span><span class="p">:</span>
                
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                            <span class="n">metric</span><span class="o">.</span><span class="n">samples_from_batch</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                            
            <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">evaluate</span><span class="p">())</span>

                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">output_streamers</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
            
            
<span class="k">class</span> <span class="nc">SaveModelCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">strategy</span><span class="p">,</span> 
                 <span class="n">validation_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">metric_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">cache_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">selection_dict_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span> <span class="o">=</span> <span class="n">validation_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="o">=</span> <span class="n">cache_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection_dict_key</span> <span class="o">=</span> <span class="n">selection_dict_key</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;every&quot;</span><span class="p">,</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The selected strategy (</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">) is not supported, so this callback will be ignored&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span><span class="p">:</span>
            <span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_last</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_dict_key</span><span class="p">(</span><span class="n">_last</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_metric</span> <span class="o">=</span> <span class="n">_last</span>
            
            <span class="k">if</span> <span class="n">_metric</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best</span> <span class="o">=</span> <span class="n">_metric</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best&quot;</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
                    
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;every&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EarlyStop</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">patience</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                 <span class="n">use_smooth_loss</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_patience</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_loss</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span> <span class="o">=</span> <span class="n">use_smooth_loss</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">has_callback</span><span class="p">(</span><span class="n">LossSmoothCallback</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;LossSmoothCallback was not found on the coordinator, which is a requirement to use smooth loss. Therefore this call back will use the normal loss&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;smooth_loss&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># loss per epoch</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loss</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training will stop early since the loss became nan&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">HPOContext</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_hpo_enable</span><span class="p">():</span>
                <span class="kn">from</span> <span class="nn">optuna.exceptions</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
                <span class="kn">from</span> <span class="nn">optuna.trial</span> <span class="kn">import</span> <span class="n">Trial</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">hpo_backend</span><span class="p">,</span> <span class="n">Trial</span><span class="p">):</span> <span class="c1"># optuna has backend</span>
                    <span class="k">raise</span> <span class="n">TrialPruned</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The loss was nan, but early stop does not know how to end the run with the </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">hpo_backend</span><span class="si">}</span><span class="s2"> backend&quot;</span><span class="p">)</span>
            
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_loss</span> <span class="o">&lt;</span> <span class="n">loss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_patience</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_patience</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training will stop early since the loss did not improve in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="si">}</span><span class="s2"> consecutive epochs&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HPOPruneCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insperied from https://optuna.readthedocs.io/en/stable/_modules/optuna/integration/tfkeras.html#TFKerasPruningCallback</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator_name</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        
        
        <span class="c1"># this can be none, if nono this callback does do anything</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span> <span class="o">=</span> <span class="n">HPOContext</span><span class="p">()</span><span class="o">.</span><span class="n">hpo_backend</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HPOPruneCallback was initialized however, there is no hpo context at the moment&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">validator_name</span> <span class="o">=</span> <span class="n">validator_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="n">current_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">validator_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="kn">from</span> <span class="nn">optuna.exceptions</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
            <span class="kn">from</span> <span class="nn">optuna.trial</span> <span class="kn">import</span> <span class="n">Trial</span><span class="p">,</span> <span class="n">FrozenTrial</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="p">,</span> <span class="n">Trial</span><span class="p">):</span> <span class="c1"># optuna has backend</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">current_score</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
                    <span class="kn">from</span> <span class="nn">optuna.exceptions</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Trial was pruned at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> with a score of </span><span class="si">{</span><span class="n">current_score</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="k">raise</span> <span class="n">TrialPruned</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="p">,</span> <span class="n">FrozenTrial</span><span class="p">):</span>
                <span class="c1">## skip the call back</span>
                <span class="c1">## this means that the callback shoulden&#39;t be added in the first place</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="si">}</span><span class="s2"> backend is not supported so we do not know how to prune&quot;</span><span class="p">)</span>
        
            
<span class="k">class</span> <span class="nc">WandBLogCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">,</span> <span class="n">IOutput</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">init_args</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_name_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_args</span> <span class="o">=</span> <span class="n">init_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span> <span class="o">=</span> <span class="n">additional_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name_prefix</span> <span class="o">=</span> <span class="n">model_name_prefix</span>

    <span class="k">def</span> <span class="nf">__flatdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">_temp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_out</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_out</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">_temp</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                     <span class="n">_temp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_out</span>
            <span class="k">return</span> <span class="n">_temp</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;savable_config&quot;</span><span class="p">):</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">savable_config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training will log information to WandB, however, the callback was unable to find the model configuration, you should explicitly set the model configuration or use @savable_model decorator&quot;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">=</span><span class="n">model_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                       <span class="n">entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">=</span><span class="n">model_config</span><span class="p">)</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_args</span><span class="p">)</span> 
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span><span class="p">)</span> 
        
        <span class="c1"># add optimizer and loss</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">GenericFunction</span><span class="p">):</span>
            <span class="n">_loss</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="n">_loss</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>   
        
        <span class="n">_optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">_optimizer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        
        <span class="n">other_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">_loss</span><span class="p">,</span>
                      <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">_optimizer</span><span class="p">}</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other_data</span><span class="p">)</span> 
        
        <span class="c1"># set the model name to the name generated by the wandb callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="c1">#f&quot;{self.model_name_prefix}_{wandb.run.name}&quot;)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        
        <span class="c1"># store other metrics that other callback have produced</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="c1"># store other metrics that other callback have produced</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
<span class="k">class</span> <span class="nc">ConsoleLogCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">,</span> <span class="n">IOutput</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_on_train_step</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_on_train_step</span> <span class="o">=</span> <span class="n">log_on_train_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__dict2srt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; - &quot;</span><span class="p">):</span>
        <span class="c1"># Maybe redo this code, to be more automatic, assume a dict is open and a list prints the last element</span>
        <span class="n">_tmp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1">#for k,v in d.items():</span>
                <span class="c1">## recursion</span>
            <span class="n">_temp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)):</span>
                    <span class="n">_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">_out</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="n">_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">_out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">_tmp</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_temp</span><span class="p">)</span>

            <span class="c1">#_tmp += f&quot; - {k}: [{list_str}]&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">_tmp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;, &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">_tmp</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
                
        <span class="k">return</span> <span class="n">_tmp</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Begin training of the model </span><span class="se">\&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> epochs&quot;</span><span class="p">)</span>
        <span class="n">jit_compiler_flag</span> <span class="o">=</span> <span class="n">get_jit_compile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training step will be build with jit_compiler=</span><span class="si">{</span><span class="n">jit_compiler_flag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Begin epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        
        <span class="n">_tmp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">steps</span><span class="si">}</span><span class="s2"> - loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - &quot;</span>
        
        <span class="c1"># Maybe redo this code, to be more automatic, assume a dict is open and a list prints the last element</span>
        <span class="n">_tmp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_on_train_step</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">_tmp</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>

        <span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">_len</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span><span class="o">/</span><span class="n">_len</span>
        
        <span class="n">_tmp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Average loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - &quot;</span>

        <span class="c1"># print the reminder of the messages that other callbacks may have set  </span>
        <span class="n">_tmp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;End of the training&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            </section>
                <section id="runs_if_root">
                            <div class="attr function"><a class="headerlink" href="#runs_if_root">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">runs_if_root</span><span class="signature">(method)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">runs_if_root</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">method_args</span><span class="p">,</span> <span class="o">**</span><span class="n">method_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">method_args</span><span class="p">,</span> <span class="o">**</span><span class="n">method_kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_impl</span>
</pre></div>

        </details>

    

                </section>
                <section id="IOutput">
                                <div class="attr class">
        <a class="headerlink" href="#IOutput">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">IOutput</span><wbr>(<span class="base"><a href="core.html#BaseLogger">polus.core.BaseLogger</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">IOutput</span><span class="p">(</span><span class="n">BaseLogger</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;IOutputStream&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_tmp</span>
</pre></div>

        </details>

    

                            <div id="IOutput.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#IOutput.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">IOutput</span><span class="signature">()</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;IOutputStream&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="IOutput.write" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#IOutput.write">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">write</span><span class="signature">(self, key, value)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="IOutput.flush" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#IOutput.flush">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">flush</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">_tmp</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="IOutput.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ICallback">
                                <div class="attr class">
        <a class="headerlink" href="#ICallback">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ICallback</span><wbr>(<span class="base"><a href="core.html#BaseLogger">polus.core.BaseLogger</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ICallback</span><span class="p">(</span><span class="n">BaseLogger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interface</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;ICallback&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">pass</span>
    
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

        </details>

            <div class="docstring"><p>Interface</p>
</div>


                            <div id="ICallback.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ICallback.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ICallback</span><span class="signature">()</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;ICallback&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="ICallback.on_train_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ICallback.on_train_begin">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_begin</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ICallback.on_epoch_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ICallback.on_epoch_begin">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_epoch_begin</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ICallback.on_train_batch_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ICallback.on_train_batch_begin">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_batch_begin</span><span class="signature">(self, epoch, step)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ICallback.on_train_batch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ICallback.on_train_batch_end">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_batch_end</span><span class="signature">(self, epoch, step, loss)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ICallback.on_epoch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ICallback.on_epoch_end">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_epoch_end</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ICallback.on_train_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ICallback.on_train_end">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_end</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="ICallback.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="CallbackCoordinator">
                                <div class="attr class">
        <a class="headerlink" href="#CallbackCoordinator">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">CallbackCoordinator</span><wbr>(<span class="base"><a href="#ICallback">ICallback</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CallbackCoordinator</span><span class="p">(</span><span class="n">ICallback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">callbacks</span><span class="p">,</span> 
                 <span class="n">trainer</span><span class="p">,</span> 
                 <span class="n">epochs</span><span class="p">,</span>
                 <span class="n">steps</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">trainer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span>
        
        <span class="c1"># This dict is shared across all the callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_dict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">)</span><span class="si">}</span><span class="s2"> callbacks were registered to be used&quot;</span><span class="p">)</span>
        
        <span class="c1"># store the callbacks that are outputStream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_streamers</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="c1"># add cordinator to the callbacks</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IOutput</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_streamers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        
    
    <span class="k">def</span> <span class="nf">has_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_class</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">callback_class</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
    
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_begin</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_epoch_begin</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_batch_begin</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_batch_end</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_end</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Interface</p>
</div>


                            <div id="CallbackCoordinator.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CallbackCoordinator.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">CallbackCoordinator</span><span class="signature">(callbacks, trainer, epochs, steps)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">callbacks</span><span class="p">,</span> 
                 <span class="n">trainer</span><span class="p">,</span> 
                 <span class="n">epochs</span><span class="p">,</span>
                 <span class="n">steps</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="n">trainer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span>
        
        <span class="c1"># This dict is shared across all the callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_dict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">)</span><span class="si">}</span><span class="s2"> callbacks were registered to be used&quot;</span><span class="p">)</span>
        
        <span class="c1"># store the callbacks that are outputStream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_streamers</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="c1"># add cordinator to the callbacks</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">IOutput</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_streamers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="CallbackCoordinator.has_callback" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CallbackCoordinator.has_callback">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">has_callback</span><span class="signature">(self, callback_class)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">has_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback_class</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">callback_class</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CallbackCoordinator.on_train_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CallbackCoordinator.on_train_begin">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_begin</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_begin</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CallbackCoordinator.on_epoch_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CallbackCoordinator.on_epoch_begin">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_epoch_begin</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_epoch_begin</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CallbackCoordinator.on_train_batch_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CallbackCoordinator.on_train_batch_begin">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_batch_begin</span><span class="signature">(self, epoch, step)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_batch_begin</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CallbackCoordinator.on_train_batch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CallbackCoordinator.on_train_batch_end">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_batch_end</span><span class="signature">(self, epoch, step, loss)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_batch_end</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CallbackCoordinator.on_epoch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CallbackCoordinator.on_epoch_end">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_epoch_end</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CallbackCoordinator.on_train_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CallbackCoordinator.on_train_end">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_end</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">on_train_end</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="CallbackCoordinator.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Callback">
                                <div class="attr class">
        <a class="headerlink" href="#Callback">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Callback</span><wbr>(<span class="base"><a href="#ICallback">ICallback</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Callback</span><span class="p">(</span><span class="n">ICallback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># it is undifined when instantiated</span>
        
    <span class="k">def</span> <span class="nf">add_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="n">coordinator</span>
</pre></div>

        </details>

            <div class="docstring"><p>Interface</p>
</div>


                            <div id="Callback.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Callback.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Callback</span><span class="signature">()</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># it is undifined when instantiated</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="Callback.add_coordinator" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Callback.add_coordinator">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">add_coordinator</span><span class="signature">(self, coordinator)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">add_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinator</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="n">coordinator</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#ICallback">ICallback</a></dt>
                                <dd id="Callback.on_train_begin" class="function"><a href="#ICallback.on_train_begin">on_train_begin</a></dd>
                <dd id="Callback.on_epoch_begin" class="function"><a href="#ICallback.on_epoch_begin">on_epoch_begin</a></dd>
                <dd id="Callback.on_train_batch_begin" class="function"><a href="#ICallback.on_train_batch_begin">on_train_batch_begin</a></dd>
                <dd id="Callback.on_train_batch_end" class="function"><a href="#ICallback.on_train_batch_end">on_train_batch_end</a></dd>
                <dd id="Callback.on_epoch_end" class="function"><a href="#ICallback.on_epoch_end">on_epoch_end</a></dd>
                <dd id="Callback.on_train_end" class="function"><a href="#ICallback.on_train_end">on_train_end</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="Callback.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="TimerCallback">
                                <div class="attr class">
        <a class="headerlink" href="#TimerCallback">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">TimerCallback</span><wbr>(<span class="base"><a href="#Callback">Callback</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">TimerCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This callback only measures the time elapsed between the begin and end of a batch.</span>
<span class="sd">    Then the resulting measure is writed in all the OutputStreamers presented in the coordinator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">output_streamers</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">timer</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This callback only measures the time elapsed between the begin and end of a batch.
Then the resulting measure is writed in all the OutputStreamers presented in the coordinator.</p>
</div>


                            <div id="TimerCallback.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#TimerCallback.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">TimerCallback</span><span class="signature">()</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="TimerCallback.on_train_batch_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#TimerCallback.on_train_batch_begin">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_batch_begin</span><span class="signature">(self, epoch, step)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_batch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="TimerCallback.on_train_batch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#TimerCallback.on_train_batch_end">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_train_batch_end</span><span class="signature">(self, epoch, step, loss)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">output_streamers</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">timer</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Callback">Callback</a></dt>
                                <dd id="TimerCallback.add_coordinator" class="function"><a href="#Callback.add_coordinator">add_coordinator</a></dd>

            </div>
            <div><dt><a href="#ICallback">ICallback</a></dt>
                                <dd id="TimerCallback.on_train_begin" class="function"><a href="#ICallback.on_train_begin">on_train_begin</a></dd>
                <dd id="TimerCallback.on_epoch_begin" class="function"><a href="#ICallback.on_epoch_begin">on_epoch_begin</a></dd>
                <dd id="TimerCallback.on_epoch_end" class="function"><a href="#ICallback.on_epoch_end">on_epoch_end</a></dd>
                <dd id="TimerCallback.on_train_end" class="function"><a href="#ICallback.on_train_end">on_train_end</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="TimerCallback.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="LossSmoothCallback">
                                <div class="attr class">
        <a class="headerlink" href="#LossSmoothCallback">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">LossSmoothCallback</span><wbr>(<span class="base"><a href="#Callback">Callback</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">LossSmoothCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a smooth factor to the loss</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.97</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
    
    <span class="k">def</span> <span class="nf">__maybe_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">output_streamers</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;smooth loss&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;smooth_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__maybe_output</span><span class="p">()</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__maybe_output</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Applies a smooth factor to the loss</p>
</div>


                            <div id="LossSmoothCallback.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#LossSmoothCallback.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">LossSmoothCallback</span><span class="signature">(beta=0.97, output=False)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.97</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="LossSmoothCallback.on_train_batch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#LossSmoothCallback.on_train_batch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_batch_end</span><span class="signature">(self, epoch, step, loss)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">loss</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mov_avg</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;smooth_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_loss</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__maybe_output</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="LossSmoothCallback.on_epoch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#LossSmoothCallback.on_epoch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_epoch_end</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__maybe_output</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Callback">Callback</a></dt>
                                <dd id="LossSmoothCallback.add_coordinator" class="function"><a href="#Callback.add_coordinator">add_coordinator</a></dd>

            </div>
            <div><dt><a href="#ICallback">ICallback</a></dt>
                                <dd id="LossSmoothCallback.on_train_begin" class="function"><a href="#ICallback.on_train_begin">on_train_begin</a></dd>
                <dd id="LossSmoothCallback.on_epoch_begin" class="function"><a href="#ICallback.on_epoch_begin">on_epoch_begin</a></dd>
                <dd id="LossSmoothCallback.on_train_batch_begin" class="function"><a href="#ICallback.on_train_batch_begin">on_train_batch_begin</a></dd>
                <dd id="LossSmoothCallback.on_train_end" class="function"><a href="#ICallback.on_train_end">on_train_end</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="LossSmoothCallback.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ValidationDataCallback">
                                <div class="attr class">
        <a class="headerlink" href="#ValidationDataCallback">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ValidationDataCallback</span><wbr>(<span class="base"><a href="#Callback">Callback</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ValidationDataCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">tf_validation</span><span class="p">,</span> 
                 <span class="n">custom_inference_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">validation_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_validation</span> <span class="o">=</span> <span class="n">tf_validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_inference_f</span> <span class="o">=</span> <span class="n">custom_inference_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span> <span class="o">=</span> <span class="n">validation_interval</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;validation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">metrics</span> <span class="p">}</span>
    
    <span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">epoch</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span><span class="p">:</span>
            <span class="c1"># only do validation at X interval</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running validation for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> set&quot;</span><span class="p">)</span>
            <span class="c1"># make inference</span>
            <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_validation</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_inference_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_inference_f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">PolusClassifier</span><span class="p">):</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We default to just run the model over the validation data, since the models does not extend PolusClassifier neither a custom_inference_f was provided. This may result in erros down the line.&quot;</span><span class="p">)</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample format outputed by the validator dataset is not supported, change to a dict or a two length tuple&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">sample</span>
                
                <span class="c1">## down below only the root should the reminder of the code</span>
                <span class="c1">## THIS METHOD IS NOT EFFICIENT A MUCH MORE EFFECIENT GATHER_TO_ROOT method would be better</span>
                <span class="n">all_predictions</span> <span class="o">=</span> <span class="n">hvd</span><span class="o">.</span><span class="n">allgather_object</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">all_predictions</span><span class="p">:</span>
                
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                            <span class="n">metric</span><span class="o">.</span><span class="n">samples_from_batch</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                            
            <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">evaluate</span><span class="p">())</span>

                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">output_streamers</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</pre></div>

        </details>

            <div class="docstring"><p>Interface</p>
</div>


                            <div id="ValidationDataCallback.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ValidationDataCallback.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ValidationDataCallback</span><span class="signature">(
    tf_validation,
    custom_inference_f=None,
    name=None,
    show_progress=False,
    validation_interval=1
)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">tf_validation</span><span class="p">,</span> 
                 <span class="n">custom_inference_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">validation_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_validation</span> <span class="o">=</span> <span class="n">tf_validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_inference_f</span> <span class="o">=</span> <span class="n">custom_inference_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span> <span class="o">=</span> <span class="n">validation_interval</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="ValidationDataCallback.on_train_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ValidationDataCallback.on_train_begin">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_begin</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;validation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">metrics</span> <span class="p">}</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ValidationDataCallback.get_metrics" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ValidationDataCallback.get_metrics">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_metrics</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ValidationDataCallback.on_epoch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ValidationDataCallback.on_epoch_end">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_epoch_end</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">epoch</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_interval</span><span class="p">:</span>
            <span class="c1"># only do validation at X interval</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running validation for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> set&quot;</span><span class="p">)</span>
            <span class="c1"># make inference</span>
            <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_validation</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_inference_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_inference_f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">PolusClassifier</span><span class="p">):</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We default to just run the model over the validation data, since the models does not extend PolusClassifier neither a custom_inference_f was provided. This may result in erros down the line.&quot;</span><span class="p">)</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample format outputed by the validator dataset is not supported, change to a dict or a two length tuple&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">sample</span>
                
                <span class="c1">## down below only the root should the reminder of the code</span>
                <span class="c1">## THIS METHOD IS NOT EFFICIENT A MUCH MORE EFFECIENT GATHER_TO_ROOT method would be better</span>
                <span class="n">all_predictions</span> <span class="o">=</span> <span class="n">hvd</span><span class="o">.</span><span class="n">allgather_object</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">all_predictions</span><span class="p">:</span>
                
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                            <span class="n">metric</span><span class="o">.</span><span class="n">samples_from_batch</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                            
            <span class="k">if</span> <span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">evaluate</span><span class="p">())</span>

                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">output_streamers</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Callback">Callback</a></dt>
                                <dd id="ValidationDataCallback.add_coordinator" class="function"><a href="#Callback.add_coordinator">add_coordinator</a></dd>

            </div>
            <div><dt><a href="#ICallback">ICallback</a></dt>
                                <dd id="ValidationDataCallback.on_epoch_begin" class="function"><a href="#ICallback.on_epoch_begin">on_epoch_begin</a></dd>
                <dd id="ValidationDataCallback.on_train_batch_begin" class="function"><a href="#ICallback.on_train_batch_begin">on_train_batch_begin</a></dd>
                <dd id="ValidationDataCallback.on_train_batch_end" class="function"><a href="#ICallback.on_train_batch_end">on_train_batch_end</a></dd>
                <dd id="ValidationDataCallback.on_train_end" class="function"><a href="#ICallback.on_train_end">on_train_end</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="ValidationDataCallback.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SaveModelCallback">
                                <div class="attr class">
        <a class="headerlink" href="#SaveModelCallback">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SaveModelCallback</span><wbr>(<span class="base"><a href="#Callback">Callback</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SaveModelCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">strategy</span><span class="p">,</span> 
                 <span class="n">validation_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">metric_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">cache_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">selection_dict_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span> <span class="o">=</span> <span class="n">validation_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="o">=</span> <span class="n">cache_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection_dict_key</span> <span class="o">=</span> <span class="n">selection_dict_key</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;every&quot;</span><span class="p">,</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The selected strategy (</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">) is not supported, so this callback will be ignored&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span><span class="p">:</span>
            <span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_last</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_dict_key</span><span class="p">(</span><span class="n">_last</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_metric</span> <span class="o">=</span> <span class="n">_last</span>
            
            <span class="k">if</span> <span class="n">_metric</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best</span> <span class="o">=</span> <span class="n">_metric</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best&quot;</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
                    
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;every&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Interface</p>
</div>


                            <div id="SaveModelCallback.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SaveModelCallback.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">SaveModelCallback</span><span class="signature">(
    strategy,
    validation_name=None,
    metric_name=None,
    cache_folder=None,
    selection_dict_key=None
)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">strategy</span><span class="p">,</span> 
                 <span class="n">validation_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">metric_name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">cache_folder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">selection_dict_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span> <span class="o">=</span> <span class="n">validation_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="o">=</span> <span class="n">cache_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection_dict_key</span> <span class="o">=</span> <span class="n">selection_dict_key</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;every&quot;</span><span class="p">,</span> <span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The selected strategy (</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">) is not supported, so this callback will be ignored&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="SaveModelCallback.on_epoch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SaveModelCallback.on_epoch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_epoch_end</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;best&quot;</span><span class="p">:</span>
            <span class="n">_last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_last</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_dict_key</span><span class="p">(</span><span class="n">_last</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_metric</span> <span class="o">=</span> <span class="n">_last</span>
            
            <span class="k">if</span> <span class="n">_metric</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">best</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">best</span> <span class="o">=</span> <span class="n">_metric</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">_best&quot;</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
                    
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;every&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_epoch_</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="SaveModelCallback.on_train_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SaveModelCallback.on_train_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_end</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">base_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Callback">Callback</a></dt>
                                <dd id="SaveModelCallback.add_coordinator" class="function"><a href="#Callback.add_coordinator">add_coordinator</a></dd>

            </div>
            <div><dt><a href="#ICallback">ICallback</a></dt>
                                <dd id="SaveModelCallback.on_train_begin" class="function"><a href="#ICallback.on_train_begin">on_train_begin</a></dd>
                <dd id="SaveModelCallback.on_epoch_begin" class="function"><a href="#ICallback.on_epoch_begin">on_epoch_begin</a></dd>
                <dd id="SaveModelCallback.on_train_batch_begin" class="function"><a href="#ICallback.on_train_batch_begin">on_train_batch_begin</a></dd>
                <dd id="SaveModelCallback.on_train_batch_end" class="function"><a href="#ICallback.on_train_batch_end">on_train_batch_end</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="SaveModelCallback.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="EarlyStop">
                                <div class="attr class">
        <a class="headerlink" href="#EarlyStop">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">EarlyStop</span><wbr>(<span class="base"><a href="#Callback">Callback</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">EarlyStop</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">patience</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                 <span class="n">use_smooth_loss</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_patience</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_loss</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span> <span class="o">=</span> <span class="n">use_smooth_loss</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">has_callback</span><span class="p">(</span><span class="n">LossSmoothCallback</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;LossSmoothCallback was not found on the coordinator, which is a requirement to use smooth loss. Therefore this call back will use the normal loss&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;smooth_loss&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># loss per epoch</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loss</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training will stop early since the loss became nan&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">HPOContext</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_hpo_enable</span><span class="p">():</span>
                <span class="kn">from</span> <span class="nn">optuna.exceptions</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
                <span class="kn">from</span> <span class="nn">optuna.trial</span> <span class="kn">import</span> <span class="n">Trial</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">hpo_backend</span><span class="p">,</span> <span class="n">Trial</span><span class="p">):</span> <span class="c1"># optuna has backend</span>
                    <span class="k">raise</span> <span class="n">TrialPruned</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The loss was nan, but early stop does not know how to end the run with the </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">hpo_backend</span><span class="si">}</span><span class="s2"> backend&quot;</span><span class="p">)</span>
            
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_loss</span> <span class="o">&lt;</span> <span class="n">loss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_patience</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_patience</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training will stop early since the loss did not improve in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="si">}</span><span class="s2"> consecutive epochs&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Interface</p>
</div>


                            <div id="EarlyStop.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#EarlyStop.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">EarlyStop</span><span class="signature">(patience=3, use_smooth_loss=True)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">patience</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> 
                 <span class="n">use_smooth_loss</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_patience</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_loss</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span> <span class="o">=</span> <span class="n">use_smooth_loss</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="EarlyStop.on_train_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#EarlyStop.on_train_begin">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_begin</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">has_callback</span><span class="p">(</span><span class="n">LossSmoothCallback</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;LossSmoothCallback was not found on the coordinator, which is a requirement to use smooth loss. Therefore this call back will use the normal loss&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="EarlyStop.on_train_batch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#EarlyStop.on_train_batch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_batch_end</span><span class="signature">(self, epoch, step, loss)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="EarlyStop.on_epoch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#EarlyStop.on_epoch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_epoch_end</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_smooth_loss</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;smooth_loss&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># loss per epoch</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">loss</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training will stop early since the loss became nan&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">HPOContext</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_hpo_enable</span><span class="p">():</span>
                <span class="kn">from</span> <span class="nn">optuna.exceptions</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
                <span class="kn">from</span> <span class="nn">optuna.trial</span> <span class="kn">import</span> <span class="n">Trial</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">hpo_backend</span><span class="p">,</span> <span class="n">Trial</span><span class="p">):</span> <span class="c1"># optuna has backend</span>
                    <span class="k">raise</span> <span class="n">TrialPruned</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The loss was nan, but early stop does not know how to end the run with the </span><span class="si">{</span><span class="n">ctx</span><span class="o">.</span><span class="n">hpo_backend</span><span class="si">}</span><span class="s2"> backend&quot;</span><span class="p">)</span>
            
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_loss</span> <span class="o">&lt;</span> <span class="n">loss</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_patience</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_patience</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">early_stop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training will stop early since the loss did not improve in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">patience</span><span class="si">}</span><span class="s2"> consecutive epochs&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Callback">Callback</a></dt>
                                <dd id="EarlyStop.add_coordinator" class="function"><a href="#Callback.add_coordinator">add_coordinator</a></dd>

            </div>
            <div><dt><a href="#ICallback">ICallback</a></dt>
                                <dd id="EarlyStop.on_epoch_begin" class="function"><a href="#ICallback.on_epoch_begin">on_epoch_begin</a></dd>
                <dd id="EarlyStop.on_train_batch_begin" class="function"><a href="#ICallback.on_train_batch_begin">on_train_batch_begin</a></dd>
                <dd id="EarlyStop.on_train_end" class="function"><a href="#ICallback.on_train_end">on_train_end</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="EarlyStop.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="HPOPruneCallback">
                                <div class="attr class">
        <a class="headerlink" href="#HPOPruneCallback">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">HPOPruneCallback</span><wbr>(<span class="base"><a href="#Callback">Callback</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">HPOPruneCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insperied from https://optuna.readthedocs.io/en/stable/_modules/optuna/integration/tfkeras.html#TFKerasPruningCallback</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator_name</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        
        
        <span class="c1"># this can be none, if nono this callback does do anything</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span> <span class="o">=</span> <span class="n">HPOContext</span><span class="p">()</span><span class="o">.</span><span class="n">hpo_backend</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HPOPruneCallback was initialized however, there is no hpo context at the moment&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">validator_name</span> <span class="o">=</span> <span class="n">validator_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="n">current_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">validator_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="kn">from</span> <span class="nn">optuna.exceptions</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
            <span class="kn">from</span> <span class="nn">optuna.trial</span> <span class="kn">import</span> <span class="n">Trial</span><span class="p">,</span> <span class="n">FrozenTrial</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="p">,</span> <span class="n">Trial</span><span class="p">):</span> <span class="c1"># optuna has backend</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">current_score</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
                    <span class="kn">from</span> <span class="nn">optuna.exceptions</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Trial was pruned at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> with a score of </span><span class="si">{</span><span class="n">current_score</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="k">raise</span> <span class="n">TrialPruned</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="p">,</span> <span class="n">FrozenTrial</span><span class="p">):</span>
                <span class="c1">## skip the call back</span>
                <span class="c1">## this means that the callback shoulden&#39;t be added in the first place</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="si">}</span><span class="s2"> backend is not supported so we do not know how to prune&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Insperied from https://optuna.readthedocs.io/en/stable/_modules/optuna/integration/tfkeras.html#TFKerasPruningCallback</p>
</div>


                            <div id="HPOPruneCallback.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#HPOPruneCallback.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">HPOPruneCallback</span><span class="signature">(validator_name, metric_name)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validator_name</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        
        
        <span class="c1"># this can be none, if nono this callback does do anything</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span> <span class="o">=</span> <span class="n">HPOContext</span><span class="p">()</span><span class="o">.</span><span class="n">hpo_backend</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HPOPruneCallback was initialized however, there is no hpo context at the moment&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">validator_name</span> <span class="o">=</span> <span class="n">validator_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span> <span class="o">=</span> <span class="n">metric_name</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="HPOPruneCallback.on_epoch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#HPOPruneCallback.on_epoch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_epoch_end</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="n">current_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">shared_dict</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">validator_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">metric_name</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="kn">from</span> <span class="nn">optuna.exceptions</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
            <span class="kn">from</span> <span class="nn">optuna.trial</span> <span class="kn">import</span> <span class="n">Trial</span><span class="p">,</span> <span class="n">FrozenTrial</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="p">,</span> <span class="n">Trial</span><span class="p">):</span> <span class="c1"># optuna has backend</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">current_score</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">epoch</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="o">.</span><span class="n">should_prune</span><span class="p">():</span>
                    <span class="kn">from</span> <span class="nn">optuna.exceptions</span> <span class="kn">import</span> <span class="n">TrialPruned</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Trial was pruned at epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2"> with a score of </span><span class="si">{</span><span class="n">current_score</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="k">raise</span> <span class="n">TrialPruned</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="p">,</span> <span class="n">FrozenTrial</span><span class="p">):</span>
                <span class="c1">## skip the call back</span>
                <span class="c1">## this means that the callback shoulden&#39;t be added in the first place</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The current </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo_backend</span><span class="si">}</span><span class="s2"> backend is not supported so we do not know how to prune&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Callback">Callback</a></dt>
                                <dd id="HPOPruneCallback.add_coordinator" class="function"><a href="#Callback.add_coordinator">add_coordinator</a></dd>

            </div>
            <div><dt><a href="#ICallback">ICallback</a></dt>
                                <dd id="HPOPruneCallback.on_train_begin" class="function"><a href="#ICallback.on_train_begin">on_train_begin</a></dd>
                <dd id="HPOPruneCallback.on_epoch_begin" class="function"><a href="#ICallback.on_epoch_begin">on_epoch_begin</a></dd>
                <dd id="HPOPruneCallback.on_train_batch_begin" class="function"><a href="#ICallback.on_train_batch_begin">on_train_batch_begin</a></dd>
                <dd id="HPOPruneCallback.on_train_batch_end" class="function"><a href="#ICallback.on_train_batch_end">on_train_batch_end</a></dd>
                <dd id="HPOPruneCallback.on_train_end" class="function"><a href="#ICallback.on_train_end">on_train_end</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="HPOPruneCallback.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="WandBLogCallback">
                                <div class="attr class">
        <a class="headerlink" href="#WandBLogCallback">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">WandBLogCallback</span><wbr>(<span class="base"><a href="#Callback">Callback</a></span>, <span class="base"><a href="#IOutput">IOutput</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">WandBLogCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">,</span> <span class="n">IOutput</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">init_args</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_name_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_args</span> <span class="o">=</span> <span class="n">init_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span> <span class="o">=</span> <span class="n">additional_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name_prefix</span> <span class="o">=</span> <span class="n">model_name_prefix</span>

    <span class="k">def</span> <span class="nf">__flatdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">_temp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_out</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_out</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">_temp</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                     <span class="n">_temp</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_out</span>
            <span class="k">return</span> <span class="n">_temp</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;savable_config&quot;</span><span class="p">):</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">savable_config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training will log information to WandB, however, the callback was unable to find the model configuration, you should explicitly set the model configuration or use @savable_model decorator&quot;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">=</span><span class="n">model_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                       <span class="n">entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">=</span><span class="n">model_config</span><span class="p">)</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_args</span><span class="p">)</span> 
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span><span class="p">)</span> 
        
        <span class="c1"># add optimizer and loss</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">GenericFunction</span><span class="p">):</span>
            <span class="n">_loss</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="n">_loss</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>   
        
        <span class="n">_optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">_optimizer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        
        <span class="n">other_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">_loss</span><span class="p">,</span>
                      <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">_optimizer</span><span class="p">}</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other_data</span><span class="p">)</span> 
        
        <span class="c1"># set the model name to the name generated by the wandb callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="c1">#f&quot;{self.model_name_prefix}_{wandb.run.name}&quot;)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        
        <span class="c1"># store other metrics that other callback have produced</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="c1"># store other metrics that other callback have produced</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Interface</p>
</div>


                            <div id="WandBLogCallback.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#WandBLogCallback.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">WandBLogCallback</span><span class="signature">(
    project,
    init_args,
    entity=None,
    additional_info=None,
    model_config=None,
    model_name_prefix=&#39;&#39;
)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">init_args</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_name_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_args</span> <span class="o">=</span> <span class="n">init_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span> <span class="o">=</span> <span class="n">additional_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name_prefix</span> <span class="o">=</span> <span class="n">model_name_prefix</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="WandBLogCallback.on_train_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#WandBLogCallback.on_train_begin">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_begin</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;savable_config&quot;</span><span class="p">):</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">savable_config</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_config</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training will log information to WandB, however, the callback was unable to find the model configuration, you should explicitly set the model configuration or use @savable_model decorator&quot;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">=</span><span class="n">model_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                       <span class="n">entity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">,</span>
                       <span class="n">config</span><span class="o">=</span><span class="n">model_config</span><span class="p">)</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_args</span><span class="p">)</span> 
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span><span class="p">)</span> 
        
        <span class="c1"># add optimizer and loss</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">GenericFunction</span><span class="p">):</span>
            <span class="n">_loss</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="n">_loss</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>   
        
        <span class="n">_optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">_optimizer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        
        <span class="n">other_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">_loss</span><span class="p">,</span>
                      <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">_optimizer</span><span class="p">}</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other_data</span><span class="p">)</span> 
        
        <span class="c1"># set the model name to the name generated by the wandb callback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">wandb</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="c1">#f&quot;{self.model_name_prefix}_{wandb.run.name}&quot;)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="WandBLogCallback.on_train_batch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#WandBLogCallback.on_train_batch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_batch_end</span><span class="signature">(self, epoch, step, loss)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        
        <span class="c1"># store other metrics that other callback have produced</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="WandBLogCallback.on_epoch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#WandBLogCallback.on_epoch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_epoch_end</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="c1"># store other metrics that other callback have produced</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__flatdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epoch</span>
        
        <span class="n">wandb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Callback">Callback</a></dt>
                                <dd id="WandBLogCallback.add_coordinator" class="function"><a href="#Callback.add_coordinator">add_coordinator</a></dd>

            </div>
            <div><dt><a href="#ICallback">ICallback</a></dt>
                                <dd id="WandBLogCallback.on_epoch_begin" class="function"><a href="#ICallback.on_epoch_begin">on_epoch_begin</a></dd>
                <dd id="WandBLogCallback.on_train_batch_begin" class="function"><a href="#ICallback.on_train_batch_begin">on_train_batch_begin</a></dd>
                <dd id="WandBLogCallback.on_train_end" class="function"><a href="#ICallback.on_train_end">on_train_end</a></dd>

            </div>
            <div><dt><a href="#IOutput">IOutput</a></dt>
                                <dd id="WandBLogCallback.write" class="function"><a href="#IOutput.write">write</a></dd>
                <dd id="WandBLogCallback.flush" class="function"><a href="#IOutput.flush">flush</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="WandBLogCallback.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ConsoleLogCallback">
                                <div class="attr class">
        <a class="headerlink" href="#ConsoleLogCallback">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ConsoleLogCallback</span><wbr>(<span class="base"><a href="#Callback">Callback</a></span>, <span class="base"><a href="#IOutput">IOutput</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ConsoleLogCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">,</span> <span class="n">IOutput</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_on_train_step</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_on_train_step</span> <span class="o">=</span> <span class="n">log_on_train_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__dict2srt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot; - &quot;</span><span class="p">):</span>
        <span class="c1"># Maybe redo this code, to be more automatic, assume a dict is open and a list prints the last element</span>
        <span class="n">_tmp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1">#for k,v in d.items():</span>
                <span class="c1">## recursion</span>
            <span class="n">_temp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)):</span>
                    <span class="n">_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">_out</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="n">_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">_out</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">_tmp</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_temp</span><span class="p">)</span>

            <span class="c1">#_tmp += f&quot; - {k}: [{list_str}]&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">_tmp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;, &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">_tmp</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
                
        <span class="k">return</span> <span class="n">_tmp</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Begin training of the model </span><span class="se">\&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> epochs&quot;</span><span class="p">)</span>
        <span class="n">jit_compiler_flag</span> <span class="o">=</span> <span class="n">get_jit_compile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training step will be build with jit_compiler=</span><span class="si">{</span><span class="n">jit_compiler_flag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Begin epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        
        <span class="n">_tmp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">steps</span><span class="si">}</span><span class="s2"> - loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - &quot;</span>
        
        <span class="c1"># Maybe redo this code, to be more automatic, assume a dict is open and a list prints the last element</span>
        <span class="n">_tmp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_on_train_step</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">_tmp</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>

        <span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">_len</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span><span class="o">/</span><span class="n">_len</span>
        
        <span class="n">_tmp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Average loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - &quot;</span>

        <span class="c1"># print the reminder of the messages that other callbacks may have set  </span>
        <span class="n">_tmp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)</span>
    
    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;End of the training&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Interface</p>
</div>


                            <div id="ConsoleLogCallback.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ConsoleLogCallback.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ConsoleLogCallback</span><span class="signature">(log_on_train_step=False)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_on_train_step</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_on_train_step</span> <span class="o">=</span> <span class="n">log_on_train_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="ConsoleLogCallback.on_train_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ConsoleLogCallback.on_train_begin">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_begin</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Begin training of the model </span><span class="se">\&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">epochs</span><span class="si">}</span><span class="s2"> epochs&quot;</span><span class="p">)</span>
        <span class="n">jit_compiler_flag</span> <span class="o">=</span> <span class="n">get_jit_compile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The training step will be build with jit_compiler=</span><span class="si">{</span><span class="n">jit_compiler_flag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ConsoleLogCallback.on_epoch_begin" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ConsoleLogCallback.on_epoch_begin">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_epoch_begin</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Begin epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ConsoleLogCallback.on_train_batch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ConsoleLogCallback.on_train_batch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_batch_end</span><span class="signature">(self, epoch, step, loss)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_batch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">loss</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        
        <span class="n">_tmp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="o">.</span><span class="n">steps</span><span class="si">}</span><span class="s2"> - loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - &quot;</span>
        
        <span class="c1"># Maybe redo this code, to be more automatic, assume a dict is open and a list prints the last element</span>
        <span class="n">_tmp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_on_train_step</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">_tmp</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ConsoleLogCallback.on_epoch_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ConsoleLogCallback.on_epoch_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_epoch_end</span><span class="signature">(self, epoch)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>

        <span class="n">_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">_len</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avg_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_per_epoch</span><span class="p">[</span><span class="n">epoch</span><span class="p">])</span><span class="o">/</span><span class="n">_len</span>
        
        <span class="n">_tmp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Average loss: </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> - &quot;</span>

        <span class="c1"># print the reminder of the messages that other callbacks may have set  </span>
        <span class="n">_tmp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict2srt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ConsoleLogCallback.on_train_end" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ConsoleLogCallback.on_train_end">#&nbsp;&nbsp</a>

                <div class="decorator">@runs_if_root</div>

            <span class="def">def</span>
            <span class="name">on_train_end</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@runs_if_root</span>
    <span class="k">def</span> <span class="nf">on_train_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;End of the training&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Callback">Callback</a></dt>
                                <dd id="ConsoleLogCallback.add_coordinator" class="function"><a href="#Callback.add_coordinator">add_coordinator</a></dd>

            </div>
            <div><dt><a href="#ICallback">ICallback</a></dt>
                                <dd id="ConsoleLogCallback.on_train_batch_begin" class="function"><a href="#ICallback.on_train_batch_begin">on_train_batch_begin</a></dd>

            </div>
            <div><dt><a href="#IOutput">IOutput</a></dt>
                                <dd id="ConsoleLogCallback.write" class="function"><a href="#IOutput.write">write</a></dd>
                <dd id="ConsoleLogCallback.flush" class="function"><a href="#IOutput.flush">flush</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="ConsoleLogCallback.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>