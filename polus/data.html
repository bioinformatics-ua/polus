<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.0.1"/>
    <title>polus.data API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../polus.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;polus</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

        <h2>Contents</h2>
        <ul>
  <li><a href="#polus-data-api">Polus Data API</a></li>
</ul>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#DataLoader">DataLoader</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DataLoader.__init__">DataLoader</a>
                        </li>
                        <li>
                                <a class="function" href="#DataLoader.to_tfDataset">to_tfDataset</a>
                        </li>
                        <li>
                                <a class="function" href="#DataLoader.set_name">set_name</a>
                        </li>
                        <li>
                                <a class="function" href="#DataLoader.get_n_samples">get_n_samples</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CachedDataLoader">CachedDataLoader</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CachedDataLoader.__init__">CachedDataLoader</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.from_cached_index">from_cached_index</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.merge">merge</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.read_index">read_index</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.write_index_file">write_index_file</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.clean">clean</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.pre_shuffle">pre_shuffle</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.add_lookup_data">add_lookup_data</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.add_lookup_data_path">add_lookup_data_path</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.deep_copy">deep_copy</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CachedDataLoaderwLookup">CachedDataLoaderwLookup</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.__init__">CachedDataLoaderwLookup</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.get_lookup_data">get_lookup_data</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.merge">merge</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.clean">clean</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.write_index_file">write_index_file</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#IAccelerated_Map">IAccelerated_Map</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#IAccelerated_Map.__init__">IAccelerated_Map</a>
                        </li>
                        <li>
                                <a class="function" href="#IAccelerated_Map.build">build</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#access_embeddings">access_embeddings</a>
            </li>
            <li>
                    <a class="function" href="#build_bert_embeddings">build_bert_embeddings</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../polus.html">polus</a><wbr>.data    </h1>

                        <div class="docstring"><h1 id="polus-data-api">Polus Data API</h1>

<p>The polus data API serves as a wrapper of the <em>tf.data.Dataset</em> API.
More precisely, we focus on the perspective of data loading and
efficient preprocessing, hence the main classes here are the DataLoaders.</p>

<h3 id="main-classes">Main classes</h3>

<ul>
<li><p><code><a href="#DataLoader">polus.data.DataLoader</a></code>: Base class of data loader and automatically converts python
generators to highly efficient <em>tf.data.Dataset</em>. Furthermore, it also supports
GPU preprocessing which differs from <em>tf.data.Dataset</em>, since it only runs on CPU</p></li>
<li><p><code><a href="#CachedDataLoader">polus.data.CachedDataLoader</a></code>: Extension of <code>polus.DataLoader</code>, adds the ability to seamlessly
store the preprocessed samples in the disk, following a chunking mechanism. Besides the
organizational advantage, this also enables us to implement a <em>pre_shuffle</em> mechanism
that occurs at the chunk level, making it a much more efficient process since we can
fully shuffle the dataset without the need to have it in memory.</p></li>
<li><p><code><a href="#CachedDataLoaderwLookup">polus.data.CachedDataLoaderwLookup</a></code>: Extension of <code><a href="#CachedDataLoader">polus.data.CachedDataLoader</a></code>, adds the
functionality to store arbitrary python objects jointly with the stored DataLoader.
Note for storing python objects we use the <em>pickle</em> library.</p></li>
</ul>
</div>

                        <input id="data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="data-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd"># Polus Data API</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">The polus data API serves as a wrapper of the *tf.data.Dataset* API.</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">More precisely, we focus on the perspective of data loading and</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">efficient preprocessing, hence the main classes here are the DataLoaders.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">### Main classes</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">- `polus.data.DataLoader`: Base class of data loader and automatically converts python</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="sd">  generators to highly efficient *tf.data.Dataset*. Furthermore, it also supports</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">  GPU preprocessing which differs from *tf.data.Dataset*, since it only runs on CPU</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd"> </span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">- `polus.data.CachedDataLoader`: Extension of `polus.DataLoader`, adds the ability to seamlessly</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="sd">  store the preprocessed samples in the disk, following a chunking mechanism. Besides the</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">  organizational advantage, this also enables us to implement a *pre_shuffle* mechanism</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="sd">  that occurs at the chunk level, making it a much more efficient process since we can</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">  fully shuffle the dataset without the need to have it in memory.</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="sd">- `polus.data.CachedDataLoaderwLookup`: Extension of `polus.data.CachedDataLoader`, adds the</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd">  functionality to store arbitrary python objects jointly with the stored DataLoader.</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">  Note for storing python objects we use the *pickle* library.</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="kn">import</span> <span class="nn">pickle</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="kn">import</span> <span class="nn">random</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="kn">import</span> <span class="nn">json</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="kn">import</span> <span class="nn">types</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="kn">from</span> <span class="nn">polus</span> <span class="kn">import</span> <span class="n">logger</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a><span class="kn">from</span> <span class="nn">polus.core</span> <span class="kn">import</span> <span class="n">find_dtype_and_shapes</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="kn">from</span> <span class="nn">polus.models</span> <span class="kn">import</span> <span class="n">split_bert_model</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">TFAutoModel</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="kn">from</span> <span class="nn">transformers.modeling_tf_outputs</span> <span class="kn">import</span> <span class="n">TFBaseModelOutputWithPooling</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="kn">from</span> <span class="nn">polus</span> <span class="kn">import</span> <span class="n">PolusContext</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="k">if</span> <span class="n">PolusContext</span><span class="p">()</span><span class="o">.</span><span class="n">is_horovod_enabled</span><span class="p">():</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>    <span class="kn">import</span> <span class="nn">horovod.tensorflow</span> <span class="k">as</span> <span class="nn">hvd</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="k">else</span><span class="p">:</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>    <span class="kn">import</span> <span class="nn">polus.mock.horovod</span> <span class="k">as</span> <span class="nn">hvd</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    Base class of a data loader that builds higly efficient datasets (*tf.data.Dataset*)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    from full python generators.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    </span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    The python generator must return a dictionary of samples, and no other format</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    is currently supported.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a><span class="sd">    </span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>                 <span class="n">sample_generator</span><span class="p">,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>                 <span class="n">magic_k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        </span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        Args:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">          sample_generator (python generator): Must be a python generator that returns a</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">            **dictionary of samples**. Since this generator may be converted into a</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">            *tf.data.Dataset*, all the datatypes should be supported in TensorFlow, which is</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">            true for all python primitives types.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">          </span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">          magic_k (int): Integer number that defines how many samples would be executed in order to infer</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">            the shape and type of the data.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">        </span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="sd">        Returns:</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">          None</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">        </span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="k">if</span> <span class="n">sample_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span> <span class="o">=</span> <span class="n">sample_generator</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">magic_k</span> <span class="o">=</span> <span class="n">magic_k</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>    <span class="k">def</span> <span class="nf">to_tfDataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>                                               <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magic_k</span><span class="p">)</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>                                                    <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>                                                    <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="k">if</span> <span class="n">PolusContext</span><span class="p">()</span><span class="o">.</span><span class="n">is_horovod_enabled</span><span class="p">():</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------SHARDING THE DATASET!!!!-----------&quot;</span><span class="p">)</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>            <span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf_dataset</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">num_shards</span> <span class="o">=</span> <span class="n">hvd</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">())</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>            
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="k">return</span> <span class="n">tf_dataset</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>    
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_name</span><span class="p">):</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">_name</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>    <span class="nd">@property</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="c1"># returns the function iterator</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            <span class="n">sample_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">()</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_generator</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>                <span class="k">return</span> <span class="n">sample_generator</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The sample_generator that was set in the DataLoader was a function that did not return an generator, it must return a generator&quot;</span><span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">)</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>    <span class="k">def</span> <span class="nf">get_n_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">        Returns the number of samples that the DataLoader contains,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a><span class="sd">        if the DataLoader does not know how many samples it has, then</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">        the DataLoader will first count the samples and then cache it</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">        and return the counter.</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;n_samples&quot;</span><span class="p">):</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;this dataset does not have the number of samples in cache so it will take some time to counting&quot;</span><span class="p">)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>                
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>            
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a><span class="k">class</span> <span class="nc">CachedDataLoader</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a><span class="sd">    Extension of a the DataLoader class that adds the ability to seamlessly</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a><span class="sd">    store the preprocessed samples in the disk, following a chunking mechanism. Besides the</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a><span class="sd">    organizational advantage, this also enables us to implement a *pre_shuffle* mechanism</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a><span class="sd">    that occurs at the chunk level, making it a must more efficient process since we can</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a><span class="sd">    fully shuffle the dataset without the need to have its memory. of a data loader</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a><span class="sd">    that builds higly efficient datasets (*tf.data.Dataset*) from full python generators.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a><span class="sd">    </span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">    Since this class involves the storage of files on disk, if any exception is raised, the</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">    DataLoader will automatically clean all the created files before raising the exception</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">    to the user.</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a><span class="sd">    </span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>    
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>                 <span class="n">sample_generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                 <span class="n">clean_up_function</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>                 <span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                 <span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>                 <span class="n">cache_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.polus_cache&quot;</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                 <span class="n">cache_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="sd">        </span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">        Args:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">          source_generator (python generator): Same as in `polus.data.DataLoader`</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">          </span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="c1"># impossible condition</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="k">assert</span> <span class="n">sample_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="o">=</span> <span class="n">cache_folder</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="n">cache_chunk_size</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="n">cache_additional_identifier</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_function</span> <span class="o">=</span> <span class="n">clean_up_function</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache_index</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>        
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;cache_index_path&quot;</span> <span class="ow">in</span> <span class="n">cache_index</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;cache_index_path&quot;</span><span class="p">]</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="c1"># this dataset probably do not have a cache_index_path, this can happen if the DataLoader was created</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="c1"># from merge of multiple DataLoader</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>            <span class="n">sample_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_sample_generator</span><span class="p">(</span><span class="n">sample_generator</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sample_generator</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>            
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>            <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>                <span class="c1"># here we dont want to solve the exception, we just want to clean up de previously created files</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An error has occured so all the created files will be deleted&quot;</span><span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="k">raise</span> <span class="n">e</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>    <span class="nd">@property</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>            <span class="n">_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>    
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="k">def</span> <span class="nf">from_cached_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">index_path</span><span class="p">):</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="n">index_info</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">index_path</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_index_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_path</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>    
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>                      <span class="p">}</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="c1"># read files</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoader</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>                
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>                 
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>    <span class="k">def</span> <span class="nf">read_index</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="k">return</span> <span class="n">index</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>    
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>    <span class="k">def</span> <span class="nf">_build_sample_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_generator</span><span class="p">):</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>        
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>            <span class="c1"># we are alredy have the data needed to create the DataLoader</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="c1"># So, let&#39;s build it</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>                 
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">):</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="c1"># get path to cache</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_cache_base_name</span><span class="p">(</span><span class="n">sample_generator</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_name</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.index&quot;</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>             <span class="c1"># build a generator that reads the files from cache</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataLoader will store the samples in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">, with a max_sample per file of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="si">}</span><span class="s2">, this may take a while&quot;</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>            <span class="c1"># there are no history of a previous generator so we must generate the samples once and then store in cache</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="n">generator</span> <span class="o">=</span> <span class="n">sample_generator</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We found a compatible cache file for this DataLoader&quot;</span><span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_cache_generator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>    
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>    
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>    <span class="k">def</span> <span class="nf">_build_cache_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>        <span class="c1"># first its need to store in cache the samples</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                          <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="p">,</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                          <span class="p">}</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>            
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>            <span class="k">def</span> <span class="nf">write_to_file</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">file_id</span><span class="si">:</span><span class="s2">04</span><span class="si">}</span><span class="s2">.part&quot;</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>                    
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>                <span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>            
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="n">_temp_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>            <span class="n">_file_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>            
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>            <span class="c1"># TODO: Change the tf section here so that all the tf function launched here can be destroyed</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting to cache the dataset, this may take a while&quot;</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>            
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">():</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>                <span class="n">_temp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_temp_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="p">:</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>                    <span class="c1"># save data to file</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                    
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                    <span class="n">write_to_file</span><span class="p">(</span><span class="n">_file_index</span><span class="p">,</span> <span class="n">_temp_data</span><span class="p">,</span> <span class="n">index_info</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                    
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                    <span class="c1"># clean up</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                    <span class="n">_temp_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                    <span class="n">_file_index</span><span class="o">+=</span><span class="mi">1</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="c1"># TODO: swap to the main tf session and destroy the previous one</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_temp_data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                <span class="c1"># save the reminder data</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="n">write_to_file</span><span class="p">(</span><span class="n">_file_index</span><span class="p">,</span> <span class="n">_temp_data</span><span class="p">,</span> <span class="n">index_info</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>            
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_samples</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="c1"># write the index file</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write_index_file</span><span class="p">(</span><span class="n">index_info</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>            <span class="c1"># TODO: make test to see if this thing works</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing the clean up function after the cached dataset was created&quot;</span><span class="p">)</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_function</span><span class="p">()</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>        
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="c1"># read the index from file</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="c1"># Build the cache generator</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>    
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;files&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">:</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index_path&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>                 
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>    <span class="k">def</span> <span class="nf">__build_generator_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>        <span class="c1"># set n_samples</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>                 
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of samples in dataset: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>        
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>            <span class="n">aux_file_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])))</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>            
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PRE SHUFFLE&quot;</span><span class="p">,</span> <span class="n">aux_file_index</span><span class="p">)</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">aux_file_index</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POST SHUFFLE&quot;</span><span class="p">,</span> <span class="n">aux_file_index</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>                
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="k">for</span> <span class="n">file_index</span> <span class="ow">in</span> <span class="n">aux_file_index</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="n">file_index</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                        <span class="k">yield</span> <span class="n">sample</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                 
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="k">return</span> <span class="n">generator</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>        
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>    <span class="k">def</span> <span class="nf">__build_cache_base_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_generator</span><span class="p">):</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span><span class="si">}</span><span class="s2">_&quot;</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>            
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_chunk</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sample_generator</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>    
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>    
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="nf">pre_shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">        The order of the cached files will be readed in a random order</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>    
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>    <span class="k">def</span> <span class="nf">add_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_object</span><span class="p">):</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a><span class="sd">        Converts a CachedDataLoarder to a CachedDataLoaderwLookup</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>        <span class="n">cache_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>        
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="c1">## manually add lookup_data to the index</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>        <span class="n">lookup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.lookup&quot;</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>        
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">lookup_object</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_lookup_data_path</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>    <span class="k">def</span> <span class="nf">add_lookup_data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_data_path</span><span class="p">):</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lookup_data_path</span><span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="c1"># modify the index</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_data_path</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>        
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>            
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>        <span class="k">return</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">from_cached_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>    
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>    <span class="k">def</span> <span class="nf">deep_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>            <span class="n">sufix</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span> <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">suffix</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.index&quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>            
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>        
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        <span class="c1"># update the path to the current index file</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>    
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="k">class</span> <span class="nc">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">CachedDataLoader</span><span class="p">):</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a><span class="sd">    Correspond to a CachedDataLoader but also keeps track of an aditional lookup file</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>    
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>                 <span class="n">lookup_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>                 <span class="n">cache_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>                 <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>                <span class="p">):</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>        
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="n">cache_index</span><span class="p">:</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                <span class="n">lookup_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>        <span class="k">if</span> <span class="n">lookup_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Do not use CachedDataLoaderwLookup without setting a lookup_data, instead use CachedDataLoader&quot;</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">lookup_data</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="c1"># the parent DataLoader will call _build_sample_generator that contains the logic to build the dataloader</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cache_index</span><span class="o">=</span><span class="n">cache_index</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>    <span class="k">def</span> <span class="nf">get_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>    
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>    <span class="k">def</span> <span class="nf">_load_lookup_data</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">):</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>    
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>                      <span class="p">}</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="n">lookup_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="c1"># read files</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>            
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>                
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>            
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>            <span class="n">lookup_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]))</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>            
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="k">return</span> <span class="n">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">,</span> <span class="n">lookup_data</span><span class="o">=</span><span class="n">lookup_data</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>    
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]):</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>        
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>        <span class="c1">## add lookup_data to the index</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="n">lookup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.lookup&quot;</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>        
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_file</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>            
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>    <span class="k">def</span> <span class="nf">__build_generator_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>    
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a><span class="k">class</span> <span class="nc">IAccelerated_Map</span><span class="p">:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;IAccelerated_Map&quot;</span><span class="p">:</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>            
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>        <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;build method was not implemented&quot;</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>    
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="k">def</span> <span class="nf">access_embeddings</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">    A simple decorator function to access the embeddings property if present in the data</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>    <span class="k">def</span> <span class="nf">function_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;embeddings&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;embeddings&quot;</span><span class="p">])</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>            
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>    <span class="k">return</span> <span class="n">function_wrapper</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>    
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="nd">@access_embeddings</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a><span class="k">def</span> <span class="nf">build_bert_embeddings</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">bert_layer_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>    
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>    <span class="n">bert_model</span> <span class="o">=</span> <span class="n">TFAutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>                                             <span class="n">output_attentions</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>                                             <span class="n">output_hidden_states</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>                                             <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>                                             <span class="n">from_pt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>    
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>    
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>    
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>    <span class="k">if</span> <span class="n">bert_layer_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="n">pre_bert_model</span> <span class="o">=</span> <span class="n">split_bert_model</span><span class="p">(</span><span class="n">bert_model</span><span class="p">,</span> <span class="n">bert_layer_index</span><span class="p">,</span> <span class="n">return_post_bert_model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>        <span class="k">def</span> <span class="nf">embeddings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>            <span class="k">return</span> <span class="n">pre_bert_model</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>        <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="k">def</span> <span class="nf">embeddings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="k">return</span> <span class="n">bert_model</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>    <span class="k">return</span> <span class="n">embeddings</span>
</span></pre></div>


            </section>
                <section id="DataLoader">
                            <input id="DataLoader-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DataLoader</span>:

                <label class="view-source-button" for="DataLoader-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataLoader"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataLoader-50"><a href="#DataLoader-50"><span class="linenos"> 50</span></a><span class="k">class</span> <span class="nc">DataLoader</span><span class="p">:</span>
</span><span id="DataLoader-51"><a href="#DataLoader-51"><span class="linenos"> 51</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DataLoader-52"><a href="#DataLoader-52"><span class="linenos"> 52</span></a><span class="sd">    Base class of a data loader that builds higly efficient datasets (*tf.data.Dataset*)</span>
</span><span id="DataLoader-53"><a href="#DataLoader-53"><span class="linenos"> 53</span></a><span class="sd">    from full python generators.</span>
</span><span id="DataLoader-54"><a href="#DataLoader-54"><span class="linenos"> 54</span></a><span class="sd">    </span>
</span><span id="DataLoader-55"><a href="#DataLoader-55"><span class="linenos"> 55</span></a><span class="sd">    The python generator must return a dictionary of samples, and no other format</span>
</span><span id="DataLoader-56"><a href="#DataLoader-56"><span class="linenos"> 56</span></a><span class="sd">    is currently supported.</span>
</span><span id="DataLoader-57"><a href="#DataLoader-57"><span class="linenos"> 57</span></a><span class="sd">    </span>
</span><span id="DataLoader-58"><a href="#DataLoader-58"><span class="linenos"> 58</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="DataLoader-59"><a href="#DataLoader-59"><span class="linenos"> 59</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="DataLoader-60"><a href="#DataLoader-60"><span class="linenos"> 60</span></a>                 <span class="n">sample_generator</span><span class="p">,</span>
</span><span id="DataLoader-61"><a href="#DataLoader-61"><span class="linenos"> 61</span></a>                 <span class="n">magic_k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="DataLoader-62"><a href="#DataLoader-62"><span class="linenos"> 62</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DataLoader-63"><a href="#DataLoader-63"><span class="linenos"> 63</span></a><span class="sd">        </span>
</span><span id="DataLoader-64"><a href="#DataLoader-64"><span class="linenos"> 64</span></a><span class="sd">        Args:</span>
</span><span id="DataLoader-65"><a href="#DataLoader-65"><span class="linenos"> 65</span></a><span class="sd">          sample_generator (python generator): Must be a python generator that returns a</span>
</span><span id="DataLoader-66"><a href="#DataLoader-66"><span class="linenos"> 66</span></a><span class="sd">            **dictionary of samples**. Since this generator may be converted into a</span>
</span><span id="DataLoader-67"><a href="#DataLoader-67"><span class="linenos"> 67</span></a><span class="sd">            *tf.data.Dataset*, all the datatypes should be supported in TensorFlow, which is</span>
</span><span id="DataLoader-68"><a href="#DataLoader-68"><span class="linenos"> 68</span></a><span class="sd">            true for all python primitives types.</span>
</span><span id="DataLoader-69"><a href="#DataLoader-69"><span class="linenos"> 69</span></a><span class="sd">          </span>
</span><span id="DataLoader-70"><a href="#DataLoader-70"><span class="linenos"> 70</span></a><span class="sd">          magic_k (int): Integer number that defines how many samples would be executed in order to infer</span>
</span><span id="DataLoader-71"><a href="#DataLoader-71"><span class="linenos"> 71</span></a><span class="sd">            the shape and type of the data.</span>
</span><span id="DataLoader-72"><a href="#DataLoader-72"><span class="linenos"> 72</span></a><span class="sd">        </span>
</span><span id="DataLoader-73"><a href="#DataLoader-73"><span class="linenos"> 73</span></a><span class="sd">        Returns:</span>
</span><span id="DataLoader-74"><a href="#DataLoader-74"><span class="linenos"> 74</span></a><span class="sd">          None</span>
</span><span id="DataLoader-75"><a href="#DataLoader-75"><span class="linenos"> 75</span></a><span class="sd">        </span>
</span><span id="DataLoader-76"><a href="#DataLoader-76"><span class="linenos"> 76</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DataLoader-77"><a href="#DataLoader-77"><span class="linenos"> 77</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="DataLoader-78"><a href="#DataLoader-78"><span class="linenos"> 78</span></a>        
</span><span id="DataLoader-79"><a href="#DataLoader-79"><span class="linenos"> 79</span></a>        <span class="k">if</span> <span class="n">sample_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DataLoader-80"><a href="#DataLoader-80"><span class="linenos"> 80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="DataLoader-81"><a href="#DataLoader-81"><span class="linenos"> 81</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DataLoader-82"><a href="#DataLoader-82"><span class="linenos"> 82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
</span><span id="DataLoader-83"><a href="#DataLoader-83"><span class="linenos"> 83</span></a>        
</span><span id="DataLoader-84"><a href="#DataLoader-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span> <span class="o">=</span> <span class="n">sample_generator</span>
</span><span id="DataLoader-85"><a href="#DataLoader-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">magic_k</span> <span class="o">=</span> <span class="n">magic_k</span>
</span><span id="DataLoader-86"><a href="#DataLoader-86"><span class="linenos"> 86</span></a>
</span><span id="DataLoader-87"><a href="#DataLoader-87"><span class="linenos"> 87</span></a>    <span class="k">def</span> <span class="nf">to_tfDataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DataLoader-88"><a href="#DataLoader-88"><span class="linenos"> 88</span></a>        <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="DataLoader-89"><a href="#DataLoader-89"><span class="linenos"> 89</span></a>                                               <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magic_k</span><span class="p">)</span>
</span><span id="DataLoader-90"><a href="#DataLoader-90"><span class="linenos"> 90</span></a>        
</span><span id="DataLoader-91"><a href="#DataLoader-91"><span class="linenos"> 91</span></a>        <span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
</span><span id="DataLoader-92"><a href="#DataLoader-92"><span class="linenos"> 92</span></a>                                                    <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
</span><span id="DataLoader-93"><a href="#DataLoader-93"><span class="linenos"> 93</span></a>                                                    <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>
</span><span id="DataLoader-94"><a href="#DataLoader-94"><span class="linenos"> 94</span></a>        
</span><span id="DataLoader-95"><a href="#DataLoader-95"><span class="linenos"> 95</span></a>        <span class="k">if</span> <span class="n">PolusContext</span><span class="p">()</span><span class="o">.</span><span class="n">is_horovod_enabled</span><span class="p">():</span>
</span><span id="DataLoader-96"><a href="#DataLoader-96"><span class="linenos"> 96</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------SHARDING THE DATASET!!!!-----------&quot;</span><span class="p">)</span>
</span><span id="DataLoader-97"><a href="#DataLoader-97"><span class="linenos"> 97</span></a>            <span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf_dataset</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">num_shards</span> <span class="o">=</span> <span class="n">hvd</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">())</span>
</span><span id="DataLoader-98"><a href="#DataLoader-98"><span class="linenos"> 98</span></a>            
</span><span id="DataLoader-99"><a href="#DataLoader-99"><span class="linenos"> 99</span></a>        <span class="k">return</span> <span class="n">tf_dataset</span>
</span><span id="DataLoader-100"><a href="#DataLoader-100"><span class="linenos">100</span></a>        
</span><span id="DataLoader-101"><a href="#DataLoader-101"><span class="linenos">101</span></a>    
</span><span id="DataLoader-102"><a href="#DataLoader-102"><span class="linenos">102</span></a>    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_name</span><span class="p">):</span>
</span><span id="DataLoader-103"><a href="#DataLoader-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">_name</span>
</span><span id="DataLoader-104"><a href="#DataLoader-104"><span class="linenos">104</span></a>    
</span><span id="DataLoader-105"><a href="#DataLoader-105"><span class="linenos">105</span></a>    <span class="nd">@property</span>
</span><span id="DataLoader-106"><a href="#DataLoader-106"><span class="linenos">106</span></a>    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DataLoader-107"><a href="#DataLoader-107"><span class="linenos">107</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="DataLoader-108"><a href="#DataLoader-108"><span class="linenos">108</span></a>
</span><span id="DataLoader-109"><a href="#DataLoader-109"><span class="linenos">109</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DataLoader-110"><a href="#DataLoader-110"><span class="linenos">110</span></a>        <span class="c1"># returns the function iterator</span>
</span><span id="DataLoader-111"><a href="#DataLoader-111"><span class="linenos">111</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
</span><span id="DataLoader-112"><a href="#DataLoader-112"><span class="linenos">112</span></a>            <span class="n">sample_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">()</span>
</span><span id="DataLoader-113"><a href="#DataLoader-113"><span class="linenos">113</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_generator</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>
</span><span id="DataLoader-114"><a href="#DataLoader-114"><span class="linenos">114</span></a>                <span class="k">return</span> <span class="n">sample_generator</span>
</span><span id="DataLoader-115"><a href="#DataLoader-115"><span class="linenos">115</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DataLoader-116"><a href="#DataLoader-116"><span class="linenos">116</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The sample_generator that was set in the DataLoader was a function that did not return an generator, it must return a generator&quot;</span><span class="p">)</span>
</span><span id="DataLoader-117"><a href="#DataLoader-117"><span class="linenos">117</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DataLoader-118"><a href="#DataLoader-118"><span class="linenos">118</span></a>            <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">)</span>
</span><span id="DataLoader-119"><a href="#DataLoader-119"><span class="linenos">119</span></a>
</span><span id="DataLoader-120"><a href="#DataLoader-120"><span class="linenos">120</span></a>    <span class="k">def</span> <span class="nf">get_n_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DataLoader-121"><a href="#DataLoader-121"><span class="linenos">121</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DataLoader-122"><a href="#DataLoader-122"><span class="linenos">122</span></a><span class="sd">        Returns the number of samples that the DataLoader contains,</span>
</span><span id="DataLoader-123"><a href="#DataLoader-123"><span class="linenos">123</span></a><span class="sd">        if the DataLoader does not know how many samples it has, then</span>
</span><span id="DataLoader-124"><a href="#DataLoader-124"><span class="linenos">124</span></a><span class="sd">        the DataLoader will first count the samples and then cache it</span>
</span><span id="DataLoader-125"><a href="#DataLoader-125"><span class="linenos">125</span></a><span class="sd">        and return the counter.</span>
</span><span id="DataLoader-126"><a href="#DataLoader-126"><span class="linenos">126</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DataLoader-127"><a href="#DataLoader-127"><span class="linenos">127</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;n_samples&quot;</span><span class="p">):</span>
</span><span id="DataLoader-128"><a href="#DataLoader-128"><span class="linenos">128</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
</span><span id="DataLoader-129"><a href="#DataLoader-129"><span class="linenos">129</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DataLoader-130"><a href="#DataLoader-130"><span class="linenos">130</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;this dataset does not have the number of samples in cache so it will take some time to counting&quot;</span><span class="p">)</span>
</span><span id="DataLoader-131"><a href="#DataLoader-131"><span class="linenos">131</span></a>            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DataLoader-132"><a href="#DataLoader-132"><span class="linenos">132</span></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="DataLoader-133"><a href="#DataLoader-133"><span class="linenos">133</span></a>                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="DataLoader-134"><a href="#DataLoader-134"><span class="linenos">134</span></a>                
</span><span id="DataLoader-135"><a href="#DataLoader-135"><span class="linenos">135</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
</span><span id="DataLoader-136"><a href="#DataLoader-136"><span class="linenos">136</span></a>            
</span><span id="DataLoader-137"><a href="#DataLoader-137"><span class="linenos">137</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
</span></pre></div>


            <div class="docstring"><p>Base class of a data loader that builds higly efficient datasets (<em>tf.data.Dataset</em>)
from full python generators.</p>

<p>The python generator must return a dictionary of samples, and no other format
is currently supported.</p>
</div>


                            <div id="DataLoader.__init__" class="classattr">
                                        <input id="DataLoader.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DataLoader</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sample_generator</span>, </span><span class="param"><span class="n">magic_k</span><span class="o">=</span><span class="mi">10</span></span>)</span>

                <label class="view-source-button" for="DataLoader.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataLoader.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataLoader.__init__-59"><a href="#DataLoader.__init__-59"><span class="linenos">59</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="DataLoader.__init__-60"><a href="#DataLoader.__init__-60"><span class="linenos">60</span></a>                 <span class="n">sample_generator</span><span class="p">,</span>
</span><span id="DataLoader.__init__-61"><a href="#DataLoader.__init__-61"><span class="linenos">61</span></a>                 <span class="n">magic_k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="DataLoader.__init__-62"><a href="#DataLoader.__init__-62"><span class="linenos">62</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DataLoader.__init__-63"><a href="#DataLoader.__init__-63"><span class="linenos">63</span></a><span class="sd">        </span>
</span><span id="DataLoader.__init__-64"><a href="#DataLoader.__init__-64"><span class="linenos">64</span></a><span class="sd">        Args:</span>
</span><span id="DataLoader.__init__-65"><a href="#DataLoader.__init__-65"><span class="linenos">65</span></a><span class="sd">          sample_generator (python generator): Must be a python generator that returns a</span>
</span><span id="DataLoader.__init__-66"><a href="#DataLoader.__init__-66"><span class="linenos">66</span></a><span class="sd">            **dictionary of samples**. Since this generator may be converted into a</span>
</span><span id="DataLoader.__init__-67"><a href="#DataLoader.__init__-67"><span class="linenos">67</span></a><span class="sd">            *tf.data.Dataset*, all the datatypes should be supported in TensorFlow, which is</span>
</span><span id="DataLoader.__init__-68"><a href="#DataLoader.__init__-68"><span class="linenos">68</span></a><span class="sd">            true for all python primitives types.</span>
</span><span id="DataLoader.__init__-69"><a href="#DataLoader.__init__-69"><span class="linenos">69</span></a><span class="sd">          </span>
</span><span id="DataLoader.__init__-70"><a href="#DataLoader.__init__-70"><span class="linenos">70</span></a><span class="sd">          magic_k (int): Integer number that defines how many samples would be executed in order to infer</span>
</span><span id="DataLoader.__init__-71"><a href="#DataLoader.__init__-71"><span class="linenos">71</span></a><span class="sd">            the shape and type of the data.</span>
</span><span id="DataLoader.__init__-72"><a href="#DataLoader.__init__-72"><span class="linenos">72</span></a><span class="sd">        </span>
</span><span id="DataLoader.__init__-73"><a href="#DataLoader.__init__-73"><span class="linenos">73</span></a><span class="sd">        Returns:</span>
</span><span id="DataLoader.__init__-74"><a href="#DataLoader.__init__-74"><span class="linenos">74</span></a><span class="sd">          None</span>
</span><span id="DataLoader.__init__-75"><a href="#DataLoader.__init__-75"><span class="linenos">75</span></a><span class="sd">        </span>
</span><span id="DataLoader.__init__-76"><a href="#DataLoader.__init__-76"><span class="linenos">76</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DataLoader.__init__-77"><a href="#DataLoader.__init__-77"><span class="linenos">77</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="DataLoader.__init__-78"><a href="#DataLoader.__init__-78"><span class="linenos">78</span></a>        
</span><span id="DataLoader.__init__-79"><a href="#DataLoader.__init__-79"><span class="linenos">79</span></a>        <span class="k">if</span> <span class="n">sample_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DataLoader.__init__-80"><a href="#DataLoader.__init__-80"><span class="linenos">80</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="DataLoader.__init__-81"><a href="#DataLoader.__init__-81"><span class="linenos">81</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DataLoader.__init__-82"><a href="#DataLoader.__init__-82"><span class="linenos">82</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
</span><span id="DataLoader.__init__-83"><a href="#DataLoader.__init__-83"><span class="linenos">83</span></a>        
</span><span id="DataLoader.__init__-84"><a href="#DataLoader.__init__-84"><span class="linenos">84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span> <span class="o">=</span> <span class="n">sample_generator</span>
</span><span id="DataLoader.__init__-85"><a href="#DataLoader.__init__-85"><span class="linenos">85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">magic_k</span> <span class="o">=</span> <span class="n">magic_k</span>
</span></pre></div>


            <div class="docstring"><h6 id="args">Args</h6>

<ul>
<li><strong>sample_generator (python generator):</strong>  Must be a python generator that returns a
<strong>dictionary of samples</strong>. Since this generator may be converted into a
<em>tf.data.Dataset</em>, all the datatypes should be supported in TensorFlow, which is
true for all python primitives types.</li>
<li><strong>magic_k (int):</strong>  Integer number that defines how many samples would be executed in order to infer
the shape and type of the data.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="DataLoader.to_tfDataset" class="classattr">
                                        <input id="DataLoader.to_tfDataset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_tfDataset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="DataLoader.to_tfDataset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataLoader.to_tfDataset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataLoader.to_tfDataset-87"><a href="#DataLoader.to_tfDataset-87"><span class="linenos">87</span></a>    <span class="k">def</span> <span class="nf">to_tfDataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DataLoader.to_tfDataset-88"><a href="#DataLoader.to_tfDataset-88"><span class="linenos">88</span></a>        <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="DataLoader.to_tfDataset-89"><a href="#DataLoader.to_tfDataset-89"><span class="linenos">89</span></a>                                               <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magic_k</span><span class="p">)</span>
</span><span id="DataLoader.to_tfDataset-90"><a href="#DataLoader.to_tfDataset-90"><span class="linenos">90</span></a>        
</span><span id="DataLoader.to_tfDataset-91"><a href="#DataLoader.to_tfDataset-91"><span class="linenos">91</span></a>        <span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
</span><span id="DataLoader.to_tfDataset-92"><a href="#DataLoader.to_tfDataset-92"><span class="linenos">92</span></a>                                                    <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
</span><span id="DataLoader.to_tfDataset-93"><a href="#DataLoader.to_tfDataset-93"><span class="linenos">93</span></a>                                                    <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>
</span><span id="DataLoader.to_tfDataset-94"><a href="#DataLoader.to_tfDataset-94"><span class="linenos">94</span></a>        
</span><span id="DataLoader.to_tfDataset-95"><a href="#DataLoader.to_tfDataset-95"><span class="linenos">95</span></a>        <span class="k">if</span> <span class="n">PolusContext</span><span class="p">()</span><span class="o">.</span><span class="n">is_horovod_enabled</span><span class="p">():</span>
</span><span id="DataLoader.to_tfDataset-96"><a href="#DataLoader.to_tfDataset-96"><span class="linenos">96</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------SHARDING THE DATASET!!!!-----------&quot;</span><span class="p">)</span>
</span><span id="DataLoader.to_tfDataset-97"><a href="#DataLoader.to_tfDataset-97"><span class="linenos">97</span></a>            <span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf_dataset</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">num_shards</span> <span class="o">=</span> <span class="n">hvd</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">hvd</span><span class="o">.</span><span class="n">local_rank</span><span class="p">())</span>
</span><span id="DataLoader.to_tfDataset-98"><a href="#DataLoader.to_tfDataset-98"><span class="linenos">98</span></a>            
</span><span id="DataLoader.to_tfDataset-99"><a href="#DataLoader.to_tfDataset-99"><span class="linenos">99</span></a>        <span class="k">return</span> <span class="n">tf_dataset</span>
</span></pre></div>


    

                            </div>
                            <div id="DataLoader.set_name" class="classattr">
                                        <input id="DataLoader.set_name-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_name</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">_name</span></span>)</span>

                <label class="view-source-button" for="DataLoader.set_name-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataLoader.set_name"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataLoader.set_name-102"><a href="#DataLoader.set_name-102"><span class="linenos">102</span></a>    <span class="k">def</span> <span class="nf">set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_name</span><span class="p">):</span>
</span><span id="DataLoader.set_name-103"><a href="#DataLoader.set_name-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">_name</span>
</span></pre></div>


    

                            </div>
                            <div id="DataLoader.get_n_samples" class="classattr">
                                        <input id="DataLoader.get_n_samples-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_n_samples</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="DataLoader.get_n_samples-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DataLoader.get_n_samples"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DataLoader.get_n_samples-120"><a href="#DataLoader.get_n_samples-120"><span class="linenos">120</span></a>    <span class="k">def</span> <span class="nf">get_n_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="DataLoader.get_n_samples-121"><a href="#DataLoader.get_n_samples-121"><span class="linenos">121</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="DataLoader.get_n_samples-122"><a href="#DataLoader.get_n_samples-122"><span class="linenos">122</span></a><span class="sd">        Returns the number of samples that the DataLoader contains,</span>
</span><span id="DataLoader.get_n_samples-123"><a href="#DataLoader.get_n_samples-123"><span class="linenos">123</span></a><span class="sd">        if the DataLoader does not know how many samples it has, then</span>
</span><span id="DataLoader.get_n_samples-124"><a href="#DataLoader.get_n_samples-124"><span class="linenos">124</span></a><span class="sd">        the DataLoader will first count the samples and then cache it</span>
</span><span id="DataLoader.get_n_samples-125"><a href="#DataLoader.get_n_samples-125"><span class="linenos">125</span></a><span class="sd">        and return the counter.</span>
</span><span id="DataLoader.get_n_samples-126"><a href="#DataLoader.get_n_samples-126"><span class="linenos">126</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DataLoader.get_n_samples-127"><a href="#DataLoader.get_n_samples-127"><span class="linenos">127</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;n_samples&quot;</span><span class="p">):</span>
</span><span id="DataLoader.get_n_samples-128"><a href="#DataLoader.get_n_samples-128"><span class="linenos">128</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
</span><span id="DataLoader.get_n_samples-129"><a href="#DataLoader.get_n_samples-129"><span class="linenos">129</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DataLoader.get_n_samples-130"><a href="#DataLoader.get_n_samples-130"><span class="linenos">130</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;this dataset does not have the number of samples in cache so it will take some time to counting&quot;</span><span class="p">)</span>
</span><span id="DataLoader.get_n_samples-131"><a href="#DataLoader.get_n_samples-131"><span class="linenos">131</span></a>            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DataLoader.get_n_samples-132"><a href="#DataLoader.get_n_samples-132"><span class="linenos">132</span></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="DataLoader.get_n_samples-133"><a href="#DataLoader.get_n_samples-133"><span class="linenos">133</span></a>                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="DataLoader.get_n_samples-134"><a href="#DataLoader.get_n_samples-134"><span class="linenos">134</span></a>                
</span><span id="DataLoader.get_n_samples-135"><a href="#DataLoader.get_n_samples-135"><span class="linenos">135</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
</span><span id="DataLoader.get_n_samples-136"><a href="#DataLoader.get_n_samples-136"><span class="linenos">136</span></a>            
</span><span id="DataLoader.get_n_samples-137"><a href="#DataLoader.get_n_samples-137"><span class="linenos">137</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
</span></pre></div>


            <div class="docstring"><p>Returns the number of samples that the DataLoader contains,
if the DataLoader does not know how many samples it has, then
the DataLoader will first count the samples and then cache it
and return the counter.</p>
</div>


                            </div>
                </section>
                <section id="CachedDataLoader">
                            <input id="CachedDataLoader-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CachedDataLoader</span><wbr>(<span class="base"><a href="#DataLoader">DataLoader</a></span>):

                <label class="view-source-button" for="CachedDataLoader-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader-139"><a href="#CachedDataLoader-139"><span class="linenos">139</span></a><span class="k">class</span> <span class="nc">CachedDataLoader</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
</span><span id="CachedDataLoader-140"><a href="#CachedDataLoader-140"><span class="linenos">140</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CachedDataLoader-141"><a href="#CachedDataLoader-141"><span class="linenos">141</span></a><span class="sd">    Extension of a the DataLoader class that adds the ability to seamlessly</span>
</span><span id="CachedDataLoader-142"><a href="#CachedDataLoader-142"><span class="linenos">142</span></a><span class="sd">    store the preprocessed samples in the disk, following a chunking mechanism. Besides the</span>
</span><span id="CachedDataLoader-143"><a href="#CachedDataLoader-143"><span class="linenos">143</span></a><span class="sd">    organizational advantage, this also enables us to implement a *pre_shuffle* mechanism</span>
</span><span id="CachedDataLoader-144"><a href="#CachedDataLoader-144"><span class="linenos">144</span></a><span class="sd">    that occurs at the chunk level, making it a must more efficient process since we can</span>
</span><span id="CachedDataLoader-145"><a href="#CachedDataLoader-145"><span class="linenos">145</span></a><span class="sd">    fully shuffle the dataset without the need to have its memory. of a data loader</span>
</span><span id="CachedDataLoader-146"><a href="#CachedDataLoader-146"><span class="linenos">146</span></a><span class="sd">    that builds higly efficient datasets (*tf.data.Dataset*) from full python generators.</span>
</span><span id="CachedDataLoader-147"><a href="#CachedDataLoader-147"><span class="linenos">147</span></a><span class="sd">    </span>
</span><span id="CachedDataLoader-148"><a href="#CachedDataLoader-148"><span class="linenos">148</span></a><span class="sd">    Since this class involves the storage of files on disk, if any exception is raised, the</span>
</span><span id="CachedDataLoader-149"><a href="#CachedDataLoader-149"><span class="linenos">149</span></a><span class="sd">    DataLoader will automatically clean all the created files before raising the exception</span>
</span><span id="CachedDataLoader-150"><a href="#CachedDataLoader-150"><span class="linenos">150</span></a><span class="sd">    to the user.</span>
</span><span id="CachedDataLoader-151"><a href="#CachedDataLoader-151"><span class="linenos">151</span></a><span class="sd">    </span>
</span><span id="CachedDataLoader-152"><a href="#CachedDataLoader-152"><span class="linenos">152</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CachedDataLoader-153"><a href="#CachedDataLoader-153"><span class="linenos">153</span></a>    
</span><span id="CachedDataLoader-154"><a href="#CachedDataLoader-154"><span class="linenos">154</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CachedDataLoader-155"><a href="#CachedDataLoader-155"><span class="linenos">155</span></a>                 <span class="n">sample_generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CachedDataLoader-156"><a href="#CachedDataLoader-156"><span class="linenos">156</span></a>                 <span class="n">clean_up_function</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CachedDataLoader-157"><a href="#CachedDataLoader-157"><span class="linenos">157</span></a>                 <span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="CachedDataLoader-158"><a href="#CachedDataLoader-158"><span class="linenos">158</span></a>                 <span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
</span><span id="CachedDataLoader-159"><a href="#CachedDataLoader-159"><span class="linenos">159</span></a>                 <span class="n">cache_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.polus_cache&quot;</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
</span><span id="CachedDataLoader-160"><a href="#CachedDataLoader-160"><span class="linenos">160</span></a>                 <span class="n">cache_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
</span><span id="CachedDataLoader-161"><a href="#CachedDataLoader-161"><span class="linenos">161</span></a>                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="CachedDataLoader-162"><a href="#CachedDataLoader-162"><span class="linenos">162</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CachedDataLoader-163"><a href="#CachedDataLoader-163"><span class="linenos">163</span></a><span class="sd">        </span>
</span><span id="CachedDataLoader-164"><a href="#CachedDataLoader-164"><span class="linenos">164</span></a><span class="sd">        Args:</span>
</span><span id="CachedDataLoader-165"><a href="#CachedDataLoader-165"><span class="linenos">165</span></a><span class="sd">          source_generator (python generator): Same as in `polus.data.DataLoader`</span>
</span><span id="CachedDataLoader-166"><a href="#CachedDataLoader-166"><span class="linenos">166</span></a><span class="sd">          </span>
</span><span id="CachedDataLoader-167"><a href="#CachedDataLoader-167"><span class="linenos">167</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CachedDataLoader-168"><a href="#CachedDataLoader-168"><span class="linenos">168</span></a>        <span class="c1"># impossible condition</span>
</span><span id="CachedDataLoader-169"><a href="#CachedDataLoader-169"><span class="linenos">169</span></a>        <span class="k">assert</span> <span class="n">sample_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="CachedDataLoader-170"><a href="#CachedDataLoader-170"><span class="linenos">170</span></a>
</span><span id="CachedDataLoader-171"><a href="#CachedDataLoader-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="o">=</span> <span class="n">cache_folder</span>
</span><span id="CachedDataLoader-172"><a href="#CachedDataLoader-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="n">cache_chunk_size</span>
</span><span id="CachedDataLoader-173"><a href="#CachedDataLoader-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="n">cache_additional_identifier</span>
</span><span id="CachedDataLoader-174"><a href="#CachedDataLoader-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CachedDataLoader-175"><a href="#CachedDataLoader-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_function</span> <span class="o">=</span> <span class="n">clean_up_function</span>
</span><span id="CachedDataLoader-176"><a href="#CachedDataLoader-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache_index</span>
</span><span id="CachedDataLoader-177"><a href="#CachedDataLoader-177"><span class="linenos">177</span></a>        
</span><span id="CachedDataLoader-178"><a href="#CachedDataLoader-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;cache_index_path&quot;</span> <span class="ow">in</span> <span class="n">cache_index</span><span class="p">:</span>
</span><span id="CachedDataLoader-179"><a href="#CachedDataLoader-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;cache_index_path&quot;</span><span class="p">]</span>
</span><span id="CachedDataLoader-180"><a href="#CachedDataLoader-180"><span class="linenos">180</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CachedDataLoader-181"><a href="#CachedDataLoader-181"><span class="linenos">181</span></a>            <span class="c1"># this dataset probably do not have a cache_index_path, this can happen if the DataLoader was created</span>
</span><span id="CachedDataLoader-182"><a href="#CachedDataLoader-182"><span class="linenos">182</span></a>            <span class="c1"># from merge of multiple DataLoader</span>
</span><span id="CachedDataLoader-183"><a href="#CachedDataLoader-183"><span class="linenos">183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CachedDataLoader-184"><a href="#CachedDataLoader-184"><span class="linenos">184</span></a>
</span><span id="CachedDataLoader-185"><a href="#CachedDataLoader-185"><span class="linenos">185</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="CachedDataLoader-186"><a href="#CachedDataLoader-186"><span class="linenos">186</span></a>            <span class="n">sample_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_sample_generator</span><span class="p">(</span><span class="n">sample_generator</span><span class="p">)</span>
</span><span id="CachedDataLoader-187"><a href="#CachedDataLoader-187"><span class="linenos">187</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sample_generator</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="CachedDataLoader-188"><a href="#CachedDataLoader-188"><span class="linenos">188</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="CachedDataLoader-189"><a href="#CachedDataLoader-189"><span class="linenos">189</span></a>            
</span><span id="CachedDataLoader-190"><a href="#CachedDataLoader-190"><span class="linenos">190</span></a>            <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoader-191"><a href="#CachedDataLoader-191"><span class="linenos">191</span></a>                <span class="c1"># here we dont want to solve the exception, we just want to clean up de previously created files</span>
</span><span id="CachedDataLoader-192"><a href="#CachedDataLoader-192"><span class="linenos">192</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An error has occured so all the created files will be deleted&quot;</span><span class="p">)</span>
</span><span id="CachedDataLoader-193"><a href="#CachedDataLoader-193"><span class="linenos">193</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
</span><span id="CachedDataLoader-194"><a href="#CachedDataLoader-194"><span class="linenos">194</span></a>            <span class="k">raise</span> <span class="n">e</span>
</span><span id="CachedDataLoader-195"><a href="#CachedDataLoader-195"><span class="linenos">195</span></a>            
</span><span id="CachedDataLoader-196"><a href="#CachedDataLoader-196"><span class="linenos">196</span></a>    <span class="nd">@property</span>
</span><span id="CachedDataLoader-197"><a href="#CachedDataLoader-197"><span class="linenos">197</span></a>    <span class="k">def</span> <span class="nf">__name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoader-198"><a href="#CachedDataLoader-198"><span class="linenos">198</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoader-199"><a href="#CachedDataLoader-199"><span class="linenos">199</span></a>            <span class="n">_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CachedDataLoader-200"><a href="#CachedDataLoader-200"><span class="linenos">200</span></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="CachedDataLoader-201"><a href="#CachedDataLoader-201"><span class="linenos">201</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CachedDataLoader-202"><a href="#CachedDataLoader-202"><span class="linenos">202</span></a>            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="CachedDataLoader-203"><a href="#CachedDataLoader-203"><span class="linenos">203</span></a>    
</span><span id="CachedDataLoader-204"><a href="#CachedDataLoader-204"><span class="linenos">204</span></a>    <span class="nd">@classmethod</span>
</span><span id="CachedDataLoader-205"><a href="#CachedDataLoader-205"><span class="linenos">205</span></a>    <span class="k">def</span> <span class="nf">from_cached_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">index_path</span><span class="p">):</span>
</span><span id="CachedDataLoader-206"><a href="#CachedDataLoader-206"><span class="linenos">206</span></a>        
</span><span id="CachedDataLoader-207"><a href="#CachedDataLoader-207"><span class="linenos">207</span></a>        <span class="n">index_info</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">index_path</span><span class="p">)</span>
</span><span id="CachedDataLoader-208"><a href="#CachedDataLoader-208"><span class="linenos">208</span></a>        <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_index_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_path</span>
</span><span id="CachedDataLoader-209"><a href="#CachedDataLoader-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
</span><span id="CachedDataLoader-210"><a href="#CachedDataLoader-210"><span class="linenos">210</span></a>        
</span><span id="CachedDataLoader-211"><a href="#CachedDataLoader-211"><span class="linenos">211</span></a>    
</span><span id="CachedDataLoader-212"><a href="#CachedDataLoader-212"><span class="linenos">212</span></a>    <span class="nd">@classmethod</span>
</span><span id="CachedDataLoader-213"><a href="#CachedDataLoader-213"><span class="linenos">213</span></a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
</span><span id="CachedDataLoader-214"><a href="#CachedDataLoader-214"><span class="linenos">214</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CachedDataLoader-215"><a href="#CachedDataLoader-215"><span class="linenos">215</span></a>
</span><span id="CachedDataLoader-216"><a href="#CachedDataLoader-216"><span class="linenos">216</span></a>        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
</span><span id="CachedDataLoader-217"><a href="#CachedDataLoader-217"><span class="linenos">217</span></a>                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CachedDataLoader-218"><a href="#CachedDataLoader-218"><span class="linenos">218</span></a>                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="CachedDataLoader-219"><a href="#CachedDataLoader-219"><span class="linenos">219</span></a>                      <span class="p">}</span>
</span><span id="CachedDataLoader-220"><a href="#CachedDataLoader-220"><span class="linenos">220</span></a>        
</span><span id="CachedDataLoader-221"><a href="#CachedDataLoader-221"><span class="linenos">221</span></a>        <span class="c1"># read files</span>
</span><span id="CachedDataLoader-222"><a href="#CachedDataLoader-222"><span class="linenos">222</span></a>        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
</span><span id="CachedDataLoader-223"><a href="#CachedDataLoader-223"><span class="linenos">223</span></a>            
</span><span id="CachedDataLoader-224"><a href="#CachedDataLoader-224"><span class="linenos">224</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoader</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="CachedDataLoader-225"><a href="#CachedDataLoader-225"><span class="linenos">225</span></a>                
</span><span id="CachedDataLoader-226"><a href="#CachedDataLoader-226"><span class="linenos">226</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
</span><span id="CachedDataLoader-227"><a href="#CachedDataLoader-227"><span class="linenos">227</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoader-228"><a href="#CachedDataLoader-228"><span class="linenos">228</span></a>            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
</span><span id="CachedDataLoader-229"><a href="#CachedDataLoader-229"><span class="linenos">229</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoader-230"><a href="#CachedDataLoader-230"><span class="linenos">230</span></a>            
</span><span id="CachedDataLoader-231"><a href="#CachedDataLoader-231"><span class="linenos">231</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
</span><span id="CachedDataLoader-232"><a href="#CachedDataLoader-232"><span class="linenos">232</span></a>                 
</span><span id="CachedDataLoader-233"><a href="#CachedDataLoader-233"><span class="linenos">233</span></a>    <span class="nd">@staticmethod</span>
</span><span id="CachedDataLoader-234"><a href="#CachedDataLoader-234"><span class="linenos">234</span></a>    <span class="k">def</span> <span class="nf">read_index</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="CachedDataLoader-235"><a href="#CachedDataLoader-235"><span class="linenos">235</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader-236"><a href="#CachedDataLoader-236"><span class="linenos">236</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader-237"><a href="#CachedDataLoader-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="n">index</span>
</span><span id="CachedDataLoader-238"><a href="#CachedDataLoader-238"><span class="linenos">238</span></a>    
</span><span id="CachedDataLoader-239"><a href="#CachedDataLoader-239"><span class="linenos">239</span></a>    <span class="k">def</span> <span class="nf">_build_sample_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_generator</span><span class="p">):</span>
</span><span id="CachedDataLoader-240"><a href="#CachedDataLoader-240"><span class="linenos">240</span></a>        
</span><span id="CachedDataLoader-241"><a href="#CachedDataLoader-241"><span class="linenos">241</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoader-242"><a href="#CachedDataLoader-242"><span class="linenos">242</span></a>            <span class="c1"># we are alredy have the data needed to create the DataLoader</span>
</span><span id="CachedDataLoader-243"><a href="#CachedDataLoader-243"><span class="linenos">243</span></a>            <span class="c1"># So, let&#39;s build it</span>
</span><span id="CachedDataLoader-244"><a href="#CachedDataLoader-244"><span class="linenos">244</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>
</span><span id="CachedDataLoader-245"><a href="#CachedDataLoader-245"><span class="linenos">245</span></a>                 
</span><span id="CachedDataLoader-246"><a href="#CachedDataLoader-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">):</span>
</span><span id="CachedDataLoader-247"><a href="#CachedDataLoader-247"><span class="linenos">247</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>
</span><span id="CachedDataLoader-248"><a href="#CachedDataLoader-248"><span class="linenos">248</span></a>
</span><span id="CachedDataLoader-249"><a href="#CachedDataLoader-249"><span class="linenos">249</span></a>        <span class="c1"># get path to cache</span>
</span><span id="CachedDataLoader-250"><a href="#CachedDataLoader-250"><span class="linenos">250</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_cache_base_name</span><span class="p">(</span><span class="n">sample_generator</span><span class="p">)</span>
</span><span id="CachedDataLoader-251"><a href="#CachedDataLoader-251"><span class="linenos">251</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_name</span><span class="p">)</span>
</span><span id="CachedDataLoader-252"><a href="#CachedDataLoader-252"><span class="linenos">252</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.index&quot;</span>
</span><span id="CachedDataLoader-253"><a href="#CachedDataLoader-253"><span class="linenos">253</span></a>        
</span><span id="CachedDataLoader-254"><a href="#CachedDataLoader-254"><span class="linenos">254</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
</span><span id="CachedDataLoader-255"><a href="#CachedDataLoader-255"><span class="linenos">255</span></a>             <span class="c1"># build a generator that reads the files from cache</span>
</span><span id="CachedDataLoader-256"><a href="#CachedDataLoader-256"><span class="linenos">256</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataLoader will store the samples in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">, with a max_sample per file of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="si">}</span><span class="s2">, this may take a while&quot;</span><span class="p">)</span>
</span><span id="CachedDataLoader-257"><a href="#CachedDataLoader-257"><span class="linenos">257</span></a>            <span class="c1"># there are no history of a previous generator so we must generate the samples once and then store in cache</span>
</span><span id="CachedDataLoader-258"><a href="#CachedDataLoader-258"><span class="linenos">258</span></a>            <span class="n">generator</span> <span class="o">=</span> <span class="n">sample_generator</span>
</span><span id="CachedDataLoader-259"><a href="#CachedDataLoader-259"><span class="linenos">259</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CachedDataLoader-260"><a href="#CachedDataLoader-260"><span class="linenos">260</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We found a compatible cache file for this DataLoader&quot;</span><span class="p">)</span>
</span><span id="CachedDataLoader-261"><a href="#CachedDataLoader-261"><span class="linenos">261</span></a>            <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CachedDataLoader-262"><a href="#CachedDataLoader-262"><span class="linenos">262</span></a>            
</span><span id="CachedDataLoader-263"><a href="#CachedDataLoader-263"><span class="linenos">263</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_cache_generator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
</span><span id="CachedDataLoader-264"><a href="#CachedDataLoader-264"><span class="linenos">264</span></a>    
</span><span id="CachedDataLoader-265"><a href="#CachedDataLoader-265"><span class="linenos">265</span></a>    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
</span><span id="CachedDataLoader-266"><a href="#CachedDataLoader-266"><span class="linenos">266</span></a>        
</span><span id="CachedDataLoader-267"><a href="#CachedDataLoader-267"><span class="linenos">267</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader-268"><a href="#CachedDataLoader-268"><span class="linenos">268</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader-269"><a href="#CachedDataLoader-269"><span class="linenos">269</span></a>    
</span><span id="CachedDataLoader-270"><a href="#CachedDataLoader-270"><span class="linenos">270</span></a>    <span class="k">def</span> <span class="nf">_build_cache_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="CachedDataLoader-271"><a href="#CachedDataLoader-271"><span class="linenos">271</span></a>        <span class="c1"># first its need to store in cache the samples</span>
</span><span id="CachedDataLoader-272"><a href="#CachedDataLoader-272"><span class="linenos">272</span></a>        <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoader-273"><a href="#CachedDataLoader-273"><span class="linenos">273</span></a>            
</span><span id="CachedDataLoader-274"><a href="#CachedDataLoader-274"><span class="linenos">274</span></a>            <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
</span><span id="CachedDataLoader-275"><a href="#CachedDataLoader-275"><span class="linenos">275</span></a>                          <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="p">,</span>
</span><span id="CachedDataLoader-276"><a href="#CachedDataLoader-276"><span class="linenos">276</span></a>                          <span class="p">}</span>
</span><span id="CachedDataLoader-277"><a href="#CachedDataLoader-277"><span class="linenos">277</span></a>            
</span><span id="CachedDataLoader-278"><a href="#CachedDataLoader-278"><span class="linenos">278</span></a>            <span class="k">def</span> <span class="nf">write_to_file</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
</span><span id="CachedDataLoader-279"><a href="#CachedDataLoader-279"><span class="linenos">279</span></a>                
</span><span id="CachedDataLoader-280"><a href="#CachedDataLoader-280"><span class="linenos">280</span></a>                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">file_id</span><span class="si">:</span><span class="s2">04</span><span class="si">}</span><span class="s2">.part&quot;</span>
</span><span id="CachedDataLoader-281"><a href="#CachedDataLoader-281"><span class="linenos">281</span></a>
</span><span id="CachedDataLoader-282"><a href="#CachedDataLoader-282"><span class="linenos">282</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader-283"><a href="#CachedDataLoader-283"><span class="linenos">283</span></a>                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader-284"><a href="#CachedDataLoader-284"><span class="linenos">284</span></a>                    
</span><span id="CachedDataLoader-285"><a href="#CachedDataLoader-285"><span class="linenos">285</span></a>                <span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="CachedDataLoader-286"><a href="#CachedDataLoader-286"><span class="linenos">286</span></a>            
</span><span id="CachedDataLoader-287"><a href="#CachedDataLoader-287"><span class="linenos">287</span></a>            <span class="n">_temp_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CachedDataLoader-288"><a href="#CachedDataLoader-288"><span class="linenos">288</span></a>            <span class="n">_file_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CachedDataLoader-289"><a href="#CachedDataLoader-289"><span class="linenos">289</span></a>            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CachedDataLoader-290"><a href="#CachedDataLoader-290"><span class="linenos">290</span></a>            
</span><span id="CachedDataLoader-291"><a href="#CachedDataLoader-291"><span class="linenos">291</span></a>            <span class="c1"># TODO: Change the tf section here so that all the tf function launched here can be destroyed</span>
</span><span id="CachedDataLoader-292"><a href="#CachedDataLoader-292"><span class="linenos">292</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting to cache the dataset, this may take a while&quot;</span><span class="p">)</span>
</span><span id="CachedDataLoader-293"><a href="#CachedDataLoader-293"><span class="linenos">293</span></a>            
</span><span id="CachedDataLoader-294"><a href="#CachedDataLoader-294"><span class="linenos">294</span></a>            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">():</span>
</span><span id="CachedDataLoader-295"><a href="#CachedDataLoader-295"><span class="linenos">295</span></a>                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CachedDataLoader-296"><a href="#CachedDataLoader-296"><span class="linenos">296</span></a>                
</span><span id="CachedDataLoader-297"><a href="#CachedDataLoader-297"><span class="linenos">297</span></a>                <span class="n">_temp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="CachedDataLoader-298"><a href="#CachedDataLoader-298"><span class="linenos">298</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_temp_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="p">:</span>
</span><span id="CachedDataLoader-299"><a href="#CachedDataLoader-299"><span class="linenos">299</span></a>                    <span class="c1"># save data to file</span>
</span><span id="CachedDataLoader-300"><a href="#CachedDataLoader-300"><span class="linenos">300</span></a>                    
</span><span id="CachedDataLoader-301"><a href="#CachedDataLoader-301"><span class="linenos">301</span></a>                    <span class="n">write_to_file</span><span class="p">(</span><span class="n">_file_index</span><span class="p">,</span> <span class="n">_temp_data</span><span class="p">,</span> <span class="n">index_info</span><span class="p">)</span>
</span><span id="CachedDataLoader-302"><a href="#CachedDataLoader-302"><span class="linenos">302</span></a>                    
</span><span id="CachedDataLoader-303"><a href="#CachedDataLoader-303"><span class="linenos">303</span></a>                    <span class="c1"># clean up</span>
</span><span id="CachedDataLoader-304"><a href="#CachedDataLoader-304"><span class="linenos">304</span></a>                    <span class="n">_temp_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CachedDataLoader-305"><a href="#CachedDataLoader-305"><span class="linenos">305</span></a>                    <span class="n">_file_index</span><span class="o">+=</span><span class="mi">1</span>
</span><span id="CachedDataLoader-306"><a href="#CachedDataLoader-306"><span class="linenos">306</span></a>            
</span><span id="CachedDataLoader-307"><a href="#CachedDataLoader-307"><span class="linenos">307</span></a>            <span class="c1"># TODO: swap to the main tf session and destroy the previous one</span>
</span><span id="CachedDataLoader-308"><a href="#CachedDataLoader-308"><span class="linenos">308</span></a>            
</span><span id="CachedDataLoader-309"><a href="#CachedDataLoader-309"><span class="linenos">309</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_temp_data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
</span><span id="CachedDataLoader-310"><a href="#CachedDataLoader-310"><span class="linenos">310</span></a>                <span class="c1"># save the reminder data</span>
</span><span id="CachedDataLoader-311"><a href="#CachedDataLoader-311"><span class="linenos">311</span></a>                <span class="n">write_to_file</span><span class="p">(</span><span class="n">_file_index</span><span class="p">,</span> <span class="n">_temp_data</span><span class="p">,</span> <span class="n">index_info</span><span class="p">)</span>
</span><span id="CachedDataLoader-312"><a href="#CachedDataLoader-312"><span class="linenos">312</span></a>            
</span><span id="CachedDataLoader-313"><a href="#CachedDataLoader-313"><span class="linenos">313</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_samples</span>
</span><span id="CachedDataLoader-314"><a href="#CachedDataLoader-314"><span class="linenos">314</span></a>            
</span><span id="CachedDataLoader-315"><a href="#CachedDataLoader-315"><span class="linenos">315</span></a>            <span class="c1"># write the index file</span>
</span><span id="CachedDataLoader-316"><a href="#CachedDataLoader-316"><span class="linenos">316</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">write_index_file</span><span class="p">(</span><span class="n">index_info</span><span class="p">)</span>
</span><span id="CachedDataLoader-317"><a href="#CachedDataLoader-317"><span class="linenos">317</span></a>        
</span><span id="CachedDataLoader-318"><a href="#CachedDataLoader-318"><span class="linenos">318</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoader-319"><a href="#CachedDataLoader-319"><span class="linenos">319</span></a>            <span class="c1"># TODO: make test to see if this thing works</span>
</span><span id="CachedDataLoader-320"><a href="#CachedDataLoader-320"><span class="linenos">320</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing the clean up function after the cached dataset was created&quot;</span><span class="p">)</span>
</span><span id="CachedDataLoader-321"><a href="#CachedDataLoader-321"><span class="linenos">321</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_function</span><span class="p">()</span>
</span><span id="CachedDataLoader-322"><a href="#CachedDataLoader-322"><span class="linenos">322</span></a>        
</span><span id="CachedDataLoader-323"><a href="#CachedDataLoader-323"><span class="linenos">323</span></a>        <span class="c1"># read the index from file</span>
</span><span id="CachedDataLoader-324"><a href="#CachedDataLoader-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="CachedDataLoader-325"><a href="#CachedDataLoader-325"><span class="linenos">325</span></a>        
</span><span id="CachedDataLoader-326"><a href="#CachedDataLoader-326"><span class="linenos">326</span></a>        <span class="c1"># Build the cache generator</span>
</span><span id="CachedDataLoader-327"><a href="#CachedDataLoader-327"><span class="linenos">327</span></a>        
</span><span id="CachedDataLoader-328"><a href="#CachedDataLoader-328"><span class="linenos">328</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>
</span><span id="CachedDataLoader-329"><a href="#CachedDataLoader-329"><span class="linenos">329</span></a>
</span><span id="CachedDataLoader-330"><a href="#CachedDataLoader-330"><span class="linenos">330</span></a>    
</span><span id="CachedDataLoader-331"><a href="#CachedDataLoader-331"><span class="linenos">331</span></a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoader-332"><a href="#CachedDataLoader-332"><span class="linenos">332</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;files&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">:</span>
</span><span id="CachedDataLoader-333"><a href="#CachedDataLoader-333"><span class="linenos">333</span></a>            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]:</span>
</span><span id="CachedDataLoader-334"><a href="#CachedDataLoader-334"><span class="linenos">334</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
</span><span id="CachedDataLoader-335"><a href="#CachedDataLoader-335"><span class="linenos">335</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="CachedDataLoader-336"><a href="#CachedDataLoader-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index_path&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
</span><span id="CachedDataLoader-337"><a href="#CachedDataLoader-337"><span class="linenos">337</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="CachedDataLoader-338"><a href="#CachedDataLoader-338"><span class="linenos">338</span></a>                 
</span><span id="CachedDataLoader-339"><a href="#CachedDataLoader-339"><span class="linenos">339</span></a>    <span class="k">def</span> <span class="nf">__build_generator_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoader-340"><a href="#CachedDataLoader-340"><span class="linenos">340</span></a>        <span class="c1"># set n_samples</span>
</span><span id="CachedDataLoader-341"><a href="#CachedDataLoader-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
</span><span id="CachedDataLoader-342"><a href="#CachedDataLoader-342"><span class="linenos">342</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span>
</span><span id="CachedDataLoader-343"><a href="#CachedDataLoader-343"><span class="linenos">343</span></a>                 
</span><span id="CachedDataLoader-344"><a href="#CachedDataLoader-344"><span class="linenos">344</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of samples in dataset: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="CachedDataLoader-345"><a href="#CachedDataLoader-345"><span class="linenos">345</span></a>        
</span><span id="CachedDataLoader-346"><a href="#CachedDataLoader-346"><span class="linenos">346</span></a>        <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
</span><span id="CachedDataLoader-347"><a href="#CachedDataLoader-347"><span class="linenos">347</span></a>            <span class="n">aux_file_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])))</span>
</span><span id="CachedDataLoader-348"><a href="#CachedDataLoader-348"><span class="linenos">348</span></a>            
</span><span id="CachedDataLoader-349"><a href="#CachedDataLoader-349"><span class="linenos">349</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span><span class="p">:</span>
</span><span id="CachedDataLoader-350"><a href="#CachedDataLoader-350"><span class="linenos">350</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PRE SHUFFLE&quot;</span><span class="p">,</span> <span class="n">aux_file_index</span><span class="p">)</span>
</span><span id="CachedDataLoader-351"><a href="#CachedDataLoader-351"><span class="linenos">351</span></a>                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">aux_file_index</span><span class="p">)</span>
</span><span id="CachedDataLoader-352"><a href="#CachedDataLoader-352"><span class="linenos">352</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;POST SHUFFLE&quot;</span><span class="p">,</span> <span class="n">aux_file_index</span><span class="p">)</span>
</span><span id="CachedDataLoader-353"><a href="#CachedDataLoader-353"><span class="linenos">353</span></a>                
</span><span id="CachedDataLoader-354"><a href="#CachedDataLoader-354"><span class="linenos">354</span></a>            <span class="k">for</span> <span class="n">file_index</span> <span class="ow">in</span> <span class="n">aux_file_index</span><span class="p">:</span>
</span><span id="CachedDataLoader-355"><a href="#CachedDataLoader-355"><span class="linenos">355</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="n">file_index</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader-356"><a href="#CachedDataLoader-356"><span class="linenos">356</span></a>                    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="CachedDataLoader-357"><a href="#CachedDataLoader-357"><span class="linenos">357</span></a>                        <span class="k">yield</span> <span class="n">sample</span>
</span><span id="CachedDataLoader-358"><a href="#CachedDataLoader-358"><span class="linenos">358</span></a>                 
</span><span id="CachedDataLoader-359"><a href="#CachedDataLoader-359"><span class="linenos">359</span></a>        <span class="k">return</span> <span class="n">generator</span>
</span><span id="CachedDataLoader-360"><a href="#CachedDataLoader-360"><span class="linenos">360</span></a>        
</span><span id="CachedDataLoader-361"><a href="#CachedDataLoader-361"><span class="linenos">361</span></a>    <span class="k">def</span> <span class="nf">__build_cache_base_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_generator</span><span class="p">):</span>
</span><span id="CachedDataLoader-362"><a href="#CachedDataLoader-362"><span class="linenos">362</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="CachedDataLoader-363"><a href="#CachedDataLoader-363"><span class="linenos">363</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
</span><span id="CachedDataLoader-364"><a href="#CachedDataLoader-364"><span class="linenos">364</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span><span class="si">}</span><span class="s2">_&quot;</span>
</span><span id="CachedDataLoader-365"><a href="#CachedDataLoader-365"><span class="linenos">365</span></a>            
</span><span id="CachedDataLoader-366"><a href="#CachedDataLoader-366"><span class="linenos">366</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_chunk</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sample_generator</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="CachedDataLoader-367"><a href="#CachedDataLoader-367"><span class="linenos">367</span></a>    
</span><span id="CachedDataLoader-368"><a href="#CachedDataLoader-368"><span class="linenos">368</span></a>    
</span><span id="CachedDataLoader-369"><a href="#CachedDataLoader-369"><span class="linenos">369</span></a>    <span class="k">def</span> <span class="nf">pre_shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoader-370"><a href="#CachedDataLoader-370"><span class="linenos">370</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CachedDataLoader-371"><a href="#CachedDataLoader-371"><span class="linenos">371</span></a><span class="sd">        The order of the cached files will be readed in a random order</span>
</span><span id="CachedDataLoader-372"><a href="#CachedDataLoader-372"><span class="linenos">372</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CachedDataLoader-373"><a href="#CachedDataLoader-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CachedDataLoader-374"><a href="#CachedDataLoader-374"><span class="linenos">374</span></a>        
</span><span id="CachedDataLoader-375"><a href="#CachedDataLoader-375"><span class="linenos">375</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="CachedDataLoader-376"><a href="#CachedDataLoader-376"><span class="linenos">376</span></a>    
</span><span id="CachedDataLoader-377"><a href="#CachedDataLoader-377"><span class="linenos">377</span></a>    <span class="k">def</span> <span class="nf">add_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_object</span><span class="p">):</span>
</span><span id="CachedDataLoader-378"><a href="#CachedDataLoader-378"><span class="linenos">378</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CachedDataLoader-379"><a href="#CachedDataLoader-379"><span class="linenos">379</span></a><span class="sd">        Converts a CachedDataLoarder to a CachedDataLoaderwLookup</span>
</span><span id="CachedDataLoader-380"><a href="#CachedDataLoader-380"><span class="linenos">380</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CachedDataLoader-381"><a href="#CachedDataLoader-381"><span class="linenos">381</span></a>        <span class="n">cache_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CachedDataLoader-382"><a href="#CachedDataLoader-382"><span class="linenos">382</span></a>        
</span><span id="CachedDataLoader-383"><a href="#CachedDataLoader-383"><span class="linenos">383</span></a>        <span class="c1">## manually add lookup_data to the index</span>
</span><span id="CachedDataLoader-384"><a href="#CachedDataLoader-384"><span class="linenos">384</span></a>        <span class="n">lookup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.lookup&quot;</span>
</span><span id="CachedDataLoader-385"><a href="#CachedDataLoader-385"><span class="linenos">385</span></a>        
</span><span id="CachedDataLoader-386"><a href="#CachedDataLoader-386"><span class="linenos">386</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader-387"><a href="#CachedDataLoader-387"><span class="linenos">387</span></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">lookup_object</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader-388"><a href="#CachedDataLoader-388"><span class="linenos">388</span></a>            
</span><span id="CachedDataLoader-389"><a href="#CachedDataLoader-389"><span class="linenos">389</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_lookup_data_path</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">)</span>
</span><span id="CachedDataLoader-390"><a href="#CachedDataLoader-390"><span class="linenos">390</span></a>            
</span><span id="CachedDataLoader-391"><a href="#CachedDataLoader-391"><span class="linenos">391</span></a>    <span class="k">def</span> <span class="nf">add_lookup_data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_data_path</span><span class="p">):</span>
</span><span id="CachedDataLoader-392"><a href="#CachedDataLoader-392"><span class="linenos">392</span></a>        
</span><span id="CachedDataLoader-393"><a href="#CachedDataLoader-393"><span class="linenos">393</span></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lookup_data_path</span><span class="p">)</span>
</span><span id="CachedDataLoader-394"><a href="#CachedDataLoader-394"><span class="linenos">394</span></a>        
</span><span id="CachedDataLoader-395"><a href="#CachedDataLoader-395"><span class="linenos">395</span></a>        <span class="c1"># modify the index</span>
</span><span id="CachedDataLoader-396"><a href="#CachedDataLoader-396"><span class="linenos">396</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_data_path</span>
</span><span id="CachedDataLoader-397"><a href="#CachedDataLoader-397"><span class="linenos">397</span></a>        
</span><span id="CachedDataLoader-398"><a href="#CachedDataLoader-398"><span class="linenos">398</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader-399"><a href="#CachedDataLoader-399"><span class="linenos">399</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader-400"><a href="#CachedDataLoader-400"><span class="linenos">400</span></a>            
</span><span id="CachedDataLoader-401"><a href="#CachedDataLoader-401"><span class="linenos">401</span></a>        <span class="k">return</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">from_cached_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="CachedDataLoader-402"><a href="#CachedDataLoader-402"><span class="linenos">402</span></a>    
</span><span id="CachedDataLoader-403"><a href="#CachedDataLoader-403"><span class="linenos">403</span></a>    <span class="k">def</span> <span class="nf">deep_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CachedDataLoader-404"><a href="#CachedDataLoader-404"><span class="linenos">404</span></a>        
</span><span id="CachedDataLoader-405"><a href="#CachedDataLoader-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoader-406"><a href="#CachedDataLoader-406"><span class="linenos">406</span></a>            <span class="n">sufix</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span> <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">suffix</span>
</span><span id="CachedDataLoader-407"><a href="#CachedDataLoader-407"><span class="linenos">407</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.index&quot;</span>
</span><span id="CachedDataLoader-408"><a href="#CachedDataLoader-408"><span class="linenos">408</span></a>            
</span><span id="CachedDataLoader-409"><a href="#CachedDataLoader-409"><span class="linenos">409</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader-410"><a href="#CachedDataLoader-410"><span class="linenos">410</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader-411"><a href="#CachedDataLoader-411"><span class="linenos">411</span></a>        
</span><span id="CachedDataLoader-412"><a href="#CachedDataLoader-412"><span class="linenos">412</span></a>        <span class="c1"># update the path to the current index file</span>
</span><span id="CachedDataLoader-413"><a href="#CachedDataLoader-413"><span class="linenos">413</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="n">path</span>
</span></pre></div>


            <div class="docstring"><p>Extension of a the DataLoader class that adds the ability to seamlessly
store the preprocessed samples in the disk, following a chunking mechanism. Besides the
organizational advantage, this also enables us to implement a <em>pre_shuffle</em> mechanism
that occurs at the chunk level, making it a must more efficient process since we can
fully shuffle the dataset without the need to have its memory. of a data loader
that builds higly efficient datasets (<em>tf.data.Dataset</em>) from full python generators.</p>

<p>Since this class involves the storage of files on disk, if any exception is raised, the
DataLoader will automatically clean all the created files before raising the exception
to the user.</p>
</div>


                            <div id="CachedDataLoader.__init__" class="classattr">
                                        <input id="CachedDataLoader.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CachedDataLoader</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">sample_generator</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">clean_up_function</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">cache_additional_identifier</span><span class="o">=</span><span class="s1">&#39;&#39;</span>,</span><span class="param">	<span class="n">cache_chunk_size</span><span class="o">=</span><span class="mi">8192</span>,</span><span class="param">	<span class="n">cache_folder</span><span class="o">=</span><span class="s1">&#39;.polus_cache/data&#39;</span>,</span><span class="param">	<span class="n">cache_index</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.__init__-154"><a href="#CachedDataLoader.__init__-154"><span class="linenos">154</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CachedDataLoader.__init__-155"><a href="#CachedDataLoader.__init__-155"><span class="linenos">155</span></a>                 <span class="n">sample_generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CachedDataLoader.__init__-156"><a href="#CachedDataLoader.__init__-156"><span class="linenos">156</span></a>                 <span class="n">clean_up_function</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="CachedDataLoader.__init__-157"><a href="#CachedDataLoader.__init__-157"><span class="linenos">157</span></a>                 <span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="CachedDataLoader.__init__-158"><a href="#CachedDataLoader.__init__-158"><span class="linenos">158</span></a>                 <span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
</span><span id="CachedDataLoader.__init__-159"><a href="#CachedDataLoader.__init__-159"><span class="linenos">159</span></a>                 <span class="n">cache_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.polus_cache&quot;</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
</span><span id="CachedDataLoader.__init__-160"><a href="#CachedDataLoader.__init__-160"><span class="linenos">160</span></a>                 <span class="n">cache_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
</span><span id="CachedDataLoader.__init__-161"><a href="#CachedDataLoader.__init__-161"><span class="linenos">161</span></a>                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="CachedDataLoader.__init__-162"><a href="#CachedDataLoader.__init__-162"><span class="linenos">162</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CachedDataLoader.__init__-163"><a href="#CachedDataLoader.__init__-163"><span class="linenos">163</span></a><span class="sd">        </span>
</span><span id="CachedDataLoader.__init__-164"><a href="#CachedDataLoader.__init__-164"><span class="linenos">164</span></a><span class="sd">        Args:</span>
</span><span id="CachedDataLoader.__init__-165"><a href="#CachedDataLoader.__init__-165"><span class="linenos">165</span></a><span class="sd">          source_generator (python generator): Same as in `polus.data.DataLoader`</span>
</span><span id="CachedDataLoader.__init__-166"><a href="#CachedDataLoader.__init__-166"><span class="linenos">166</span></a><span class="sd">          </span>
</span><span id="CachedDataLoader.__init__-167"><a href="#CachedDataLoader.__init__-167"><span class="linenos">167</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CachedDataLoader.__init__-168"><a href="#CachedDataLoader.__init__-168"><span class="linenos">168</span></a>        <span class="c1"># impossible condition</span>
</span><span id="CachedDataLoader.__init__-169"><a href="#CachedDataLoader.__init__-169"><span class="linenos">169</span></a>        <span class="k">assert</span> <span class="n">sample_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="CachedDataLoader.__init__-170"><a href="#CachedDataLoader.__init__-170"><span class="linenos">170</span></a>
</span><span id="CachedDataLoader.__init__-171"><a href="#CachedDataLoader.__init__-171"><span class="linenos">171</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="o">=</span> <span class="n">cache_folder</span>
</span><span id="CachedDataLoader.__init__-172"><a href="#CachedDataLoader.__init__-172"><span class="linenos">172</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="n">cache_chunk_size</span>
</span><span id="CachedDataLoader.__init__-173"><a href="#CachedDataLoader.__init__-173"><span class="linenos">173</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="n">cache_additional_identifier</span>
</span><span id="CachedDataLoader.__init__-174"><a href="#CachedDataLoader.__init__-174"><span class="linenos">174</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="CachedDataLoader.__init__-175"><a href="#CachedDataLoader.__init__-175"><span class="linenos">175</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_function</span> <span class="o">=</span> <span class="n">clean_up_function</span>
</span><span id="CachedDataLoader.__init__-176"><a href="#CachedDataLoader.__init__-176"><span class="linenos">176</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache_index</span>
</span><span id="CachedDataLoader.__init__-177"><a href="#CachedDataLoader.__init__-177"><span class="linenos">177</span></a>        
</span><span id="CachedDataLoader.__init__-178"><a href="#CachedDataLoader.__init__-178"><span class="linenos">178</span></a>        <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;cache_index_path&quot;</span> <span class="ow">in</span> <span class="n">cache_index</span><span class="p">:</span>
</span><span id="CachedDataLoader.__init__-179"><a href="#CachedDataLoader.__init__-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;cache_index_path&quot;</span><span class="p">]</span>
</span><span id="CachedDataLoader.__init__-180"><a href="#CachedDataLoader.__init__-180"><span class="linenos">180</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CachedDataLoader.__init__-181"><a href="#CachedDataLoader.__init__-181"><span class="linenos">181</span></a>            <span class="c1"># this dataset probably do not have a cache_index_path, this can happen if the DataLoader was created</span>
</span><span id="CachedDataLoader.__init__-182"><a href="#CachedDataLoader.__init__-182"><span class="linenos">182</span></a>            <span class="c1"># from merge of multiple DataLoader</span>
</span><span id="CachedDataLoader.__init__-183"><a href="#CachedDataLoader.__init__-183"><span class="linenos">183</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="CachedDataLoader.__init__-184"><a href="#CachedDataLoader.__init__-184"><span class="linenos">184</span></a>
</span><span id="CachedDataLoader.__init__-185"><a href="#CachedDataLoader.__init__-185"><span class="linenos">185</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="CachedDataLoader.__init__-186"><a href="#CachedDataLoader.__init__-186"><span class="linenos">186</span></a>            <span class="n">sample_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_sample_generator</span><span class="p">(</span><span class="n">sample_generator</span><span class="p">)</span>
</span><span id="CachedDataLoader.__init__-187"><a href="#CachedDataLoader.__init__-187"><span class="linenos">187</span></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sample_generator</span> <span class="o">=</span> <span class="n">sample_generator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="CachedDataLoader.__init__-188"><a href="#CachedDataLoader.__init__-188"><span class="linenos">188</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="CachedDataLoader.__init__-189"><a href="#CachedDataLoader.__init__-189"><span class="linenos">189</span></a>            
</span><span id="CachedDataLoader.__init__-190"><a href="#CachedDataLoader.__init__-190"><span class="linenos">190</span></a>            <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoader.__init__-191"><a href="#CachedDataLoader.__init__-191"><span class="linenos">191</span></a>                <span class="c1"># here we dont want to solve the exception, we just want to clean up de previously created files</span>
</span><span id="CachedDataLoader.__init__-192"><a href="#CachedDataLoader.__init__-192"><span class="linenos">192</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An error has occured so all the created files will be deleted&quot;</span><span class="p">)</span>
</span><span id="CachedDataLoader.__init__-193"><a href="#CachedDataLoader.__init__-193"><span class="linenos">193</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
</span><span id="CachedDataLoader.__init__-194"><a href="#CachedDataLoader.__init__-194"><span class="linenos">194</span></a>            <span class="k">raise</span> <span class="n">e</span>
</span></pre></div>


            <div class="docstring"><h6 id="args">Args</h6>

<ul>
<li><strong>source_generator (python generator):</strong>  Same as in <code><a href="#DataLoader">polus.data.DataLoader</a></code></li>
</ul>
</div>


                            </div>
                            <div id="CachedDataLoader.from_cached_index" class="classattr">
                                        <input id="CachedDataLoader.from_cached_index-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_cached_index</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">index_path</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.from_cached_index-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.from_cached_index"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.from_cached_index-204"><a href="#CachedDataLoader.from_cached_index-204"><span class="linenos">204</span></a>    <span class="nd">@classmethod</span>
</span><span id="CachedDataLoader.from_cached_index-205"><a href="#CachedDataLoader.from_cached_index-205"><span class="linenos">205</span></a>    <span class="k">def</span> <span class="nf">from_cached_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">index_path</span><span class="p">):</span>
</span><span id="CachedDataLoader.from_cached_index-206"><a href="#CachedDataLoader.from_cached_index-206"><span class="linenos">206</span></a>        
</span><span id="CachedDataLoader.from_cached_index-207"><a href="#CachedDataLoader.from_cached_index-207"><span class="linenos">207</span></a>        <span class="n">index_info</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">index_path</span><span class="p">)</span>
</span><span id="CachedDataLoader.from_cached_index-208"><a href="#CachedDataLoader.from_cached_index-208"><span class="linenos">208</span></a>        <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_index_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_path</span>
</span><span id="CachedDataLoader.from_cached_index-209"><a href="#CachedDataLoader.from_cached_index-209"><span class="linenos">209</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="CachedDataLoader.merge" class="classattr">
                                        <input id="CachedDataLoader.merge-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">merge</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="o">*</span><span class="n">cache_dataloaders</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.merge-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.merge"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.merge-212"><a href="#CachedDataLoader.merge-212"><span class="linenos">212</span></a>    <span class="nd">@classmethod</span>
</span><span id="CachedDataLoader.merge-213"><a href="#CachedDataLoader.merge-213"><span class="linenos">213</span></a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
</span><span id="CachedDataLoader.merge-214"><a href="#CachedDataLoader.merge-214"><span class="linenos">214</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CachedDataLoader.merge-215"><a href="#CachedDataLoader.merge-215"><span class="linenos">215</span></a>
</span><span id="CachedDataLoader.merge-216"><a href="#CachedDataLoader.merge-216"><span class="linenos">216</span></a>        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
</span><span id="CachedDataLoader.merge-217"><a href="#CachedDataLoader.merge-217"><span class="linenos">217</span></a>                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CachedDataLoader.merge-218"><a href="#CachedDataLoader.merge-218"><span class="linenos">218</span></a>                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="CachedDataLoader.merge-219"><a href="#CachedDataLoader.merge-219"><span class="linenos">219</span></a>                      <span class="p">}</span>
</span><span id="CachedDataLoader.merge-220"><a href="#CachedDataLoader.merge-220"><span class="linenos">220</span></a>        
</span><span id="CachedDataLoader.merge-221"><a href="#CachedDataLoader.merge-221"><span class="linenos">221</span></a>        <span class="c1"># read files</span>
</span><span id="CachedDataLoader.merge-222"><a href="#CachedDataLoader.merge-222"><span class="linenos">222</span></a>        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
</span><span id="CachedDataLoader.merge-223"><a href="#CachedDataLoader.merge-223"><span class="linenos">223</span></a>            
</span><span id="CachedDataLoader.merge-224"><a href="#CachedDataLoader.merge-224"><span class="linenos">224</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoader</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="CachedDataLoader.merge-225"><a href="#CachedDataLoader.merge-225"><span class="linenos">225</span></a>                
</span><span id="CachedDataLoader.merge-226"><a href="#CachedDataLoader.merge-226"><span class="linenos">226</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
</span><span id="CachedDataLoader.merge-227"><a href="#CachedDataLoader.merge-227"><span class="linenos">227</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoader.merge-228"><a href="#CachedDataLoader.merge-228"><span class="linenos">228</span></a>            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
</span><span id="CachedDataLoader.merge-229"><a href="#CachedDataLoader.merge-229"><span class="linenos">229</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoader.merge-230"><a href="#CachedDataLoader.merge-230"><span class="linenos">230</span></a>            
</span><span id="CachedDataLoader.merge-231"><a href="#CachedDataLoader.merge-231"><span class="linenos">231</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="CachedDataLoader.read_index" class="classattr">
                                        <input id="CachedDataLoader.read_index-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">read_index</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">file_path</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.read_index-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.read_index"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.read_index-233"><a href="#CachedDataLoader.read_index-233"><span class="linenos">233</span></a>    <span class="nd">@staticmethod</span>
</span><span id="CachedDataLoader.read_index-234"><a href="#CachedDataLoader.read_index-234"><span class="linenos">234</span></a>    <span class="k">def</span> <span class="nf">read_index</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
</span><span id="CachedDataLoader.read_index-235"><a href="#CachedDataLoader.read_index-235"><span class="linenos">235</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader.read_index-236"><a href="#CachedDataLoader.read_index-236"><span class="linenos">236</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader.read_index-237"><a href="#CachedDataLoader.read_index-237"><span class="linenos">237</span></a>        <span class="k">return</span> <span class="n">index</span>
</span></pre></div>


    

                            </div>
                            <div id="CachedDataLoader.write_index_file" class="classattr">
                                        <input id="CachedDataLoader.write_index_file-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">write_index_file</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">index_info</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.write_index_file-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.write_index_file"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.write_index_file-265"><a href="#CachedDataLoader.write_index_file-265"><span class="linenos">265</span></a>    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
</span><span id="CachedDataLoader.write_index_file-266"><a href="#CachedDataLoader.write_index_file-266"><span class="linenos">266</span></a>        
</span><span id="CachedDataLoader.write_index_file-267"><a href="#CachedDataLoader.write_index_file-267"><span class="linenos">267</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader.write_index_file-268"><a href="#CachedDataLoader.write_index_file-268"><span class="linenos">268</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="CachedDataLoader.clean" class="classattr">
                                        <input id="CachedDataLoader.clean-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clean</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.clean-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.clean"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.clean-331"><a href="#CachedDataLoader.clean-331"><span class="linenos">331</span></a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoader.clean-332"><a href="#CachedDataLoader.clean-332"><span class="linenos">332</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;files&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">:</span>
</span><span id="CachedDataLoader.clean-333"><a href="#CachedDataLoader.clean-333"><span class="linenos">333</span></a>            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]:</span>
</span><span id="CachedDataLoader.clean-334"><a href="#CachedDataLoader.clean-334"><span class="linenos">334</span></a>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
</span><span id="CachedDataLoader.clean-335"><a href="#CachedDataLoader.clean-335"><span class="linenos">335</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="CachedDataLoader.clean-336"><a href="#CachedDataLoader.clean-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index_path&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
</span><span id="CachedDataLoader.clean-337"><a href="#CachedDataLoader.clean-337"><span class="linenos">337</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="CachedDataLoader.pre_shuffle" class="classattr">
                                        <input id="CachedDataLoader.pre_shuffle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pre_shuffle</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.pre_shuffle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.pre_shuffle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.pre_shuffle-369"><a href="#CachedDataLoader.pre_shuffle-369"><span class="linenos">369</span></a>    <span class="k">def</span> <span class="nf">pre_shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoader.pre_shuffle-370"><a href="#CachedDataLoader.pre_shuffle-370"><span class="linenos">370</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CachedDataLoader.pre_shuffle-371"><a href="#CachedDataLoader.pre_shuffle-371"><span class="linenos">371</span></a><span class="sd">        The order of the cached files will be readed in a random order</span>
</span><span id="CachedDataLoader.pre_shuffle-372"><a href="#CachedDataLoader.pre_shuffle-372"><span class="linenos">372</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CachedDataLoader.pre_shuffle-373"><a href="#CachedDataLoader.pre_shuffle-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="CachedDataLoader.pre_shuffle-374"><a href="#CachedDataLoader.pre_shuffle-374"><span class="linenos">374</span></a>        
</span><span id="CachedDataLoader.pre_shuffle-375"><a href="#CachedDataLoader.pre_shuffle-375"><span class="linenos">375</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>The order of the cached files will be readed in a random order</p>
</div>


                            </div>
                            <div id="CachedDataLoader.add_lookup_data" class="classattr">
                                        <input id="CachedDataLoader.add_lookup_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_lookup_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lookup_object</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.add_lookup_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.add_lookup_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.add_lookup_data-377"><a href="#CachedDataLoader.add_lookup_data-377"><span class="linenos">377</span></a>    <span class="k">def</span> <span class="nf">add_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_object</span><span class="p">):</span>
</span><span id="CachedDataLoader.add_lookup_data-378"><a href="#CachedDataLoader.add_lookup_data-378"><span class="linenos">378</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CachedDataLoader.add_lookup_data-379"><a href="#CachedDataLoader.add_lookup_data-379"><span class="linenos">379</span></a><span class="sd">        Converts a CachedDataLoarder to a CachedDataLoaderwLookup</span>
</span><span id="CachedDataLoader.add_lookup_data-380"><a href="#CachedDataLoader.add_lookup_data-380"><span class="linenos">380</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="CachedDataLoader.add_lookup_data-381"><a href="#CachedDataLoader.add_lookup_data-381"><span class="linenos">381</span></a>        <span class="n">cache_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="CachedDataLoader.add_lookup_data-382"><a href="#CachedDataLoader.add_lookup_data-382"><span class="linenos">382</span></a>        
</span><span id="CachedDataLoader.add_lookup_data-383"><a href="#CachedDataLoader.add_lookup_data-383"><span class="linenos">383</span></a>        <span class="c1">## manually add lookup_data to the index</span>
</span><span id="CachedDataLoader.add_lookup_data-384"><a href="#CachedDataLoader.add_lookup_data-384"><span class="linenos">384</span></a>        <span class="n">lookup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.lookup&quot;</span>
</span><span id="CachedDataLoader.add_lookup_data-385"><a href="#CachedDataLoader.add_lookup_data-385"><span class="linenos">385</span></a>        
</span><span id="CachedDataLoader.add_lookup_data-386"><a href="#CachedDataLoader.add_lookup_data-386"><span class="linenos">386</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader.add_lookup_data-387"><a href="#CachedDataLoader.add_lookup_data-387"><span class="linenos">387</span></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">lookup_object</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader.add_lookup_data-388"><a href="#CachedDataLoader.add_lookup_data-388"><span class="linenos">388</span></a>            
</span><span id="CachedDataLoader.add_lookup_data-389"><a href="#CachedDataLoader.add_lookup_data-389"><span class="linenos">389</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_lookup_data_path</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Converts a CachedDataLoarder to a CachedDataLoaderwLookup</p>
</div>


                            </div>
                            <div id="CachedDataLoader.add_lookup_data_path" class="classattr">
                                        <input id="CachedDataLoader.add_lookup_data_path-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_lookup_data_path</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lookup_data_path</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.add_lookup_data_path-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.add_lookup_data_path"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.add_lookup_data_path-391"><a href="#CachedDataLoader.add_lookup_data_path-391"><span class="linenos">391</span></a>    <span class="k">def</span> <span class="nf">add_lookup_data_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_data_path</span><span class="p">):</span>
</span><span id="CachedDataLoader.add_lookup_data_path-392"><a href="#CachedDataLoader.add_lookup_data_path-392"><span class="linenos">392</span></a>        
</span><span id="CachedDataLoader.add_lookup_data_path-393"><a href="#CachedDataLoader.add_lookup_data_path-393"><span class="linenos">393</span></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">lookup_data_path</span><span class="p">)</span>
</span><span id="CachedDataLoader.add_lookup_data_path-394"><a href="#CachedDataLoader.add_lookup_data_path-394"><span class="linenos">394</span></a>        
</span><span id="CachedDataLoader.add_lookup_data_path-395"><a href="#CachedDataLoader.add_lookup_data_path-395"><span class="linenos">395</span></a>        <span class="c1"># modify the index</span>
</span><span id="CachedDataLoader.add_lookup_data_path-396"><a href="#CachedDataLoader.add_lookup_data_path-396"><span class="linenos">396</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_data_path</span>
</span><span id="CachedDataLoader.add_lookup_data_path-397"><a href="#CachedDataLoader.add_lookup_data_path-397"><span class="linenos">397</span></a>        
</span><span id="CachedDataLoader.add_lookup_data_path-398"><a href="#CachedDataLoader.add_lookup_data_path-398"><span class="linenos">398</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader.add_lookup_data_path-399"><a href="#CachedDataLoader.add_lookup_data_path-399"><span class="linenos">399</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader.add_lookup_data_path-400"><a href="#CachedDataLoader.add_lookup_data_path-400"><span class="linenos">400</span></a>            
</span><span id="CachedDataLoader.add_lookup_data_path-401"><a href="#CachedDataLoader.add_lookup_data_path-401"><span class="linenos">401</span></a>        <span class="k">return</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">from_cached_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="CachedDataLoader.deep_copy" class="classattr">
                                        <input id="CachedDataLoader.deep_copy-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">deep_copy</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">path</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">suffix</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoader.deep_copy-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoader.deep_copy"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoader.deep_copy-403"><a href="#CachedDataLoader.deep_copy-403"><span class="linenos">403</span></a>    <span class="k">def</span> <span class="nf">deep_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="CachedDataLoader.deep_copy-404"><a href="#CachedDataLoader.deep_copy-404"><span class="linenos">404</span></a>        
</span><span id="CachedDataLoader.deep_copy-405"><a href="#CachedDataLoader.deep_copy-405"><span class="linenos">405</span></a>        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoader.deep_copy-406"><a href="#CachedDataLoader.deep_copy-406"><span class="linenos">406</span></a>            <span class="n">sufix</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span> <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">suffix</span>
</span><span id="CachedDataLoader.deep_copy-407"><a href="#CachedDataLoader.deep_copy-407"><span class="linenos">407</span></a>            <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.index&quot;</span>
</span><span id="CachedDataLoader.deep_copy-408"><a href="#CachedDataLoader.deep_copy-408"><span class="linenos">408</span></a>            
</span><span id="CachedDataLoader.deep_copy-409"><a href="#CachedDataLoader.deep_copy-409"><span class="linenos">409</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoader.deep_copy-410"><a href="#CachedDataLoader.deep_copy-410"><span class="linenos">410</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoader.deep_copy-411"><a href="#CachedDataLoader.deep_copy-411"><span class="linenos">411</span></a>        
</span><span id="CachedDataLoader.deep_copy-412"><a href="#CachedDataLoader.deep_copy-412"><span class="linenos">412</span></a>        <span class="c1"># update the path to the current index file</span>
</span><span id="CachedDataLoader.deep_copy-413"><a href="#CachedDataLoader.deep_copy-413"><span class="linenos">413</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="n">path</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#DataLoader">DataLoader</a></dt>
                                <dd id="CachedDataLoader.to_tfDataset" class="function"><a href="#DataLoader.to_tfDataset">to_tfDataset</a></dd>
                <dd id="CachedDataLoader.set_name" class="function"><a href="#DataLoader.set_name">set_name</a></dd>
                <dd id="CachedDataLoader.get_n_samples" class="function"><a href="#DataLoader.get_n_samples">get_n_samples</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="CachedDataLoaderwLookup">
                            <input id="CachedDataLoaderwLookup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CachedDataLoaderwLookup</span><wbr>(<span class="base"><a href="#CachedDataLoader">CachedDataLoader</a></span>):

                <label class="view-source-button" for="CachedDataLoaderwLookup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoaderwLookup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoaderwLookup-416"><a href="#CachedDataLoaderwLookup-416"><span class="linenos">416</span></a><span class="k">class</span> <span class="nc">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">CachedDataLoader</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup-417"><a href="#CachedDataLoaderwLookup-417"><span class="linenos">417</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="CachedDataLoaderwLookup-418"><a href="#CachedDataLoaderwLookup-418"><span class="linenos">418</span></a><span class="sd">    Correspond to a CachedDataLoader but also keeps track of an aditional lookup file</span>
</span><span id="CachedDataLoaderwLookup-419"><a href="#CachedDataLoaderwLookup-419"><span class="linenos">419</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CachedDataLoaderwLookup-420"><a href="#CachedDataLoaderwLookup-420"><span class="linenos">420</span></a>    
</span><span id="CachedDataLoaderwLookup-421"><a href="#CachedDataLoaderwLookup-421"><span class="linenos">421</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup-422"><a href="#CachedDataLoaderwLookup-422"><span class="linenos">422</span></a>                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup-423"><a href="#CachedDataLoaderwLookup-423"><span class="linenos">423</span></a>                 <span class="n">lookup_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup-424"><a href="#CachedDataLoaderwLookup-424"><span class="linenos">424</span></a>                 <span class="n">cache_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
</span><span id="CachedDataLoaderwLookup-425"><a href="#CachedDataLoaderwLookup-425"><span class="linenos">425</span></a>                 <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup-426"><a href="#CachedDataLoaderwLookup-426"><span class="linenos">426</span></a>                <span class="p">):</span>
</span><span id="CachedDataLoaderwLookup-427"><a href="#CachedDataLoaderwLookup-427"><span class="linenos">427</span></a>        
</span><span id="CachedDataLoaderwLookup-428"><a href="#CachedDataLoaderwLookup-428"><span class="linenos">428</span></a>        <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="n">cache_index</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup-429"><a href="#CachedDataLoaderwLookup-429"><span class="linenos">429</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup-430"><a href="#CachedDataLoaderwLookup-430"><span class="linenos">430</span></a>                <span class="n">lookup_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup-431"><a href="#CachedDataLoaderwLookup-431"><span class="linenos">431</span></a>        
</span><span id="CachedDataLoaderwLookup-432"><a href="#CachedDataLoaderwLookup-432"><span class="linenos">432</span></a>        <span class="k">if</span> <span class="n">lookup_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup-433"><a href="#CachedDataLoaderwLookup-433"><span class="linenos">433</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Do not use CachedDataLoaderwLookup without setting a lookup_data, instead use CachedDataLoader&quot;</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup-434"><a href="#CachedDataLoaderwLookup-434"><span class="linenos">434</span></a>        
</span><span id="CachedDataLoaderwLookup-435"><a href="#CachedDataLoaderwLookup-435"><span class="linenos">435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">lookup_data</span>
</span><span id="CachedDataLoaderwLookup-436"><a href="#CachedDataLoaderwLookup-436"><span class="linenos">436</span></a>        
</span><span id="CachedDataLoaderwLookup-437"><a href="#CachedDataLoaderwLookup-437"><span class="linenos">437</span></a>        <span class="c1"># the parent DataLoader will call _build_sample_generator that contains the logic to build the dataloader</span>
</span><span id="CachedDataLoaderwLookup-438"><a href="#CachedDataLoaderwLookup-438"><span class="linenos">438</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cache_index</span><span class="o">=</span><span class="n">cache_index</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup-439"><a href="#CachedDataLoaderwLookup-439"><span class="linenos">439</span></a>        
</span><span id="CachedDataLoaderwLookup-440"><a href="#CachedDataLoaderwLookup-440"><span class="linenos">440</span></a>    <span class="k">def</span> <span class="nf">get_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup-441"><a href="#CachedDataLoaderwLookup-441"><span class="linenos">441</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span>
</span><span id="CachedDataLoaderwLookup-442"><a href="#CachedDataLoaderwLookup-442"><span class="linenos">442</span></a>    
</span><span id="CachedDataLoaderwLookup-443"><a href="#CachedDataLoaderwLookup-443"><span class="linenos">443</span></a>    <span class="nd">@staticmethod</span>
</span><span id="CachedDataLoaderwLookup-444"><a href="#CachedDataLoaderwLookup-444"><span class="linenos">444</span></a>    <span class="k">def</span> <span class="nf">_load_lookup_data</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup-445"><a href="#CachedDataLoaderwLookup-445"><span class="linenos">445</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup-446"><a href="#CachedDataLoaderwLookup-446"><span class="linenos">446</span></a>            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup-447"><a href="#CachedDataLoaderwLookup-447"><span class="linenos">447</span></a>    
</span><span id="CachedDataLoaderwLookup-448"><a href="#CachedDataLoaderwLookup-448"><span class="linenos">448</span></a>    <span class="nd">@classmethod</span>
</span><span id="CachedDataLoaderwLookup-449"><a href="#CachedDataLoaderwLookup-449"><span class="linenos">449</span></a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup-450"><a href="#CachedDataLoaderwLookup-450"><span class="linenos">450</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup-451"><a href="#CachedDataLoaderwLookup-451"><span class="linenos">451</span></a>
</span><span id="CachedDataLoaderwLookup-452"><a href="#CachedDataLoaderwLookup-452"><span class="linenos">452</span></a>        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
</span><span id="CachedDataLoaderwLookup-453"><a href="#CachedDataLoaderwLookup-453"><span class="linenos">453</span></a>                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup-454"><a href="#CachedDataLoaderwLookup-454"><span class="linenos">454</span></a>                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="CachedDataLoaderwLookup-455"><a href="#CachedDataLoaderwLookup-455"><span class="linenos">455</span></a>                      <span class="p">}</span>
</span><span id="CachedDataLoaderwLookup-456"><a href="#CachedDataLoaderwLookup-456"><span class="linenos">456</span></a>        
</span><span id="CachedDataLoaderwLookup-457"><a href="#CachedDataLoaderwLookup-457"><span class="linenos">457</span></a>        <span class="n">lookup_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CachedDataLoaderwLookup-458"><a href="#CachedDataLoaderwLookup-458"><span class="linenos">458</span></a>        
</span><span id="CachedDataLoaderwLookup-459"><a href="#CachedDataLoaderwLookup-459"><span class="linenos">459</span></a>        <span class="c1"># read files</span>
</span><span id="CachedDataLoaderwLookup-460"><a href="#CachedDataLoaderwLookup-460"><span class="linenos">460</span></a>        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup-461"><a href="#CachedDataLoaderwLookup-461"><span class="linenos">461</span></a>            
</span><span id="CachedDataLoaderwLookup-462"><a href="#CachedDataLoaderwLookup-462"><span class="linenos">462</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup-463"><a href="#CachedDataLoaderwLookup-463"><span class="linenos">463</span></a>                
</span><span id="CachedDataLoaderwLookup-464"><a href="#CachedDataLoaderwLookup-464"><span class="linenos">464</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
</span><span id="CachedDataLoaderwLookup-465"><a href="#CachedDataLoaderwLookup-465"><span class="linenos">465</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoaderwLookup-466"><a href="#CachedDataLoaderwLookup-466"><span class="linenos">466</span></a>            
</span><span id="CachedDataLoaderwLookup-467"><a href="#CachedDataLoaderwLookup-467"><span class="linenos">467</span></a>            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
</span><span id="CachedDataLoaderwLookup-468"><a href="#CachedDataLoaderwLookup-468"><span class="linenos">468</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoaderwLookup-469"><a href="#CachedDataLoaderwLookup-469"><span class="linenos">469</span></a>            
</span><span id="CachedDataLoaderwLookup-470"><a href="#CachedDataLoaderwLookup-470"><span class="linenos">470</span></a>            <span class="n">lookup_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]))</span>
</span><span id="CachedDataLoaderwLookup-471"><a href="#CachedDataLoaderwLookup-471"><span class="linenos">471</span></a>            
</span><span id="CachedDataLoaderwLookup-472"><a href="#CachedDataLoaderwLookup-472"><span class="linenos">472</span></a>        <span class="k">return</span> <span class="n">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">,</span> <span class="n">lookup_data</span><span class="o">=</span><span class="n">lookup_data</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup-473"><a href="#CachedDataLoaderwLookup-473"><span class="linenos">473</span></a>    
</span><span id="CachedDataLoaderwLookup-474"><a href="#CachedDataLoaderwLookup-474"><span class="linenos">474</span></a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup-475"><a href="#CachedDataLoaderwLookup-475"><span class="linenos">475</span></a>
</span><span id="CachedDataLoaderwLookup-476"><a href="#CachedDataLoaderwLookup-476"><span class="linenos">476</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]):</span>
</span><span id="CachedDataLoaderwLookup-477"><a href="#CachedDataLoaderwLookup-477"><span class="linenos">477</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoaderwLookup-478"><a href="#CachedDataLoaderwLookup-478"><span class="linenos">478</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
</span><span id="CachedDataLoaderwLookup-479"><a href="#CachedDataLoaderwLookup-479"><span class="linenos">479</span></a>    
</span><span id="CachedDataLoaderwLookup-480"><a href="#CachedDataLoaderwLookup-480"><span class="linenos">480</span></a>    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup-481"><a href="#CachedDataLoaderwLookup-481"><span class="linenos">481</span></a>        
</span><span id="CachedDataLoaderwLookup-482"><a href="#CachedDataLoaderwLookup-482"><span class="linenos">482</span></a>        <span class="c1">## add lookup_data to the index</span>
</span><span id="CachedDataLoaderwLookup-483"><a href="#CachedDataLoaderwLookup-483"><span class="linenos">483</span></a>        <span class="n">lookup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.lookup&quot;</span>
</span><span id="CachedDataLoaderwLookup-484"><a href="#CachedDataLoaderwLookup-484"><span class="linenos">484</span></a>        
</span><span id="CachedDataLoaderwLookup-485"><a href="#CachedDataLoaderwLookup-485"><span class="linenos">485</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup-486"><a href="#CachedDataLoaderwLookup-486"><span class="linenos">486</span></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup-487"><a href="#CachedDataLoaderwLookup-487"><span class="linenos">487</span></a>        
</span><span id="CachedDataLoaderwLookup-488"><a href="#CachedDataLoaderwLookup-488"><span class="linenos">488</span></a>        <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_file</span>
</span><span id="CachedDataLoaderwLookup-489"><a href="#CachedDataLoaderwLookup-489"><span class="linenos">489</span></a>        
</span><span id="CachedDataLoaderwLookup-490"><a href="#CachedDataLoaderwLookup-490"><span class="linenos">490</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup-491"><a href="#CachedDataLoaderwLookup-491"><span class="linenos">491</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup-492"><a href="#CachedDataLoaderwLookup-492"><span class="linenos">492</span></a>            
</span><span id="CachedDataLoaderwLookup-493"><a href="#CachedDataLoaderwLookup-493"><span class="linenos">493</span></a>    <span class="k">def</span> <span class="nf">__build_generator_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup-494"><a href="#CachedDataLoaderwLookup-494"><span class="linenos">494</span></a>        
</span><span id="CachedDataLoaderwLookup-495"><a href="#CachedDataLoaderwLookup-495"><span class="linenos">495</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoaderwLookup-496"><a href="#CachedDataLoaderwLookup-496"><span class="linenos">496</span></a>        
</span><span id="CachedDataLoaderwLookup-497"><a href="#CachedDataLoaderwLookup-497"><span class="linenos">497</span></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Correspond to a CachedDataLoader but also keeps track of an aditional lookup file</p>
</div>


                            <div id="CachedDataLoaderwLookup.__init__" class="classattr">
                                        <input id="CachedDataLoaderwLookup.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CachedDataLoaderwLookup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="n">lookup_data</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">cache_index</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoaderwLookup.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoaderwLookup.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoaderwLookup.__init__-421"><a href="#CachedDataLoaderwLookup.__init__-421"><span class="linenos">421</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup.__init__-422"><a href="#CachedDataLoaderwLookup.__init__-422"><span class="linenos">422</span></a>                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup.__init__-423"><a href="#CachedDataLoaderwLookup.__init__-423"><span class="linenos">423</span></a>                 <span class="n">lookup_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup.__init__-424"><a href="#CachedDataLoaderwLookup.__init__-424"><span class="linenos">424</span></a>                 <span class="n">cache_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
</span><span id="CachedDataLoaderwLookup.__init__-425"><a href="#CachedDataLoaderwLookup.__init__-425"><span class="linenos">425</span></a>                 <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup.__init__-426"><a href="#CachedDataLoaderwLookup.__init__-426"><span class="linenos">426</span></a>                <span class="p">):</span>
</span><span id="CachedDataLoaderwLookup.__init__-427"><a href="#CachedDataLoaderwLookup.__init__-427"><span class="linenos">427</span></a>        
</span><span id="CachedDataLoaderwLookup.__init__-428"><a href="#CachedDataLoaderwLookup.__init__-428"><span class="linenos">428</span></a>        <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="n">cache_index</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup.__init__-429"><a href="#CachedDataLoaderwLookup.__init__-429"><span class="linenos">429</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup.__init__-430"><a href="#CachedDataLoaderwLookup.__init__-430"><span class="linenos">430</span></a>                <span class="n">lookup_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup.__init__-431"><a href="#CachedDataLoaderwLookup.__init__-431"><span class="linenos">431</span></a>        
</span><span id="CachedDataLoaderwLookup.__init__-432"><a href="#CachedDataLoaderwLookup.__init__-432"><span class="linenos">432</span></a>        <span class="k">if</span> <span class="n">lookup_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup.__init__-433"><a href="#CachedDataLoaderwLookup.__init__-433"><span class="linenos">433</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Do not use CachedDataLoaderwLookup without setting a lookup_data, instead use CachedDataLoader&quot;</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup.__init__-434"><a href="#CachedDataLoaderwLookup.__init__-434"><span class="linenos">434</span></a>        
</span><span id="CachedDataLoaderwLookup.__init__-435"><a href="#CachedDataLoaderwLookup.__init__-435"><span class="linenos">435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">lookup_data</span>
</span><span id="CachedDataLoaderwLookup.__init__-436"><a href="#CachedDataLoaderwLookup.__init__-436"><span class="linenos">436</span></a>        
</span><span id="CachedDataLoaderwLookup.__init__-437"><a href="#CachedDataLoaderwLookup.__init__-437"><span class="linenos">437</span></a>        <span class="c1"># the parent DataLoader will call _build_sample_generator that contains the logic to build the dataloader</span>
</span><span id="CachedDataLoaderwLookup.__init__-438"><a href="#CachedDataLoaderwLookup.__init__-438"><span class="linenos">438</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cache_index</span><span class="o">=</span><span class="n">cache_index</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><h6 id="args">Args</h6>

<ul>
<li><strong>source_generator (python generator):</strong>  Same as in <code><a href="#DataLoader">polus.data.DataLoader</a></code></li>
</ul>
</div>


                            </div>
                            <div id="CachedDataLoaderwLookup.get_lookup_data" class="classattr">
                                        <input id="CachedDataLoaderwLookup.get_lookup_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_lookup_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoaderwLookup.get_lookup_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoaderwLookup.get_lookup_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoaderwLookup.get_lookup_data-440"><a href="#CachedDataLoaderwLookup.get_lookup_data-440"><span class="linenos">440</span></a>    <span class="k">def</span> <span class="nf">get_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup.get_lookup_data-441"><a href="#CachedDataLoaderwLookup.get_lookup_data-441"><span class="linenos">441</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span>
</span></pre></div>


    

                            </div>
                            <div id="CachedDataLoaderwLookup.merge" class="classattr">
                                        <input id="CachedDataLoaderwLookup.merge-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">merge</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="o">*</span><span class="n">cache_dataloaders</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoaderwLookup.merge-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoaderwLookup.merge"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoaderwLookup.merge-448"><a href="#CachedDataLoaderwLookup.merge-448"><span class="linenos">448</span></a>    <span class="nd">@classmethod</span>
</span><span id="CachedDataLoaderwLookup.merge-449"><a href="#CachedDataLoaderwLookup.merge-449"><span class="linenos">449</span></a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup.merge-450"><a href="#CachedDataLoaderwLookup.merge-450"><span class="linenos">450</span></a>        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup.merge-451"><a href="#CachedDataLoaderwLookup.merge-451"><span class="linenos">451</span></a>
</span><span id="CachedDataLoaderwLookup.merge-452"><a href="#CachedDataLoaderwLookup.merge-452"><span class="linenos">452</span></a>        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
</span><span id="CachedDataLoaderwLookup.merge-453"><a href="#CachedDataLoaderwLookup.merge-453"><span class="linenos">453</span></a>                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="CachedDataLoaderwLookup.merge-454"><a href="#CachedDataLoaderwLookup.merge-454"><span class="linenos">454</span></a>                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
</span><span id="CachedDataLoaderwLookup.merge-455"><a href="#CachedDataLoaderwLookup.merge-455"><span class="linenos">455</span></a>                      <span class="p">}</span>
</span><span id="CachedDataLoaderwLookup.merge-456"><a href="#CachedDataLoaderwLookup.merge-456"><span class="linenos">456</span></a>        
</span><span id="CachedDataLoaderwLookup.merge-457"><a href="#CachedDataLoaderwLookup.merge-457"><span class="linenos">457</span></a>        <span class="n">lookup_data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="CachedDataLoaderwLookup.merge-458"><a href="#CachedDataLoaderwLookup.merge-458"><span class="linenos">458</span></a>        
</span><span id="CachedDataLoaderwLookup.merge-459"><a href="#CachedDataLoaderwLookup.merge-459"><span class="linenos">459</span></a>        <span class="c1"># read files</span>
</span><span id="CachedDataLoaderwLookup.merge-460"><a href="#CachedDataLoaderwLookup.merge-460"><span class="linenos">460</span></a>        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup.merge-461"><a href="#CachedDataLoaderwLookup.merge-461"><span class="linenos">461</span></a>            
</span><span id="CachedDataLoaderwLookup.merge-462"><a href="#CachedDataLoaderwLookup.merge-462"><span class="linenos">462</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup.merge-463"><a href="#CachedDataLoaderwLookup.merge-463"><span class="linenos">463</span></a>                
</span><span id="CachedDataLoaderwLookup.merge-464"><a href="#CachedDataLoaderwLookup.merge-464"><span class="linenos">464</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
</span><span id="CachedDataLoaderwLookup.merge-465"><a href="#CachedDataLoaderwLookup.merge-465"><span class="linenos">465</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoaderwLookup.merge-466"><a href="#CachedDataLoaderwLookup.merge-466"><span class="linenos">466</span></a>            
</span><span id="CachedDataLoaderwLookup.merge-467"><a href="#CachedDataLoaderwLookup.merge-467"><span class="linenos">467</span></a>            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
</span><span id="CachedDataLoaderwLookup.merge-468"><a href="#CachedDataLoaderwLookup.merge-468"><span class="linenos">468</span></a>            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoaderwLookup.merge-469"><a href="#CachedDataLoaderwLookup.merge-469"><span class="linenos">469</span></a>            
</span><span id="CachedDataLoaderwLookup.merge-470"><a href="#CachedDataLoaderwLookup.merge-470"><span class="linenos">470</span></a>            <span class="n">lookup_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]))</span>
</span><span id="CachedDataLoaderwLookup.merge-471"><a href="#CachedDataLoaderwLookup.merge-471"><span class="linenos">471</span></a>            
</span><span id="CachedDataLoaderwLookup.merge-472"><a href="#CachedDataLoaderwLookup.merge-472"><span class="linenos">472</span></a>        <span class="k">return</span> <span class="n">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">,</span> <span class="n">lookup_data</span><span class="o">=</span><span class="n">lookup_data</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="CachedDataLoaderwLookup.clean" class="classattr">
                                        <input id="CachedDataLoaderwLookup.clean-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clean</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoaderwLookup.clean-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoaderwLookup.clean"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoaderwLookup.clean-474"><a href="#CachedDataLoaderwLookup.clean-474"><span class="linenos">474</span></a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup.clean-475"><a href="#CachedDataLoaderwLookup.clean-475"><span class="linenos">475</span></a>
</span><span id="CachedDataLoaderwLookup.clean-476"><a href="#CachedDataLoaderwLookup.clean-476"><span class="linenos">476</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]):</span>
</span><span id="CachedDataLoaderwLookup.clean-477"><a href="#CachedDataLoaderwLookup.clean-477"><span class="linenos">477</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
</span><span id="CachedDataLoaderwLookup.clean-478"><a href="#CachedDataLoaderwLookup.clean-478"><span class="linenos">478</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="CachedDataLoaderwLookup.write_index_file" class="classattr">
                                        <input id="CachedDataLoaderwLookup.write_index_file-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">write_index_file</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">index_info</span></span>)</span>

                <label class="view-source-button" for="CachedDataLoaderwLookup.write_index_file-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CachedDataLoaderwLookup.write_index_file"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CachedDataLoaderwLookup.write_index_file-480"><a href="#CachedDataLoaderwLookup.write_index_file-480"><span class="linenos">480</span></a>    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
</span><span id="CachedDataLoaderwLookup.write_index_file-481"><a href="#CachedDataLoaderwLookup.write_index_file-481"><span class="linenos">481</span></a>        
</span><span id="CachedDataLoaderwLookup.write_index_file-482"><a href="#CachedDataLoaderwLookup.write_index_file-482"><span class="linenos">482</span></a>        <span class="c1">## add lookup_data to the index</span>
</span><span id="CachedDataLoaderwLookup.write_index_file-483"><a href="#CachedDataLoaderwLookup.write_index_file-483"><span class="linenos">483</span></a>        <span class="n">lookup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.lookup&quot;</span>
</span><span id="CachedDataLoaderwLookup.write_index_file-484"><a href="#CachedDataLoaderwLookup.write_index_file-484"><span class="linenos">484</span></a>        
</span><span id="CachedDataLoaderwLookup.write_index_file-485"><a href="#CachedDataLoaderwLookup.write_index_file-485"><span class="linenos">485</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup.write_index_file-486"><a href="#CachedDataLoaderwLookup.write_index_file-486"><span class="linenos">486</span></a>            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span><span id="CachedDataLoaderwLookup.write_index_file-487"><a href="#CachedDataLoaderwLookup.write_index_file-487"><span class="linenos">487</span></a>        
</span><span id="CachedDataLoaderwLookup.write_index_file-488"><a href="#CachedDataLoaderwLookup.write_index_file-488"><span class="linenos">488</span></a>        <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_file</span>
</span><span id="CachedDataLoaderwLookup.write_index_file-489"><a href="#CachedDataLoaderwLookup.write_index_file-489"><span class="linenos">489</span></a>        
</span><span id="CachedDataLoaderwLookup.write_index_file-490"><a href="#CachedDataLoaderwLookup.write_index_file-490"><span class="linenos">490</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="CachedDataLoaderwLookup.write_index_file-491"><a href="#CachedDataLoaderwLookup.write_index_file-491"><span class="linenos">491</span></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#CachedDataLoader">CachedDataLoader</a></dt>
                                <dd id="CachedDataLoaderwLookup.from_cached_index" class="function"><a href="#CachedDataLoader.from_cached_index">from_cached_index</a></dd>
                <dd id="CachedDataLoaderwLookup.read_index" class="function"><a href="#CachedDataLoader.read_index">read_index</a></dd>
                <dd id="CachedDataLoaderwLookup.pre_shuffle" class="function"><a href="#CachedDataLoader.pre_shuffle">pre_shuffle</a></dd>
                <dd id="CachedDataLoaderwLookup.add_lookup_data" class="function"><a href="#CachedDataLoader.add_lookup_data">add_lookup_data</a></dd>
                <dd id="CachedDataLoaderwLookup.add_lookup_data_path" class="function"><a href="#CachedDataLoader.add_lookup_data_path">add_lookup_data_path</a></dd>
                <dd id="CachedDataLoaderwLookup.deep_copy" class="function"><a href="#CachedDataLoader.deep_copy">deep_copy</a></dd>

            </div>
            <div><dt><a href="#DataLoader">DataLoader</a></dt>
                                <dd id="CachedDataLoaderwLookup.to_tfDataset" class="function"><a href="#DataLoader.to_tfDataset">to_tfDataset</a></dd>
                <dd id="CachedDataLoaderwLookup.set_name" class="function"><a href="#DataLoader.set_name">set_name</a></dd>
                <dd id="CachedDataLoaderwLookup.get_n_samples" class="function"><a href="#DataLoader.get_n_samples">get_n_samples</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="IAccelerated_Map">
                            <input id="IAccelerated_Map-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">IAccelerated_Map</span>:

                <label class="view-source-button" for="IAccelerated_Map-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IAccelerated_Map"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IAccelerated_Map-500"><a href="#IAccelerated_Map-500"><span class="linenos">500</span></a><span class="k">class</span> <span class="nc">IAccelerated_Map</span><span class="p">:</span>
</span><span id="IAccelerated_Map-501"><a href="#IAccelerated_Map-501"><span class="linenos">501</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="IAccelerated_Map-502"><a href="#IAccelerated_Map-502"><span class="linenos">502</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="IAccelerated_Map-503"><a href="#IAccelerated_Map-503"><span class="linenos">503</span></a>        
</span><span id="IAccelerated_Map-504"><a href="#IAccelerated_Map-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="IAccelerated_Map-505"><a href="#IAccelerated_Map-505"><span class="linenos">505</span></a>        
</span><span id="IAccelerated_Map-506"><a href="#IAccelerated_Map-506"><span class="linenos">506</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;IAccelerated_Map&quot;</span><span class="p">:</span>
</span><span id="IAccelerated_Map-507"><a href="#IAccelerated_Map-507"><span class="linenos">507</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
</span><span id="IAccelerated_Map-508"><a href="#IAccelerated_Map-508"><span class="linenos">508</span></a>            
</span><span id="IAccelerated_Map-509"><a href="#IAccelerated_Map-509"><span class="linenos">509</span></a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="IAccelerated_Map-510"><a href="#IAccelerated_Map-510"><span class="linenos">510</span></a>        <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;build method was not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            <div id="IAccelerated_Map.__init__" class="classattr">
                                        <input id="IAccelerated_Map.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">IAccelerated_Map</span><span class="signature pdoc-code condensed">()</span>

                <label class="view-source-button" for="IAccelerated_Map.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IAccelerated_Map.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IAccelerated_Map.__init__-501"><a href="#IAccelerated_Map.__init__-501"><span class="linenos">501</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="IAccelerated_Map.__init__-502"><a href="#IAccelerated_Map.__init__-502"><span class="linenos">502</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="IAccelerated_Map.__init__-503"><a href="#IAccelerated_Map.__init__-503"><span class="linenos">503</span></a>        
</span><span id="IAccelerated_Map.__init__-504"><a href="#IAccelerated_Map.__init__-504"><span class="linenos">504</span></a>        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="IAccelerated_Map.__init__-505"><a href="#IAccelerated_Map.__init__-505"><span class="linenos">505</span></a>        
</span><span id="IAccelerated_Map.__init__-506"><a href="#IAccelerated_Map.__init__-506"><span class="linenos">506</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;IAccelerated_Map&quot;</span><span class="p">:</span>
</span><span id="IAccelerated_Map.__init__-507"><a href="#IAccelerated_Map.__init__-507"><span class="linenos">507</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="IAccelerated_Map.build" class="classattr">
                                        <input id="IAccelerated_Map.build-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span>)</span>

                <label class="view-source-button" for="IAccelerated_Map.build-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IAccelerated_Map.build"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IAccelerated_Map.build-509"><a href="#IAccelerated_Map.build-509"><span class="linenos">509</span></a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="IAccelerated_Map.build-510"><a href="#IAccelerated_Map.build-510"><span class="linenos">510</span></a>        <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;build method was not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="access_embeddings">
                            <input id="access_embeddings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">access_embeddings</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">func</span></span>)</span>

                <label class="view-source-button" for="access_embeddings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#access_embeddings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="access_embeddings-513"><a href="#access_embeddings-513"><span class="linenos">513</span></a><span class="k">def</span> <span class="nf">access_embeddings</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="access_embeddings-514"><a href="#access_embeddings-514"><span class="linenos">514</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="access_embeddings-515"><a href="#access_embeddings-515"><span class="linenos">515</span></a><span class="sd">    A simple decorator function to access the embeddings property if present in the data</span>
</span><span id="access_embeddings-516"><a href="#access_embeddings-516"><span class="linenos">516</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="access_embeddings-517"><a href="#access_embeddings-517"><span class="linenos">517</span></a>    <span class="k">def</span> <span class="nf">function_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="access_embeddings-518"><a href="#access_embeddings-518"><span class="linenos">518</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;embeddings&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="access_embeddings-519"><a href="#access_embeddings-519"><span class="linenos">519</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;embeddings&quot;</span><span class="p">])</span>
</span><span id="access_embeddings-520"><a href="#access_embeddings-520"><span class="linenos">520</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="access_embeddings-521"><a href="#access_embeddings-521"><span class="linenos">521</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="access_embeddings-522"><a href="#access_embeddings-522"><span class="linenos">522</span></a>            
</span><span id="access_embeddings-523"><a href="#access_embeddings-523"><span class="linenos">523</span></a>        
</span><span id="access_embeddings-524"><a href="#access_embeddings-524"><span class="linenos">524</span></a>    <span class="k">return</span> <span class="n">function_wrapper</span>
</span></pre></div>


            <div class="docstring"><p>A simple decorator function to access the embeddings property if present in the data</p>
</div>


                </section>
                <section id="build_bert_embeddings">
                            <input id="build_bert_embeddings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_bert_embeddings</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="build_bert_embeddings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#build_bert_embeddings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="build_bert_embeddings-517"><a href="#build_bert_embeddings-517"><span class="linenos">517</span></a>    <span class="k">def</span> <span class="nf">function_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="build_bert_embeddings-518"><a href="#build_bert_embeddings-518"><span class="linenos">518</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;embeddings&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="build_bert_embeddings-519"><a href="#build_bert_embeddings-519"><span class="linenos">519</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;embeddings&quot;</span><span class="p">])</span>
</span><span id="build_bert_embeddings-520"><a href="#build_bert_embeddings-520"><span class="linenos">520</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="build_bert_embeddings-521"><a href="#build_bert_embeddings-521"><span class="linenos">521</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>