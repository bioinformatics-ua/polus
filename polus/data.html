<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 8.3.0" />
    <title>polus.data API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2264%22%20height%3D%2264%22%20viewBox%3D%2244.5%202.5%2015%2015%22%3E%3Cpath%20d%3D%22M49.351%2021.041c-.233-.721-.546-2.408-.772-4.076-.042-.09-.067-.187-.046-.288-.166-1.347-.277-2.625-.241-3.351-1.378-1.008-2.271-2.586-2.271-4.362%200-.976.272-1.935.788-2.774.057-.094.122-.18.184-.268-.033-.167-.052-.339-.052-.516%200-1.477%201.202-2.679%202.679-2.679.791%200%201.496.352%201.987.9a6.3%206.3%200%200%201%201.001.029c.492-.564%201.207-.929%202.012-.929%201.477%200%202.679%201.202%202.679%202.679a2.65%202.65%200%200%201-.269%201.148c.383.747.595%201.572.595%202.41%200%202.311-1.507%204.29-3.635%205.107.037.699.147%202.27.423%203.294l.137.461c.156%202.136-4.612%205.166-5.199%203.215zm.127-4.919a4.78%204.78%200%200%200%20.775-.584c-.172-.115-.505-.254-.88-.378zm.331%202.302l.828-.502c-.202-.143-.576-.328-.984-.49zm.45%202.157l.701-.403c-.214-.115-.536-.249-.891-.376l.19.779zM49.13%204.141c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm.735-.389a1.15%201.15%200%200%201%20.314.783%201.16%201.16%200%200%201-1.162%201.162c-.457%200-.842-.27-1.032-.653-.026.117-.042.238-.042.362a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.843-.626-1.535-1.436-1.654zm3.076%201.654a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.037-.009-.072-.011-.109-.21.3-.541.508-.935.508a1.16%201.16%200%200%201-1.162-1.162%201.14%201.14%200%200%201%20.474-.912c-.015%200-.03-.005-.045-.005-.926.001-1.679.754-1.679%201.68zm1.861-1.265c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm1.823%204.823c0-.52-.103-1.035-.288-1.52-.466.394-1.06.64-1.717.64-1.144%200-2.116-.725-2.499-1.738-.383%201.012-1.355%201.738-2.499%201.738-.867%200-1.631-.421-2.121-1.062-.307.605-.478%201.267-.478%201.942%200%202.486%202.153%204.51%204.801%204.51s4.801-2.023%204.801-4.51zm-3.032%209.156l-.146-.492c-.276-1.02-.395-2.457-.444-3.268a6.11%206.11%200%200%201-1.18.115%206.01%206.01%200%200%201-2.536-.562l.006.175c.802.215%201.848.612%202.021%201.25.079.295-.021.601-.274.837l-.598.501c.667.304%201.243.698%201.311%201.179.02.144.022.507-.393.787l-.564.365c1.285.521%201.361.96%201.381%201.126.018.142.011.496-.427.746l-.854.489c.064-1.19%201.985-2.585%202.697-3.248zM49.34%209.925c0-.667%201-.667%201%200%200%20.653.818%201.205%201.787%201.205s1.787-.552%201.787-1.205c0-.667%201-.667%201%200%200%201.216-1.25%202.205-2.787%202.205s-2.787-.989-2.787-2.205zm-.887-7.633c-.093.077-.205.114-.317.114a.5.5%200%200%201-.318-.886L49.183.397a.5.5%200%200%201%20.703.068.5.5%200%200%201-.069.703zm7.661-.065c-.086%200-.173-.022-.253-.068l-1.523-.893c-.575-.337-.069-1.2.506-.863l1.523.892a.5.5%200%200%201%20.179.685c-.094.158-.261.247-.432.247z%22%20fill%3D%22%233bb300%22/%3E%3C/svg%3E"/>


<style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
<style>/*! pygments syntax highlighting */pre{line-height:125%;}td.linenos pre{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}span.linenos{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}td.linenos pre.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}span.linenos.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}.pdoc .hll{background-color:#ffffcc}.pdoc{background:#f8f8f8;}.pdoc .c{color:#408080; font-style:italic}.pdoc .err{border:1px solid #FF0000}.pdoc .k{color:#008000; font-weight:bold}.pdoc .o{color:#666666}.pdoc .ch{color:#408080; font-style:italic}.pdoc .cm{color:#408080; font-style:italic}.pdoc .cp{color:#BC7A00}.pdoc .cpf{color:#408080; font-style:italic}.pdoc .c1{color:#408080; font-style:italic}.pdoc .cs{color:#408080; font-style:italic}.pdoc .gd{color:#A00000}.pdoc .ge{font-style:italic}.pdoc .gr{color:#FF0000}.pdoc .gh{color:#000080; font-weight:bold}.pdoc .gi{color:#00A000}.pdoc .go{color:#888888}.pdoc .gp{color:#000080; font-weight:bold}.pdoc .gs{font-weight:bold}.pdoc .gu{color:#800080; font-weight:bold}.pdoc .gt{color:#0044DD}.pdoc .kc{color:#008000; font-weight:bold}.pdoc .kd{color:#008000; font-weight:bold}.pdoc .kn{color:#008000; font-weight:bold}.pdoc .kp{color:#008000}.pdoc .kr{color:#008000; font-weight:bold}.pdoc .kt{color:#B00040}.pdoc .m{color:#666666}.pdoc .s{color:#BA2121}.pdoc .na{color:#7D9029}.pdoc .nb{color:#008000}.pdoc .nc{color:#0000FF; font-weight:bold}.pdoc .no{color:#880000}.pdoc .nd{color:#AA22FF}.pdoc .ni{color:#999999; font-weight:bold}.pdoc .ne{color:#D2413A; font-weight:bold}.pdoc .nf{color:#0000FF}.pdoc .nl{color:#A0A000}.pdoc .nn{color:#0000FF; font-weight:bold}.pdoc .nt{color:#008000; font-weight:bold}.pdoc .nv{color:#19177C}.pdoc .ow{color:#AA22FF; font-weight:bold}.pdoc .w{color:#bbbbbb}.pdoc .mb{color:#666666}.pdoc .mf{color:#666666}.pdoc .mh{color:#666666}.pdoc .mi{color:#666666}.pdoc .mo{color:#666666}.pdoc .sa{color:#BA2121}.pdoc .sb{color:#BA2121}.pdoc .sc{color:#BA2121}.pdoc .dl{color:#BA2121}.pdoc .sd{color:#BA2121; font-style:italic}.pdoc .s2{color:#BA2121}.pdoc .se{color:#BB6622; font-weight:bold}.pdoc .sh{color:#BA2121}.pdoc .si{color:#BB6688; font-weight:bold}.pdoc .sx{color:#008000}.pdoc .sr{color:#BB6688}.pdoc .s1{color:#BA2121}.pdoc .ss{color:#19177C}.pdoc .bp{color:#008000}.pdoc .fm{color:#0000FF}.pdoc .vc{color:#19177C}.pdoc .vg{color:#19177C}.pdoc .vi{color:#19177C}.pdoc .vm{color:#19177C}.pdoc .il{color:#666666}</style>
<style>/*! pdoc */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f7f7f7;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}body{background-color:var(--pdoc-background);}html, body{width:100%;height:100%;}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}.git-button{display:none !important;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}#navtoggle{display:none;}}#togglestate{display:none;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}html, main{scroll-behavior:smooth;}.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{background-color:var(--code);border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;}.pdoc details > summary:focus{outline:0;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:2.5rem;}.pdoc .docstring pre{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
</head>
<body>        <nav class="pdoc">
            <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
            <input id="togglestate" type="checkbox">
            <div>
                        <a class="pdoc-button module-list-button" href="../polus.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                            &nbsp;polus</a>


                        <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                               pattern=".+" required>

                    <h2>Contents</h2>
                    <ul>
  <li><a href="#polus-data-api">Polus Data API</a></li>
</ul>



                    <h2>API Documentation</h2>
                        <ul class="memberlist">
            <li>
                    <a class="class" href="#DataLoader">DataLoader</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DataLoader.__init__">DataLoader</a>
                        </li>
                        <li>
                                <a class="function" href="#DataLoader.get_n_samples">get_n_samples</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CachedDataLoader">CachedDataLoader</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CachedDataLoader.__init__">CachedDataLoader</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.from_cached_index">from_cached_index</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.merge">merge</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.read_index">read_index</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.write_index_file">write_index_file</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.clean">clean</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoader.pre_shuffle">pre_shuffle</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CachedDataLoaderwLookup">CachedDataLoaderwLookup</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.__init__">CachedDataLoaderwLookup</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.get_lookup_data">get_lookup_data</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.merge">merge</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.clean">clean</a>
                        </li>
                        <li>
                                <a class="function" href="#CachedDataLoaderwLookup.write_index_file">write_index_file</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#IAccelerated_Map">IAccelerated_Map</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#IAccelerated_Map.__init__">IAccelerated_Map</a>
                        </li>
                        <li>
                                <a class="function" href="#IAccelerated_Map.build">build</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#access_embeddings">access_embeddings</a>
            </li>
            <li>
                    <a class="function" href="#build_bert_embeddings">build_bert_embeddings</a>
            </li>
    </ul>



                    <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
                        built with <span class="visually-hidden">pdoc</span><img
                            alt="pdoc logo"
                            src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
                    </a>
            </div>
        </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../polus.html">polus</a><wbr>.data    </h1>

                        <div class="docstring"><h1 id="polus-data-api">Polus Data API</h1>

<p>The polus data API serves as a wrapper of the <em>tf.data.Dataset</em> API.
More precisely, we focus on the perspective of data loading and
efficient preprocessing, hence the main classes here are the DataLoaders.</p>

<h3 id="main-classes">Main classes</h3>

<ul>
<li><p><code><a href="#DataLoader">polus.data.DataLoader</a></code>: Base class of data loader and automatically converts python
generators to highly efficient <em>tf.data.Dataset</em>. Furthermore, it also supports
GPU preprocessing which differs from <em>tf.data.Dataset</em>, since it only runs on CPU</p></li>
<li><p><code><a href="#CachedDataLoader">polus.data.CachedDataLoader</a></code>: Extension of <code><a href="../polus.html#DataLoader">polus.DataLoader</a></code>, adds the ability to seamlessly
store the preprocessed samples in the disk, following a chunking mechanism. Besides the 
organizational advantage, this also enables us to implement a <em>pre_shuffle</em> mechanism
that occurs at the chunk level, making it a much more efficient process since we can
fully shuffle the dataset without the need to have it in memory. </p></li>
<li><p><code><a href="#CachedDataLoaderwLookup">polus.data.CachedDataLoaderwLookup</a></code>: Extension of <code><a href="#CachedDataLoader">polus.data.CachedDataLoader</a></code>, adds the 
functionality to store arbitrary python objects jointly with the stored DataLoader.
Note for storing python objects we use the <em>pickle</em> library.</p></li>
</ul>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd"># Polus Data API</span>

<span class="sd">The polus data API serves as a wrapper of the *tf.data.Dataset* API.</span>
<span class="sd">More precisely, we focus on the perspective of data loading and</span>
<span class="sd">efficient preprocessing, hence the main classes here are the DataLoaders.</span>

<span class="sd">### Main classes</span>

<span class="sd">- `polus.data.DataLoader`: Base class of data loader and automatically converts python</span>
<span class="sd">  generators to highly efficient *tf.data.Dataset*. Furthermore, it also supports</span>
<span class="sd">  GPU preprocessing which differs from *tf.data.Dataset*, since it only runs on CPU</span>
<span class="sd">  </span>
<span class="sd">- `polus.data.CachedDataLoader`: Extension of `polus.DataLoader`, adds the ability to seamlessly</span>
<span class="sd">  store the preprocessed samples in the disk, following a chunking mechanism. Besides the </span>
<span class="sd">  organizational advantage, this also enables us to implement a *pre_shuffle* mechanism</span>
<span class="sd">  that occurs at the chunk level, making it a much more efficient process since we can</span>
<span class="sd">  fully shuffle the dataset without the need to have it in memory. </span>

<span class="sd">- `polus.data.CachedDataLoaderwLookup`: Extension of `polus.data.CachedDataLoader`, adds the </span>
<span class="sd">  functionality to store arbitrary python objects jointly with the stored DataLoader.</span>
<span class="sd">  Note for storing python objects we use the *pickle* library.</span>

<span class="sd">&#39;&#39;&#39;</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">polus.core</span> <span class="kn">import</span> <span class="n">BaseLogger</span><span class="p">,</span> <span class="n">find_dtype_and_shapes</span>
<span class="kn">from</span> <span class="nn">polus.models</span> <span class="kn">import</span> <span class="n">split_bert_model</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">TFAutoModel</span>
<span class="kn">from</span> <span class="nn">transformers.modeling_tf_outputs</span> <span class="kn">import</span> <span class="n">TFBaseModelOutputWithPooling</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>




<span class="k">class</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">BaseLogger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class of a data loader that builds higly efficient datasets (*tf.data.Dataset*)</span>
<span class="sd">    from full python generators. </span>
<span class="sd">    </span>
<span class="sd">    The python generator must return a dictionary of samples, and no other format</span>
<span class="sd">    is currently supported.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">source_generator</span><span class="p">,</span>
                 <span class="n">accelerated_map_f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">accelerated_map_batch</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
                 <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">magic_k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">          source_generator (python generator): Must be a python generator that returns a </span>
<span class="sd">            **dictionary of samples**. Since this generator will be converted into a </span>
<span class="sd">            *tf.data.Dataset*, all the datatypes must be supported in TensorFlow, which is</span>
<span class="sd">            true for all python primitives types.</span>
<span class="sd">          </span>
<span class="sd">          accelerated_map_f (func or `polus.data.IAccelerated_Map`): A function or interface, that</span>
<span class="sd">            describe a transformation to be applied to the samples from the *source_generator*.</span>
<span class="sd">            By default, this function will execute in the best hardware found on the host device,</span>
<span class="sd">            i.e., it should be used for mapping computations that should run on a GPU, e.g., </span>
<span class="sd">            contextualized embeddings from BERT.</span>
<span class="sd">            </span>
<span class="sd">          accelerated_map_batch (int): The size of the batch that is fed to the *accelerated_map_f*</span>
<span class="sd">            recalling that when running on GPU it is more efficient to perform batch-wise operations.</span>
<span class="sd">            </span>
<span class="sd">          show_progress (boolean): If true prints the current batch that was fed to accelerated_map_f.</span>
<span class="sd">          </span>
<span class="sd">          magic_k (int): Integer number that defines how many samples would be executed in order to infer</span>
<span class="sd">            the shape and type of the data.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">          None</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_batch</span> <span class="o">=</span> <span class="n">accelerated_map_batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span> <span class="o">=</span> <span class="n">accelerated_map_f</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_sample_generator</span><span class="p">(</span><span class="n">source_generator</span><span class="p">)</span>

        <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="n">magic_k</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">,</span> 
                                                         <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
                                                         <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>
            
        <span class="c1"># expose all the tf dataset methods</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    
    <span class="k">def</span> <span class="nf">_build_sample_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_generator</span><span class="p">):</span>
        
        <span class="c1"># Logic to construct a generator that maybe applies the accelerated_map_f to the source_generator</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">source_generator</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># build and store the accelerated_map_f</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span><span class="p">,</span> <span class="n">IAccelerated_Map</span><span class="p">):</span>
                <span class="c1"># get the map function and run any heavy init only 1 time!</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
                        
            <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
                
                <span class="c1"># BATCH = 128</span>
                <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="n">source_generator</span><span class="p">())</span>
                <span class="n">inner_tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="n">source_generator</span><span class="p">,</span> 
                                                                  <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
                                                                  <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>\
                                                  <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_batch</span><span class="p">)</span>\
                                                  <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inner_tf_dataset</span><span class="p">):</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_batch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">start_bert_t</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time taken to run BERT </span><span class="si">{</span><span class="n">timer</span><span class="p">()</span><span class="o">-</span><span class="n">start_bert_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1">## debatching in python</span>
                    <span class="c1">## TODO: this may be a bottleneck since python is slow</span>
                    <span class="n">start_unbatch_t</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#batch size</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
                            <span class="k">yield</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span> 
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
                            <span class="k">yield</span> <span class="p">[</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">]</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the accelerated_map_f function does not yield a dict nor tuple nor a list&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time taken to unbatch </span><span class="si">{</span><span class="n">timer</span><span class="p">()</span><span class="o">-</span><span class="n">start_unbatch_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">generator</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_n_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of samples that the DataLoader contains,</span>
<span class="sd">        if the DataLoader does not know how many samples it has, then</span>
<span class="sd">        the DataLoader will first count the samples and then cache it </span>
<span class="sd">        and return the counter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;n_samples&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;this dataset does not have the number of samples in cache so it will take some time to counting&quot;</span><span class="p">)</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span><span class="p">:</span>
                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
        
        
        
<span class="k">class</span> <span class="nc">CachedDataLoader</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extension of a the DataLoader class that adds the ability to seamlessly</span>
<span class="sd">    store the preprocessed samples in the disk, following a chunking mechanism. Besides the </span>
<span class="sd">    organizational advantage, this also enables us to implement a *pre_shuffle* mechanism</span>
<span class="sd">    that occurs at the chunk level, making it a must more efficient process since we can</span>
<span class="sd">    fully shuffle the dataset without the need to have its memory. of a data loader </span>
<span class="sd">    that builds higly efficient datasets (*tf.data.Dataset*) from full python generators. </span>
<span class="sd">    </span>
<span class="sd">    Since this class involves the storage of files on disk, if any exception is raised, the</span>
<span class="sd">    DataLoader will automatically clean all the created files before raising the exception</span>
<span class="sd">    to the user.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">source_generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tf_sample_map_f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># sample mapping function written and executed in tensorflow that is applied before the data is stored in cache</span>
                 <span class="n">py_sample_map_f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># sample mapping function written and executed in python that is applied before the data is stored in cache</span>
                 <span class="n">do_clean_up</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
                 <span class="n">cache_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.polus_cache&quot;</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
                 <span class="n">cache_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">          source_generator (python generator): Same as in `polus.data.DataLoader`</span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># impossible condition</span>
        <span class="k">assert</span> <span class="n">source_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="o">=</span> <span class="n">cache_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="n">cache_chunk_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="n">cache_additional_identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_clean_up</span> <span class="o">=</span> <span class="n">do_clean_up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span> <span class="o">=</span> <span class="n">tf_sample_map_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span> <span class="o">=</span> <span class="n">py_sample_map_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache_index</span>
        
        <span class="c1"># the parent DataLoader will call _build_sample_generator that contains the logic to build the dataloader</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">source_generator</span> <span class="o">=</span> <span class="n">source_generator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># here we dont want to solve the exception, we just want to clean up de previously created files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An error has occured so all the created files will be deleted&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
            
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_cached_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">index_path</span><span class="p">):</span>
        
        <span class="n">index_info</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">index_path</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
        
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
                      <span class="p">}</span>
        
        <span class="c1"># read files</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
            
            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoader</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
                
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
            
            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
            
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
                 
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_index</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">index</span>
    
    <span class="k">def</span> <span class="nf">_build_sample_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_generator</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># we are alredy have the data needed to create the DataLoader</span>
            <span class="c1"># So, let&#39;s build it</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>
                 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>

        <span class="c1"># get path to cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_cache_base_name</span><span class="p">(</span><span class="n">source_generator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.index&quot;</span>
        
        <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
             <span class="c1"># build a generator that reads the files from cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataLoader will store the samples in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">, with a max_sample per file of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="si">}</span><span class="s2">, this may take a while&quot;</span><span class="p">)</span>
            <span class="c1"># there are no history of a previous generator so we must generate the samples once and then store in cache</span>
            <span class="c1"># normaly apply the accelerated_map_f to the source_generator</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_build_sample_generator</span><span class="p">(</span><span class="n">source_generator</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tf_source_generator</span> <span class="o">=</span> <span class="n">generator</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span><span class="p">,</span> <span class="n">IAccelerated_Map</span><span class="p">):</span>
                    <span class="c1"># get the map function and run any heavy init only 1 time!</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
                
                <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
                    
                    <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="n">tf_source_generator</span><span class="p">())</span>
                    <span class="n">inner_tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="n">tf_source_generator</span><span class="p">,</span> 
                                                                      <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
                                                                      <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>\
                                                      <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>\
                                                      <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">inner_tf_dataset</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">data</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                
                <span class="n">py_source_generator</span> <span class="o">=</span> <span class="n">generator</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span><span class="p">,</span> <span class="n">IAccelerated_Map</span><span class="p">):</span>
                    <span class="c1"># get the map function and run any heavy init only 1 time!</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
                
                <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">py_source_generator</span><span class="p">():</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We found a compatible cache file for this DataLoader&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_cache_generator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_build_cache_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># first its need to store in cache the samples</span>
        <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
                          <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="p">,</span>
                          <span class="p">}</span>
            
            <span class="k">def</span> <span class="nf">write_to_file</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
                
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">file_id</span><span class="si">:</span><span class="s2">04</span><span class="si">}</span><span class="s2">.part&quot;</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    
                <span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="n">_temp_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_file_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># TODO: Change the tf section here so that all the tf function launched here can be destroyed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting to cache the dataset, this may take a while&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">():</span>
                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="n">_temp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_temp_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="p">:</span>
                    <span class="c1"># save data to file</span>
                    
                    <span class="n">write_to_file</span><span class="p">(</span><span class="n">_file_index</span><span class="p">,</span> <span class="n">_temp_data</span><span class="p">,</span> <span class="n">index_info</span><span class="p">)</span>
                    
                    <span class="c1"># clean up </span>
                    <span class="n">_temp_data</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">_file_index</span><span class="o">+=</span><span class="mi">1</span>
            
            <span class="c1"># TODO: swap to the main tf session and destroy the previous one</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_temp_data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1"># save the reminder data</span>
                <span class="n">write_to_file</span><span class="p">(</span><span class="n">_file_index</span><span class="p">,</span> <span class="n">_temp_data</span><span class="p">,</span> <span class="n">index_info</span><span class="p">)</span>
            
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_samples</span>
            
            <span class="c1"># write the index file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_index_file</span><span class="p">(</span><span class="n">index_info</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_clean_up</span><span class="p">:</span>
            <span class="c1"># TODO: make test to see if this thing works</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The current tf session will be reseted to clear the computation done by the mapping function&quot;</span><span class="p">)</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
        
        <span class="c1"># read the index from file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
        
        <span class="c1"># Build the cache generator</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>

    
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;files&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index_path&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
                 
    <span class="k">def</span> <span class="nf">__build_generator_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set n_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span>
                 
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of samples in dataset: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
            <span class="n">aux_file_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])))</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">aux_file_index</span><span class="p">)</span>
                
            <span class="k">for</span> <span class="n">file_index</span> <span class="ow">in</span> <span class="n">aux_file_index</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="n">file_index</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">sample</span>
                 
        <span class="k">return</span> <span class="n">generator</span>
        
    <span class="k">def</span> <span class="nf">__build_cache_base_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_generator</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span><span class="si">}</span><span class="s2">_&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span><span class="o">.</span><span class="vm">__name__</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span><span class="o">.</span><span class="vm">__name__</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span><span class="o">.</span><span class="vm">__name__</span>
            
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">source_generator</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
    
    
    <span class="k">def</span> <span class="nf">pre_shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The order of the cached files will be readed in a random order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="bp">self</span>

    
<span class="k">class</span> <span class="nc">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">CachedDataLoader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correspond to a CachedDataLoader but also keeps track of an aditional lookup file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="n">lookup_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cache_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">):</span>
        
        <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="n">cache_index</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lookup_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">lookup_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Do not use CachedDataLoaderwLookup without setting a lookup_data, instead use CachedDataLoader&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">lookup_data</span>
        
        <span class="c1"># the parent DataLoader will call _build_sample_generator that contains the logic to build the dataloader</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cache_index</span><span class="o">=</span><span class="n">cache_index</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load_lookup_data</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
                      <span class="p">}</span>
        
        <span class="n">lookup_data</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># read files</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
            
            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
                
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
            
            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
            
            <span class="n">lookup_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]))</span>
            
        <span class="k">return</span> <span class="n">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">,</span> <span class="n">lookup_data</span><span class="o">=</span><span class="n">lookup_data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
        
        <span class="c1">## add lookup_data to the index</span>
        <span class="n">lookup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.lookup&quot;</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        
        <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_file</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">__build_generator_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>

    
<span class="k">class</span> <span class="nc">IAccelerated_Map</span><span class="p">(</span><span class="n">BaseLogger</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;IAccelerated_Map&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;build method was not implemented&quot;</span><span class="p">)</span>
    

<span class="k">def</span> <span class="nf">access_embeddings</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple decorator function to access the embeddings property if present in the data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">function_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;embeddings&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;embeddings&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
        
    <span class="k">return</span> <span class="n">function_wrapper</span>
    
<span class="nd">@access_embeddings</span>
<span class="k">def</span> <span class="nf">build_bert_embeddings</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">bert_layer_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="n">bert_model</span> <span class="o">=</span> <span class="n">TFAutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span>
                                             <span class="n">output_attentions</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="n">output_hidden_states</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">from_pt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    
    
    <span class="k">if</span> <span class="n">bert_layer_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pre_bert_model</span> <span class="o">=</span> <span class="n">split_bert_model</span><span class="p">(</span><span class="n">bert_model</span><span class="p">,</span> <span class="n">bert_layer_index</span><span class="p">,</span> <span class="n">return_post_bert_model</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
        <span class="k">def</span> <span class="nf">embeddings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">pre_bert_model</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
        <span class="k">def</span> <span class="nf">embeddings</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bert_model</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">embeddings</span>
</pre></div>

        </details>

            </section>
                <section id="DataLoader">
                                <div class="attr class">
        <a class="headerlink" href="#DataLoader">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">DataLoader</span><wbr>(<span class="base"><a href="core.html#BaseLogger">polus.core.BaseLogger</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">BaseLogger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class of a data loader that builds higly efficient datasets (*tf.data.Dataset*)</span>
<span class="sd">    from full python generators. </span>
<span class="sd">    </span>
<span class="sd">    The python generator must return a dictionary of samples, and no other format</span>
<span class="sd">    is currently supported.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">source_generator</span><span class="p">,</span>
                 <span class="n">accelerated_map_f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">accelerated_map_batch</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
                 <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">magic_k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">          source_generator (python generator): Must be a python generator that returns a </span>
<span class="sd">            **dictionary of samples**. Since this generator will be converted into a </span>
<span class="sd">            *tf.data.Dataset*, all the datatypes must be supported in TensorFlow, which is</span>
<span class="sd">            true for all python primitives types.</span>
<span class="sd">          </span>
<span class="sd">          accelerated_map_f (func or `polus.data.IAccelerated_Map`): A function or interface, that</span>
<span class="sd">            describe a transformation to be applied to the samples from the *source_generator*.</span>
<span class="sd">            By default, this function will execute in the best hardware found on the host device,</span>
<span class="sd">            i.e., it should be used for mapping computations that should run on a GPU, e.g., </span>
<span class="sd">            contextualized embeddings from BERT.</span>
<span class="sd">            </span>
<span class="sd">          accelerated_map_batch (int): The size of the batch that is fed to the *accelerated_map_f*</span>
<span class="sd">            recalling that when running on GPU it is more efficient to perform batch-wise operations.</span>
<span class="sd">            </span>
<span class="sd">          show_progress (boolean): If true prints the current batch that was fed to accelerated_map_f.</span>
<span class="sd">          </span>
<span class="sd">          magic_k (int): Integer number that defines how many samples would be executed in order to infer</span>
<span class="sd">            the shape and type of the data.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">          None</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_batch</span> <span class="o">=</span> <span class="n">accelerated_map_batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span> <span class="o">=</span> <span class="n">accelerated_map_f</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_sample_generator</span><span class="p">(</span><span class="n">source_generator</span><span class="p">)</span>

        <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="n">magic_k</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">,</span> 
                                                         <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
                                                         <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>
            
        <span class="c1"># expose all the tf dataset methods</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    
    <span class="k">def</span> <span class="nf">_build_sample_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_generator</span><span class="p">):</span>
        
        <span class="c1"># Logic to construct a generator that maybe applies the accelerated_map_f to the source_generator</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="n">source_generator</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># build and store the accelerated_map_f</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span><span class="p">,</span> <span class="n">IAccelerated_Map</span><span class="p">):</span>
                <span class="c1"># get the map function and run any heavy init only 1 time!</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
                        
            <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
                
                <span class="c1"># BATCH = 128</span>
                <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="n">source_generator</span><span class="p">())</span>
                <span class="n">inner_tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="n">source_generator</span><span class="p">,</span> 
                                                                  <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
                                                                  <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>\
                                                  <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_batch</span><span class="p">)</span>\
                                                  <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inner_tf_dataset</span><span class="p">):</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_batch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">start_bert_t</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time taken to run BERT </span><span class="si">{</span><span class="n">timer</span><span class="p">()</span><span class="o">-</span><span class="n">start_bert_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1">## debatching in python</span>
                    <span class="c1">## TODO: this may be a bottleneck since python is slow</span>
                    <span class="n">start_unbatch_t</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#batch size</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
                            <span class="k">yield</span> <span class="p">{</span> <span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span> 
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                        <span class="n">n_samples</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
                            <span class="k">yield</span> <span class="p">[</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span> <span class="p">]</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the accelerated_map_f function does not yield a dict nor tuple nor a list&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time taken to unbatch </span><span class="si">{</span><span class="n">timer</span><span class="p">()</span><span class="o">-</span><span class="n">start_unbatch_t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">generator</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_n_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of samples that the DataLoader contains,</span>
<span class="sd">        if the DataLoader does not know how many samples it has, then</span>
<span class="sd">        the DataLoader will first count the samples and then cache it </span>
<span class="sd">        and return the counter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;n_samples&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;this dataset does not have the number of samples in cache so it will take some time to counting&quot;</span><span class="p">)</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span><span class="p">:</span>
                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base class of a data loader that builds higly efficient datasets (<em>tf.data.Dataset</em>)
from full python generators. </p>

<p>The python generator must return a dictionary of samples, and no other format
is currently supported.</p>
</div>


                            <div id="DataLoader.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DataLoader.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">DataLoader</span><span class="signature">(
    source_generator,
    accelerated_map_f=None,
    accelerated_map_batch=128,
    show_progress=False,
    magic_k=10
)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">source_generator</span><span class="p">,</span>
                 <span class="n">accelerated_map_f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">accelerated_map_batch</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
                 <span class="n">show_progress</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">magic_k</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">          source_generator (python generator): Must be a python generator that returns a </span>
<span class="sd">            **dictionary of samples**. Since this generator will be converted into a </span>
<span class="sd">            *tf.data.Dataset*, all the datatypes must be supported in TensorFlow, which is</span>
<span class="sd">            true for all python primitives types.</span>
<span class="sd">          </span>
<span class="sd">          accelerated_map_f (func or `polus.data.IAccelerated_Map`): A function or interface, that</span>
<span class="sd">            describe a transformation to be applied to the samples from the *source_generator*.</span>
<span class="sd">            By default, this function will execute in the best hardware found on the host device,</span>
<span class="sd">            i.e., it should be used for mapping computations that should run on a GPU, e.g., </span>
<span class="sd">            contextualized embeddings from BERT.</span>
<span class="sd">            </span>
<span class="sd">          accelerated_map_batch (int): The size of the batch that is fed to the *accelerated_map_f*</span>
<span class="sd">            recalling that when running on GPU it is more efficient to perform batch-wise operations.</span>
<span class="sd">            </span>
<span class="sd">          show_progress (boolean): If true prints the current batch that was fed to accelerated_map_f.</span>
<span class="sd">          </span>
<span class="sd">          magic_k (int): Integer number that defines how many samples would be executed in order to infer</span>
<span class="sd">            the shape and type of the data.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">          None</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">show_progress</span> <span class="o">=</span> <span class="n">show_progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_batch</span> <span class="o">=</span> <span class="n">accelerated_map_batch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span> <span class="o">=</span> <span class="n">accelerated_map_f</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_sample_generator</span><span class="p">(</span><span class="n">source_generator</span><span class="p">)</span>

        <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="n">magic_k</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_generator</span><span class="p">,</span> 
                                                         <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
                                                         <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>
            
        <span class="c1"># expose all the tf dataset methods</span>
        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">),</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

        </details>

            <div class="docstring"><h6 id="args">Args</h6>

<ul>
<li><strong>source_generator (python generator):</strong>  Must be a python generator that returns a 
<strong>dictionary of samples</strong>. Since this generator will be converted into a 
<em>tf.data.Dataset</em>, all the datatypes must be supported in TensorFlow, which is
true for all python primitives types.</li>
<li><strong>accelerated_map_f (func or <code><a href="#IAccelerated_Map">polus.data.IAccelerated_Map</a></code>):</strong>  A function or interface, that
describe a transformation to be applied to the samples from the <em>source_generator</em>.
By default, this function will execute in the best hardware found on the host device,
i.e., it should be used for mapping computations that should run on a GPU, e.g., 
contextualized embeddings from BERT.</li>
<li><strong>accelerated_map_batch (int):</strong>  The size of the batch that is fed to the <em>accelerated_map_f</em>
recalling that when running on GPU it is more efficient to perform batch-wise operations.</li>
<li><strong>show_progress (boolean):</strong>  If true prints the current batch that was fed to accelerated_map_f.</li>
<li><strong>magic_k (int):</strong>  Integer number that defines how many samples would be executed in order to infer
the shape and type of the data.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>None</p>
</blockquote>
</div>


                            </div>
                            <div id="DataLoader.get_n_samples" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DataLoader.get_n_samples">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_n_samples</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_n_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of samples that the DataLoader contains,</span>
<span class="sd">        if the DataLoader does not know how many samples it has, then</span>
<span class="sd">        the DataLoader will first count the samples and then cache it </span>
<span class="sd">        and return the counter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;n_samples&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;this dataset does not have the number of samples in cache so it will take some time to counting&quot;</span><span class="p">)</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_dataset</span><span class="p">:</span>
                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
            
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span>
</pre></div>

        </details>

            <div class="docstring"><p>Returns the number of samples that the DataLoader contains,
if the DataLoader does not know how many samples it has, then
the DataLoader will first count the samples and then cache it 
and return the counter.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="DataLoader.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="CachedDataLoader">
                                <div class="attr class">
        <a class="headerlink" href="#CachedDataLoader">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">CachedDataLoader</span><wbr>(<span class="base"><a href="#DataLoader">DataLoader</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CachedDataLoader</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extension of a the DataLoader class that adds the ability to seamlessly</span>
<span class="sd">    store the preprocessed samples in the disk, following a chunking mechanism. Besides the </span>
<span class="sd">    organizational advantage, this also enables us to implement a *pre_shuffle* mechanism</span>
<span class="sd">    that occurs at the chunk level, making it a must more efficient process since we can</span>
<span class="sd">    fully shuffle the dataset without the need to have its memory. of a data loader </span>
<span class="sd">    that builds higly efficient datasets (*tf.data.Dataset*) from full python generators. </span>
<span class="sd">    </span>
<span class="sd">    Since this class involves the storage of files on disk, if any exception is raised, the</span>
<span class="sd">    DataLoader will automatically clean all the created files before raising the exception</span>
<span class="sd">    to the user.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">source_generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tf_sample_map_f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># sample mapping function written and executed in tensorflow that is applied before the data is stored in cache</span>
                 <span class="n">py_sample_map_f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># sample mapping function written and executed in python that is applied before the data is stored in cache</span>
                 <span class="n">do_clean_up</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
                 <span class="n">cache_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.polus_cache&quot;</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
                 <span class="n">cache_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">          source_generator (python generator): Same as in `polus.data.DataLoader`</span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># impossible condition</span>
        <span class="k">assert</span> <span class="n">source_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="o">=</span> <span class="n">cache_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="n">cache_chunk_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="n">cache_additional_identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_clean_up</span> <span class="o">=</span> <span class="n">do_clean_up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span> <span class="o">=</span> <span class="n">tf_sample_map_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span> <span class="o">=</span> <span class="n">py_sample_map_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache_index</span>
        
        <span class="c1"># the parent DataLoader will call _build_sample_generator that contains the logic to build the dataloader</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">source_generator</span> <span class="o">=</span> <span class="n">source_generator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># here we dont want to solve the exception, we just want to clean up de previously created files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An error has occured so all the created files will be deleted&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
            
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_cached_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">index_path</span><span class="p">):</span>
        
        <span class="n">index_info</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">index_path</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
        
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
                      <span class="p">}</span>
        
        <span class="c1"># read files</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
            
            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoader</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
                
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
            
            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
            
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
                 
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_index</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">index</span>
    
    <span class="k">def</span> <span class="nf">_build_sample_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_generator</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># we are alredy have the data needed to create the DataLoader</span>
            <span class="c1"># So, let&#39;s build it</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>
                 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">)</span>

        <span class="c1"># get path to cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_cache_base_name</span><span class="p">(</span><span class="n">source_generator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_base_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.index&quot;</span>
        
        <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
             <span class="c1"># build a generator that reads the files from cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataLoader will store the samples in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">, with a max_sample per file of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="si">}</span><span class="s2">, this may take a while&quot;</span><span class="p">)</span>
            <span class="c1"># there are no history of a previous generator so we must generate the samples once and then store in cache</span>
            <span class="c1"># normaly apply the accelerated_map_f to the source_generator</span>
            <span class="n">generator</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_build_sample_generator</span><span class="p">(</span><span class="n">source_generator</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tf_source_generator</span> <span class="o">=</span> <span class="n">generator</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span><span class="p">,</span> <span class="n">IAccelerated_Map</span><span class="p">):</span>
                    <span class="c1"># get the map function and run any heavy init only 1 time!</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
                
                <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
                    
                    <span class="n">dytpes</span><span class="p">,</span> <span class="n">shapes</span> <span class="o">=</span> <span class="n">find_dtype_and_shapes</span><span class="p">(</span><span class="n">tf_source_generator</span><span class="p">())</span>
                    <span class="n">inner_tf_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_generator</span><span class="p">(</span><span class="n">tf_source_generator</span><span class="p">,</span> 
                                                                      <span class="n">output_types</span><span class="o">=</span> <span class="n">dytpes</span><span class="p">,</span>
                                                                      <span class="n">output_shapes</span><span class="o">=</span> <span class="n">shapes</span><span class="p">)</span>\
                                                      <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>\
                                                      <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">inner_tf_dataset</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">data</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                
                <span class="n">py_source_generator</span> <span class="o">=</span> <span class="n">generator</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span><span class="p">,</span> <span class="n">IAccelerated_Map</span><span class="p">):</span>
                    <span class="c1"># get the map function and run any heavy init only 1 time!</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
                
                <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">py_source_generator</span><span class="p">():</span>
                        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;We found a compatible cache file for this DataLoader&quot;</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_cache_generator</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_build_cache_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># first its need to store in cache the samples</span>
        <span class="k">if</span> <span class="n">generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
                          <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="p">,</span>
                          <span class="p">}</span>
            
            <span class="k">def</span> <span class="nf">write_to_file</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
                
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">file_id</span><span class="si">:</span><span class="s2">04</span><span class="si">}</span><span class="s2">.part&quot;</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                    
                <span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            
            <span class="n">_temp_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">_file_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># TODO: Change the tf section here so that all the tf function launched here can be destroyed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting to cache the dataset, this may take a while&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">():</span>
                <span class="n">n_samples</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="n">_temp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_temp_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span><span class="p">:</span>
                    <span class="c1"># save data to file</span>
                    
                    <span class="n">write_to_file</span><span class="p">(</span><span class="n">_file_index</span><span class="p">,</span> <span class="n">_temp_data</span><span class="p">,</span> <span class="n">index_info</span><span class="p">)</span>
                    
                    <span class="c1"># clean up </span>
                    <span class="n">_temp_data</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">_file_index</span><span class="o">+=</span><span class="mi">1</span>
            
            <span class="c1"># TODO: swap to the main tf session and destroy the previous one</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_temp_data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1"># save the reminder data</span>
                <span class="n">write_to_file</span><span class="p">(</span><span class="n">_file_index</span><span class="p">,</span> <span class="n">_temp_data</span><span class="p">,</span> <span class="n">index_info</span><span class="p">)</span>
            
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_samples</span>
            
            <span class="c1"># write the index file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_index_file</span><span class="p">(</span><span class="n">index_info</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_clean_up</span><span class="p">:</span>
            <span class="c1"># TODO: make test to see if this thing works</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The current tf session will be reseted to clear the computation done by the mapping function&quot;</span><span class="p">)</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
        
        <span class="c1"># read the index from file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
        
        <span class="c1"># Build the cache generator</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>

    
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;files&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index_path&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
                 
    <span class="k">def</span> <span class="nf">__build_generator_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># set n_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span>
                 
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of samples in dataset: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">generator</span><span class="p">():</span>
            <span class="n">aux_file_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])))</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">aux_file_index</span><span class="p">)</span>
                
            <span class="k">for</span> <span class="n">file_index</span> <span class="ow">in</span> <span class="n">aux_file_index</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">][</span><span class="n">file_index</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">sample</span>
                 
        <span class="k">return</span> <span class="n">generator</span>
        
    <span class="k">def</span> <span class="nf">__build_cache_base_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_generator</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span><span class="si">}</span><span class="s2">_&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerated_map_f</span><span class="o">.</span><span class="vm">__name__</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span><span class="o">.</span><span class="vm">__name__</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span><span class="o">.</span><span class="vm">__name__</span>
            
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">source_generator</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
    
    
    <span class="k">def</span> <span class="nf">pre_shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The order of the cached files will be readed in a random order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>

        </details>

            <div class="docstring"><p>Extension of a the DataLoader class that adds the ability to seamlessly
store the preprocessed samples in the disk, following a chunking mechanism. Besides the 
organizational advantage, this also enables us to implement a <em>pre_shuffle</em> mechanism
that occurs at the chunk level, making it a must more efficient process since we can
fully shuffle the dataset without the need to have its memory. of a data loader 
that builds higly efficient datasets (<em>tf.data.Dataset</em>) from full python generators. </p>

<p>Since this class involves the storage of files on disk, if any exception is raised, the
DataLoader will automatically clean all the created files before raising the exception
to the user.</p>
</div>


                            <div id="CachedDataLoader.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoader.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">CachedDataLoader</span><span class="signature">(
    source_generator=None,
    tf_sample_map_f=None,
    py_sample_map_f=None,
    do_clean_up=False,
    cache_additional_identifier=&#39;&#39;,
    cache_chunk_size=8192,
    cache_folder=&#39;.polus_cache/data&#39;,
    cache_index=None,
    **kwargs
)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="n">source_generator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">tf_sample_map_f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># sample mapping function written and executed in tensorflow that is applied before the data is stored in cache</span>
                 <span class="n">py_sample_map_f</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># sample mapping function written and executed in python that is applied before the data is stored in cache</span>
                 <span class="n">do_clean_up</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">,</span>
                 <span class="n">cache_folder</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;.polus_cache&quot;</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
                 <span class="n">cache_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">          source_generator (python generator): Same as in `polus.data.DataLoader`</span>
<span class="sd">          </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># impossible condition</span>
        <span class="k">assert</span> <span class="n">source_generator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache_folder</span> <span class="o">=</span> <span class="n">cache_folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_chunk_size</span> <span class="o">=</span> <span class="n">cache_chunk_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_additional_identifier</span> <span class="o">=</span> <span class="n">cache_additional_identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_clean_up</span> <span class="o">=</span> <span class="n">do_clean_up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tf_sample_map_f</span> <span class="o">=</span> <span class="n">tf_sample_map_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__py_sample_map_f</span> <span class="o">=</span> <span class="n">py_sample_map_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="o">=</span> <span class="n">cache_index</span>
        
        <span class="c1"># the parent DataLoader will call _build_sample_generator that contains the logic to build the dataloader</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">source_generator</span> <span class="o">=</span> <span class="n">source_generator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># here we dont want to solve the exception, we just want to clean up de previously created files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;An error has occured so all the created files will be deleted&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span>
</pre></div>

        </details>

            <div class="docstring"><h6 id="args">Args</h6>

<ul>
<li><strong>source_generator (python generator):</strong>  Same as in <code><a href="#DataLoader">polus.data.DataLoader</a></code></li>
</ul>
</div>


                            </div>
                            <div id="CachedDataLoader.from_cached_index" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoader.from_cached_index">#&nbsp;&nbsp</a>

                <div class="decorator">@classmethod</div>

            <span class="def">def</span>
            <span class="name">from_cached_index</span><span class="signature">(cls, index_path)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_cached_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">index_path</span><span class="p">):</span>
        
        <span class="n">index_info</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">index_path</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CachedDataLoader.merge" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoader.merge">#&nbsp;&nbsp</a>

                <div class="decorator">@classmethod</div>

            <span class="def">def</span>
            <span class="name">merge</span><span class="signature">(cls, *cache_dataloaders)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
                      <span class="p">}</span>
        
        <span class="c1"># read files</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
            
            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoader</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
                
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
            
            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
            
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CachedDataLoader.read_index" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoader.read_index">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">read_index</span><span class="signature">(file_path)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_index</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">index</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CachedDataLoader.write_index_file" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoader.write_index_file">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">write_index_file</span><span class="signature">(self, index_info)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CachedDataLoader.clean" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoader.clean">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">clean</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;files&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index_path&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CachedDataLoader.pre_shuffle" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoader.pre_shuffle">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">pre_shuffle</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">pre_shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The order of the cached files will be readed in a random order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_blocks</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>

        </details>

            <div class="docstring"><p>The order of the cached files will be readed in a random order</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#DataLoader">DataLoader</a></dt>
                                <dd id="CachedDataLoader.get_n_samples" class="function"><a href="#DataLoader.get_n_samples">get_n_samples</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="CachedDataLoader.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="CachedDataLoaderwLookup">
                                <div class="attr class">
        <a class="headerlink" href="#CachedDataLoaderwLookup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">CachedDataLoaderwLookup</span><wbr>(<span class="base"><a href="#CachedDataLoader">CachedDataLoader</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">CachedDataLoader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correspond to a CachedDataLoader but also keeps track of an aditional lookup file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="n">lookup_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cache_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">):</span>
        
        <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="n">cache_index</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lookup_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">lookup_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Do not use CachedDataLoaderwLookup without setting a lookup_data, instead use CachedDataLoader&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">lookup_data</span>
        
        <span class="c1"># the parent DataLoader will call _build_sample_generator that contains the logic to build the dataloader</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cache_index</span><span class="o">=</span><span class="n">cache_index</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span>
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load_lookup_data</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
                      <span class="p">}</span>
        
        <span class="n">lookup_data</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># read files</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
            
            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
                
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
            
            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
            
            <span class="n">lookup_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]))</span>
            
        <span class="k">return</span> <span class="n">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">,</span> <span class="n">lookup_data</span><span class="o">=</span><span class="n">lookup_data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
        
        <span class="c1">## add lookup_data to the index</span>
        <span class="n">lookup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.lookup&quot;</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        
        <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_file</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">__build_generator_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__build_generator_from_index</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Correspond to a CachedDataLoader but also keeps track of an aditional lookup file</p>
</div>


                            <div id="CachedDataLoaderwLookup.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoaderwLookup.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">CachedDataLoaderwLookup</span><span class="signature">(*args, lookup_data=None, cache_index=None, **kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                 <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                 <span class="n">lookup_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cache_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># this variable is used to init a CacheDataLoader with an already cached index usefull in merge</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">):</span>
        
        <span class="k">if</span> <span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="n">cache_index</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lookup_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">lookup_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Do not use CachedDataLoaderwLookup without setting a lookup_data, instead use CachedDataLoader&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span> <span class="o">=</span> <span class="n">lookup_data</span>
        
        <span class="c1"># the parent DataLoader will call _build_sample_generator that contains the logic to build the dataloader</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">cache_index</span><span class="o">=</span><span class="n">cache_index</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><h6 id="args">Args</h6>

<ul>
<li><strong>source_generator (python generator):</strong>  Same as in <code><a href="#DataLoader">polus.data.DataLoader</a></code></li>
</ul>
</div>


                            </div>
                            <div id="CachedDataLoaderwLookup.get_lookup_data" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoaderwLookup.get_lookup_data">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_lookup_data</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_lookup_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CachedDataLoaderwLookup.merge" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoaderwLookup.merge">#&nbsp;&nbsp</a>

                <div class="decorator">@classmethod</div>

            <span class="def">def</span>
            <span class="name">merge</span><span class="signature">(cls, *cache_dataloaders)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">cache_dataloaders</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cache_dataloaders</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">index_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;files&quot;</span><span class="p">:[],</span>
                      <span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="s2">&quot;n_samples&quot;</span><span class="p">:</span> <span class="mi">0</span>
                      <span class="p">}</span>
        
        <span class="n">lookup_data</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># read files</span>
        <span class="k">for</span> <span class="n">dl</span> <span class="ow">in</span> <span class="n">cache_dataloaders</span><span class="p">:</span>
            
            <span class="n">index</span> <span class="o">=</span> <span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">dl</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">)</span>
                
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;n_samples&quot;</span><span class="p">]</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">])</span>
            
            <span class="c1"># this is a bit starange, but it is possible to have different DL with diff chunk size so we will pick the larger one to define the conjunt</span>
            <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;cache_chunk_size&quot;</span><span class="p">])</span>
            
            <span class="n">lookup_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">CachedDataLoaderwLookup</span><span class="o">.</span><span class="n">_load_lookup_data</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]))</span>
            
        <span class="k">return</span> <span class="n">CachedDataLoaderwLookup</span><span class="p">(</span><span class="n">cache_index</span><span class="o">=</span><span class="n">index_info</span><span class="p">,</span> <span class="n">lookup_data</span><span class="o">=</span><span class="n">lookup_data</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CachedDataLoaderwLookup.clean" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoaderwLookup.clean">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">clean</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;cache_index&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;lookup_file&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">])</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="CachedDataLoaderwLookup.write_index_file" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#CachedDataLoaderwLookup.write_index_file">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">write_index_file</span><span class="signature">(self, index_info)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">write_index_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_info</span><span class="p">):</span>
        
        <span class="c1">## add lookup_data to the index</span>
        <span class="n">lookup_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_base_path</span><span class="si">}</span><span class="s2">.lookup&quot;</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lookup_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        
        <span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;lookup_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lookup_file</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_index_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">index_info</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#CachedDataLoader">CachedDataLoader</a></dt>
                                <dd id="CachedDataLoaderwLookup.from_cached_index" class="function"><a href="#CachedDataLoader.from_cached_index">from_cached_index</a></dd>
                <dd id="CachedDataLoaderwLookup.read_index" class="function"><a href="#CachedDataLoader.read_index">read_index</a></dd>
                <dd id="CachedDataLoaderwLookup.pre_shuffle" class="function"><a href="#CachedDataLoader.pre_shuffle">pre_shuffle</a></dd>

            </div>
            <div><dt><a href="#DataLoader">DataLoader</a></dt>
                                <dd id="CachedDataLoaderwLookup.get_n_samples" class="function"><a href="#DataLoader.get_n_samples">get_n_samples</a></dd>

            </div>
            <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="CachedDataLoaderwLookup.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="IAccelerated_Map">
                                <div class="attr class">
        <a class="headerlink" href="#IAccelerated_Map">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">IAccelerated_Map</span><wbr>(<span class="base"><a href="core.html#BaseLogger">polus.core.BaseLogger</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">IAccelerated_Map</span><span class="p">(</span><span class="n">BaseLogger</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;IAccelerated_Map&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;build method was not implemented&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            <div id="IAccelerated_Map.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#IAccelerated_Map.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">IAccelerated_Map</span><span class="signature">()</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;IAccelerated_Map&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This is an interface that cannot be instantiated&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base logging class, this sets a console and file log handler to each
instance. Meaning that each call to the logger will write to both 
handlers. </p>

<p>Furthermore, the intended behaviour is to classes to extend this BaseLogger
classe and by doing this, any class can access to the logger property
Note that multiple instances use the same handler</p>

<p>Main ideas from: https://www.toptal.com/python/in-depth-python-logging</p>
</div>


                            </div>
                            <div id="IAccelerated_Map.build" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#IAccelerated_Map.build">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">build</span><span class="signature">(self)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;build method was not implemented&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="core.html#BaseLogger">polus.core.BaseLogger</a></dt>
                                <dd id="IAccelerated_Map.set_logging_level" class="function"><a href="core.html#BaseLogger.set_logging_level">set_logging_level</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="access_embeddings">
                            <div class="attr function"><a class="headerlink" href="#access_embeddings">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">access_embeddings</span><span class="signature">(func)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">access_embeddings</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple decorator function to access the embeddings property if present in the data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">function_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;embeddings&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;embeddings&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
        
    <span class="k">return</span> <span class="n">function_wrapper</span>
</pre></div>

        </details>

            <div class="docstring"><p>A simple decorator function to access the embeddings property if present in the data</p>
</div>


                </section>
                <section id="build_bert_embeddings">
                            <div class="attr function"><a class="headerlink" href="#build_bert_embeddings">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">build_bert_embeddings</span><span class="signature">(*args, **kwargs)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">function_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;embeddings&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;embeddings&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

        </details>

    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>